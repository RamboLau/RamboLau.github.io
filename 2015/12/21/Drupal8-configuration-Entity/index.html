<html>
<head><meta name="generator" content="Hexo 3.9.0">
	
	<title>Drupal8 Configuration Entity</title>
	<meta name="keywords" content="verynull.com,Drupal,php,python,ios,macos,linux,unix,vim,刘盘军,刘盘军的blog">

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css">
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3">
    

</head>

<body>


<h2 class="title">Drupal8 Configuration Entity</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2015年12月21日


    <a class="article-category-link" href="/categories/Drupal8/">Drupal8</a>



 </div>
--->
</div>


<p>Drupal8的实体由2部分组成，配置实体(configuration entities)和内容实体(content entities)。如图：<br><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222113456_92999.png" alt="Entity"></p>
<p>本节源代码见 <a href="https://github.com/RamboLau/drupal8-demos/tree/master/config_entities_example" target="_blank" rel="external">https://github.com/RamboLau/drupal8-demos/tree/master/config_entities_example</a></p>
<p>内容实体见：<a href="http://verynull.com/2015/12/22/drupal8-content-entity/">http://verynull.com/2015/12/22/drupal8-content-entity/</a></p>
<p>###一、配置实体接口(configuration entity interface)</p>
<p>在src目录下touch DemoInterface.php，DemoInterface继承并实现<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Config%21Entity%21ConfigEntityInterface.php/interface/ConfigEntityInterface/8" target="_blank" rel="external">ConfigEntityInterface</a>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * Contains \Drupal\demo\DemoInterface.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">demo</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Config</span>\<span class="title">Entity</span>\<span class="title">ConfigEntityInterface</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides an interface defining a demo entity type.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DemoInterface</span> <span class="keyword">extends</span> <span class="title">ConfigEntityInterface</span> </span>&#123;</div><div class="line">  <span class="comment">// Add get/set methods for your configuration properties here.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>###二、配置实体类(configuration entity class)<br>在src目录下创建Entity目录，并touch src/Entity/Demo.php，在这个文件中我们将实现DemoEntity。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * Contains \Drupal\demo\Entity\Demo.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">demo</span>\<span class="title">Entity</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Config</span>\<span class="title">Entity</span>\<span class="title">ConfigEntityBase</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">demo</span>\<span class="title">DemoInterface</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Defines the Demo entity.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@ConfigEntityType</span>(</div><div class="line"> *   id = "demo",</div><div class="line"> *   label = <span class="doctag">@Translation</span>("Demo"),</div><div class="line"> *   fieldable = FALSE,</div><div class="line"> *   handlers = &#123;</div><div class="line"> *     "list_builder" = "Drupal\demo\DemoListBuilder",</div><div class="line"> *     "form" = &#123;</div><div class="line"> *       "add" = "Drupal\demo\Form\DemoForm",</div><div class="line"> *       "edit" = "Drupal\demo\Form\DemoForm",</div><div class="line"> *       "delete" = "Drupal\demo\Form\DemoDeleteForm"</div><div class="line"> *     &#125;</div><div class="line"> *   &#125;,</div><div class="line"> *   config_prefix = "demo",</div><div class="line"> *   admin_permission = "administer site configuration",</div><div class="line"> *   entity_keys = &#123;</div><div class="line"> *     "id" = "id",</div><div class="line"> *     "label" = "name"</div><div class="line"> *   &#125;,</div><div class="line"> *   links = &#123;</div><div class="line"> *     "edit-form" = "/admin/structure/demos/&#123;demo&#125;",</div><div class="line"> *     "delete-form" = "/admin/structure/demos/&#123;demo&#125;/delete"</div><div class="line"> *   &#125;</div><div class="line"> * )</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">extends</span> <span class="title">ConfigEntityBase</span> <span class="keyword">implements</span> <span class="title">DemoInterface</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * The ID of the demo.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@var</span> string</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> $id;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * The demo name.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@var</span> string</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> $name;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * The demo sex.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@var</span> string</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> $sex;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>上面定义Entity的方式熟悉吧！对，就是注解annotation。</p>
<p>@ConfigEntityType告诉Drupal这是一个配置实体。参数如下：<br>1、lable：翻译系统的标签<br>2、fieldable: 附加字段，配置实体一般为FALSE，内容实体一般为TRUE<br>3、handlers：管理该实体所需要的类<br>4、list_builder：提供该实体的管理界面接口<br>5、config_prefix：配置的前缀，一般用于schema<br>6、admin_permission：管理员权限<br>7、entity_keys：主要实体属性的集合<br>8、links：编辑和删除的路径，在demo.routing.yml中定义</p>
<p>###三、实体表单(entity form)</p>
<p>接下来我们来实现在Entity中的定义的表单，如add, edit, delete。</p>
<p>####1、mkdir -p src/Form，并touch src/Form/DemoForm.php。<br>在DemoForm主要实现2个方法，form()和save()。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * Contains \Drupal\demo\Form\DemoForm.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">demo</span>\<span class="title">Form</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityForm</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityTypeInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">Query</span>\<span class="title">QueryFactory</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormStateInterface</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Class DemoForm</div><div class="line"> *</div><div class="line"> * Form class for adding/editing demo config entities.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoForm</span> <span class="keyword">extends</span> <span class="title">EntityForm</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * <span class="doctag">@param</span> \Drupal\Core\Entity\Query\QueryFactory $entity_query</div><div class="line">   *   The entity query.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(QueryFactory $entity_query)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;entityQuery = $entity_query;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(ContainerInterface $container)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>(</div><div class="line">      $container-&gt;get(<span class="string">'entity.query'</span>)</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">form</span><span class="params">(array $form, FormStateInterface $form_state)</span> </span>&#123;</div><div class="line">    $form = <span class="keyword">parent</span>::form($form, $form_state);</div><div class="line">    $demo = <span class="keyword">$this</span>-&gt;entity;</div><div class="line"></div><div class="line">    <span class="comment">// Change page title for the edit operation</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;operation == <span class="string">'edit'</span>) &#123;</div><div class="line">      $form[<span class="string">'#title'</span>] = <span class="keyword">$this</span>-&gt;t(<span class="string">'Edit demo: @name'</span>, <span class="keyword">array</span>(<span class="string">'@name'</span> =&gt; $demo-&gt;name));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The demo name.</span></div><div class="line">    $form[<span class="string">'name'</span>] = <span class="keyword">array</span>(</div><div class="line">      <span class="string">'#type'</span> =&gt; <span class="string">'textfield'</span>,</div><div class="line">      <span class="string">'#title'</span> =&gt; <span class="keyword">$this</span>-&gt;t(<span class="string">'Name'</span>),</div><div class="line">      <span class="string">'#maxlength'</span> =&gt; <span class="number">255</span>,</div><div class="line">      <span class="string">'#default_value'</span> =&gt; $demo-&gt;name,</div><div class="line">      <span class="string">'#description'</span> =&gt; <span class="keyword">$this</span>-&gt;t(<span class="string">"demo name."</span>),</div><div class="line">      <span class="string">'#required'</span> =&gt; <span class="keyword">TRUE</span>,</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="comment">// The unique machine name of the demo.</span></div><div class="line">    $form[<span class="string">'id'</span>] = <span class="keyword">array</span>(</div><div class="line">      <span class="string">'#type'</span> =&gt; <span class="string">'machine_name'</span>,</div><div class="line">      <span class="string">'#maxlength'</span> =&gt; EntityTypeInterface::BUNDLE_MAX_LENGTH,</div><div class="line">      <span class="string">'#default_value'</span> =&gt; $demo-&gt;id,</div><div class="line">      <span class="string">'#disabled'</span> =&gt; !$demo-&gt;isNew(),</div><div class="line">      <span class="string">'#machine_name'</span> =&gt; <span class="keyword">array</span>(</div><div class="line">        <span class="string">'source'</span> =&gt; <span class="keyword">array</span>(<span class="string">'name'</span>),</div><div class="line">        <span class="string">'exists'</span> =&gt; <span class="string">'demo_load'</span></div><div class="line">      ),</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="comment">// The sex.</span></div><div class="line">    $form[<span class="string">'sex'</span>] = <span class="keyword">array</span>(</div><div class="line">      <span class="string">'#type'</span> =&gt; <span class="string">'select'</span>,</div><div class="line">      <span class="string">'#options'</span> =&gt; <span class="keyword">array</span>(</div><div class="line">        <span class="string">'Man'</span> =&gt; <span class="string">'Man'</span>,</div><div class="line">        <span class="string">'Woman'</span> =&gt; <span class="string">'Woman'</span>,</div><div class="line">      ),</div><div class="line">      <span class="string">'#title'</span> =&gt; <span class="keyword">$this</span>-&gt;t(<span class="string">'Sex'</span>),</div><div class="line">      <span class="string">'#maxlength'</span> =&gt; <span class="number">255</span>,</div><div class="line">      <span class="string">'#default_value'</span> =&gt; $demo-&gt;sex,</div><div class="line">      <span class="string">'#description'</span> =&gt; <span class="keyword">$this</span>-&gt;t(<span class="string">"sex"</span>),</div><div class="line">      <span class="string">'#required'</span> =&gt; <span class="keyword">TRUE</span>,</div><div class="line">    );</div><div class="line">    <span class="keyword">return</span> $form;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $form, FormStateInterface $form_state)</span> </span>&#123;</div><div class="line">    $demo = <span class="keyword">$this</span>-&gt;entity;</div><div class="line">    $status = $demo-&gt;save();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($status) &#123;</div><div class="line">      <span class="comment">// Setting the success message.</span></div><div class="line">      drupal_set_message(<span class="keyword">$this</span>-&gt;t(<span class="string">'Saved the demo: @label.'</span>, <span class="keyword">array</span>(</div><div class="line">        <span class="string">'@label'</span> =&gt; $demo-&gt;name,</div><div class="line">      )));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">      drupal_set_message(<span class="keyword">$this</span>-&gt;t(<span class="string">'The @label demo was not saved.'</span>, <span class="keyword">array</span>(</div><div class="line">        <span class="string">'@label'</span> =&gt; $demo-&gt;name,</div><div class="line">      )));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $form_state-&gt;setRedirect(<span class="string">'demo.list'</span>);</div><div class="line">  &#125;</div><div class="line">&#125; </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如图：</p>
<p><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212259_77460.png" alt="DemoForm"></p>
<p>####2、touch src/Form/DemoFormDelete.php。</p>
<p>DemoFormDelete继承<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21EntityConfirmFormBase.php/class/EntityConfirmFormBase/8" target="_blank" rel="external">EntityConfirmFormBase</a>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * Contains \Drupal\demo\Form\DemoDeleteForm.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">demo</span>\<span class="title">Form</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityConfirmFormBase</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Url</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormStateInterface</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Form that handles the removal of demo entities.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoDeleteForm</span> <span class="keyword">extends</span> <span class="title">EntityConfirmFormBase</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getQuestion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;t(<span class="string">'Are you sure you want to delete this demo: @name?'</span>, <span class="keyword">array</span>(<span class="string">'@name'</span> =&gt; <span class="keyword">$this</span>-&gt;entity-&gt;name));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCancelUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Url(<span class="string">'demo.list'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getConfirmText</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;t(<span class="string">'Delete'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">submitForm</span><span class="params">(array &amp;$form, FormStateInterface $form_state)</span> </span>&#123;</div><div class="line">    <span class="comment">// Delete and set message</span></div><div class="line">    <span class="keyword">$this</span>-&gt;entity-&gt;delete();</div><div class="line">    drupal_set_message(<span class="keyword">$this</span>-&gt;t(<span class="string">'The demo @name has been deleted.'</span>, <span class="keyword">array</span>(<span class="string">'@name'</span> =&gt; <span class="keyword">$this</span>-&gt;entity-&gt;name)));</div><div class="line"></div><div class="line">    $form_state-&gt;setRedirectUrl(<span class="keyword">$this</span>-&gt;getCancelUrl());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如图：<br><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212429_43428.png" alt="FormDelete"></p>
<p>###四、list builder</p>
<p>接下来就该创建管理界面啦！</p>
<p>在src目录下，touch DemoListBuilder.php</p>
<p>DemoListBuilder继承<a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Config!Entity!ConfigEntityListBuilder.php/class/ConfigEntityListBuilder/8" target="_blank" rel="external">ConfigEntityListBuilder</a>，实现了三个方法。</p>
<p>1、buildHeader：创建表格header<br>2、buildRow：创建表格行<br>3、render：重写表格输出的内容，类似于Drupal7的hook</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> *</div><div class="line"> * Contains Drupal\demo\DemoListBuilder</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">demo</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Config</span>\<span class="title">Entity</span>\<span class="title">ConfigEntityListBuilder</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityInterface</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoListBuilder</span> <span class="keyword">extends</span> <span class="title">ConfigEntityListBuilder</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildHeader</span><span class="params">()</span> </span>&#123;</div><div class="line">    $header[<span class="string">'label'</span>] = <span class="keyword">$this</span>-&gt;t(<span class="string">'Name'</span>);</div><div class="line">    $header[<span class="string">'sex'</span>] = <span class="keyword">$this</span>-&gt;t(<span class="string">'Sex'</span>);</div><div class="line">    <span class="keyword">return</span> $header + <span class="keyword">parent</span>::buildHeader();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildRow</span><span class="params">(EntityInterface $entity)</span> </span>&#123;</div><div class="line">    <span class="comment">// Label</span></div><div class="line">    $row[<span class="string">'label'</span>] = <span class="keyword">$this</span>-&gt;getLabel($entity);</div><div class="line">    <span class="comment">// Sex</span></div><div class="line">    $row[<span class="string">'sex'</span>] = $entity-&gt;sex;</div><div class="line">    <span class="keyword">return</span> $row + <span class="keyword">parent</span>::buildRow($entity);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</div><div class="line">    $build = <span class="keyword">parent</span>::render();</div><div class="line">    $build[<span class="string">'#empty'</span>] = <span class="keyword">$this</span>-&gt;t(<span class="string">'There are no data available.'</span>);</div><div class="line">    <span class="keyword">return</span> $build;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如图：<br><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212547_35896.png" alt="ListBuilder"></p>
<p>###五、schema</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir config/schema</div><div class="line">touch demo.schema.yml</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Schema for the configuration files of the Demo module.</span></div><div class="line"></div><div class="line">demo.demo.*:</div><div class="line">  type: mapping</div><div class="line">  label: <span class="string">'Demo'</span></div><div class="line">  mapping:</div><div class="line">    id:</div><div class="line">      type: string</div><div class="line">      label: <span class="string">'Demo identifier'</span></div><div class="line">    uuid:</div><div class="line">      type: string</div><div class="line">      label: <span class="string">'UUID'</span></div><div class="line">    name:</div><div class="line">      type: label</div><div class="line">      label: <span class="string">'Name'</span></div><div class="line">    sex:</div><div class="line">      type: string</div><div class="line">      label: <span class="string">'Sex'</span></div><div class="line">      translatable: <span class="keyword">true</span></div></pre></td></tr></table></figure>
<p>schema的命名规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(demo module).(demo configuration entity <span class="built_in">type</span>).(all demo configuration entities).</div></pre></td></tr></table></figure>
<p>uuid在这里也可以不用定义，drupal默认会添加。</p>
<p>###六、routing</p>
<p>定义一些路由：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">demo.list:</div><div class="line">  path: <span class="string">'/admin/structure/demos'</span></div><div class="line">  defaults:</div><div class="line">    _entity_list: <span class="string">'demo'</span></div><div class="line">    _title: <span class="string">'Demos'</span></div><div class="line">  requirements:</div><div class="line">    _permission: <span class="string">'administer site configuration'</span></div><div class="line">demo.add:</div><div class="line">  path: <span class="string">'/admin/structure/demos/add'</span></div><div class="line">  defaults:</div><div class="line">    _entity_form: <span class="string">'demo.add'</span></div><div class="line">    _title: <span class="string">'Add a new demo'</span></div><div class="line">  requirements:</div><div class="line">    _permission: <span class="string">'administer site configuration'</span></div><div class="line">entity.demo.edit_form:</div><div class="line">  path: <span class="string">'/admin/structure/demos/&#123;demo&#125;'</span></div><div class="line">  defaults:</div><div class="line">    _entity_form: <span class="string">'demo.edit'</span></div><div class="line">    _title: <span class="string">'Edit demo'</span></div><div class="line">  requirements:</div><div class="line">    _permission: <span class="string">'administer site configuration'</span></div><div class="line">entity.demo.delete_form:</div><div class="line">  path: <span class="string">'/admin/structure/demos/&#123;demo&#125;/delete'</span></div><div class="line">  defaults:</div><div class="line">    _entity_form: <span class="string">'demo.delete'</span></div><div class="line">    _title: <span class="string">'Delete demo'</span></div><div class="line">  requirements:</div><div class="line">    _permission: <span class="string">'administer site configuration'</span></div></pre></td></tr></table></figure>
<p>###七、 links</p>
<p>####1、显示添加按钮在网页上，需要在demo.links.action.yml中定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">demo.add:</div><div class="line">  route_name: <span class="string">'demo.add'</span></div><div class="line">  title: <span class="string">'Add demo'</span></div><div class="line">  appears_on:</div><div class="line">    - demo.list</div></pre></td></tr></table></figure>
<p><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212157_21914.png" alt="demo.add"></p>
<p>####2、在admin/structure页面显示demo，需要在demo.links.menu.yml中定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">demo.list:</div><div class="line">  title: Demo</div><div class="line">  description: <span class="string">'Administrator the demo entities'</span></div><div class="line">  parent: system.admin_structure</div><div class="line">  route_name: demo.list</div></pre></td></tr></table></figure>
<p>如图：<br><img src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212041_77165.png" alt="demo.list"></p>
<p>参考文章：<br>1、<a href="http://www.slideshare.net/andypost/d8-entity" target="_blank" rel="external">http://www.slideshare.net/andypost/d8-entity</a><br>2、<a href="http://www.sitepoint.com/drupal-8-version-entityfieldquery/" target="_blank" rel="external">http://www.sitepoint.com/drupal-8-version-entityfieldquery/</a><br>3、<a href="https://www.drupal.org/node/1809494" target="_blank" rel="external">https://www.drupal.org/node/1809494</a></p>


<!--<a href="http://verynull.com/2015/12/21/Drupal8-configuration-Entity/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'undefined'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=undefined&web_id=undefined" language="JavaScript"></script>script>
</div>






</body>
</html>