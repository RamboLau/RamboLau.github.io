<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.useso.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Drupal linux unix vim" />





  <link rel="alternate" href="/atom.xml" title="Rambo's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="记录生活，分享知识，传播乐趣">
<meta property="og:type" content="website">
<meta property="og:title" content="Rambo's Blog">
<meta property="og:url" content="http://verynull.com/page/6/index.html">
<meta property="og:site_name" content="Rambo's Blog">
<meta property="og:description" content="记录生活，分享知识，传播乐趣">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rambo's Blog">
<meta name="twitter:description" content="记录生活，分享知识，传播乐趣">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Rambo's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Rambo's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">记录生活，分享知识，传播乐趣</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/11/Drupal8命名空间-Namespace/" itemprop="url">
                  Drupal8命名空间(Namespace)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-11T16:05:20+08:00" content="2015-12-11">
              2015-12-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/11/Drupal8命名空间-Namespace/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/11/Drupal8命名空间-Namespace/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>命名空间是php5.3引进的概念，这边文章主要介绍在Drupal中如何使用命名空间，如果你对命名空间还不熟悉，请移步到<a href="http://php.net/manual/zh/language.namespaces.php" title="PHP:命名空间" target="_blank" rel="external">这里</a>学习，这篇文章<a href="http://www.sitepoint.com/php-53-namespaces-basics/" title="php53:namespace" target="_blank" rel="external">article introducing namespaces</a>也讲的不错。</p>
<p>在Drupal中，并不是每一个文件都需要指定命名空间。Drupal8之前为了跟php5.2保持兼容，从未用过命名空间。Drupal8限定了php版本必须是5.5以上，So，让我们尽情的享受OOP的乐趣吧！</p>
<p>###用”use”导入类</p>
<blockquote>
<p>在访问系统内部或包含在命名空间中的类名称时，可以不使用完全限定名称。命名空间和use关键字的声明必须放在文件的开头，并且以反斜杠\做为分隔符。如</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">mymodule</span>\<span class="title">Tests</span>\<span class="title">Foo</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">simpletest</span>\<span class="title">WebTestBase</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Tests that the foo bars.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BarTest</span> <span class="keyword">extends</span> <span class="title">WebTestBase</span> </span>&#123;</div><div class="line">	<span class="comment">// WebTestBase前不需要加\</span></div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>在访问系统内部或不包含在命名空间中的类名称时，必须使用完全限定名称。如</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> \<span class="keyword">Exception</span>();</div></pre></td></tr></table></figure>
<blockquote>
<p>在一个没有声明命名空间的文件里，就算它是全局命名空间，如果要使用其他非全局命名空间的类，必须使用”use”关键字，并且需要声明在文件的开头哦！</p>
<p>当用”use”导入类时，不要在开头加\。大PHP官方也是这么推荐的，见<a href="http://www.php.net/manual/en/language.namespaces.importing.php" target="_blank" rel="external">PHP documentation</a></p>
<p>当在字符串中指定类名时，必须使用带命名空间的全类名，并且不能以\开头。</p>
</blockquote>
<pre><code>如果要在双引号中使用命名空间，必须转义，如：
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"Drupal\\Content\\ContentInterface"</span></div></pre></td></tr></table></figure>
<pre><code>在单引号中就不需要转义了，如：
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'Drupal\Context\ContextInterface'</span></div></pre></td></tr></table></figure>
<pre><code>通常情况下，推荐使用单引号的写法！
</code></pre><blockquote>
<p>一个”use”只能声明一个类，不建议使用”use”导入多个类.如这种写法就是不推荐的</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span>, <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</div></pre></td></tr></table></figure>
<pre><code>而这种写法是推荐的
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>在.api.php这种API文件中必须使用类的全名，这样别人要想hook你的类，他们就可以”use”导入了。如</p>
</blockquote>
<p>定义Drupal\Subsystem\Foo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * Contains \Drupal\Subsystem\Foo.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">Subsystem</span>;</div><div class="line"></div><div class="line"><span class="comment">// This imports just the Cat class from the Drupal\Othersystem namespace.</span></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Othersystem</span>\<span class="title">Cat</span>;</div><div class="line"></div><div class="line"><span class="comment">// Bar is a class in the Drupal\Subsystem namespace in another file.</span></div><div class="line"><span class="comment">// It is already available without any importing.</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Defines a Foo.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Constructs a new Foo object.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bar $b, Cat $c)</span> </span>&#123;</div><div class="line">    <span class="comment">// Global classes must be prefixed with a \ character.</span></div><div class="line">    $d = <span class="keyword">new</span> \DateTime();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>hook Drupal\Subsystem\Foo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@file</span></div><div class="line"> * The Example module.</div><div class="line"> *</div><div class="line"> * This file is not part of any namespace, so all global namespaced classes</div><div class="line"> *  are automatically available.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Subsystem</span>\<span class="title">Foo</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Does stuff with Foo stuff.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> \Drupal\Subsystem\Foo $f</div><div class="line"> *   A Foo object used to bar the baz.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_stuff</span><span class="params">(Foo $f)</span> </span>&#123;</div><div class="line">  <span class="comment">// The DateTime class does not need to be imported as it is already global</span></div><div class="line">  $d = <span class="keyword">new</span> DateTime();</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>###类的别名</p>
<p>php允许导入类的时候使用别名，这样可以避免可恶的重名！一旦两个类重名了，可以将各自命名空间里的上一级的名字拿出来作为相应的前缀。</p>
<p>如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">use</span> <span class="title">Foo</span>\<span class="title">Bar</span>\<span class="title">Baz</span> <span class="title">as</span> <span class="title">BarBaz</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Stuff</span>\<span class="title">Thing</span>\<span class="title">Baz</span> <span class="title">as</span> <span class="title">ThingBaz</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Tests stuff for the whichever.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">  $a = <span class="keyword">new</span> BarBaz(); <span class="comment">// This will be Foo\Bar\Baz</span></div><div class="line">  $b = <span class="keyword">new</span> ThingBaz(); <span class="comment">// This will be Stuff\Thing\Baz</span></div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>###导入的顺序</p>
<p>如果要导入多个类，Drupal8并没有限制导入的顺序。如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">block</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityForm</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityManagerInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormState</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormStateInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>###模块</p>
<p>模块中的类必须申明为特定的命名空间，如模块名为example_module。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span></div></pre></td></tr></table></figure>
<p>要在Drupal8中自动加载(autoload)，还要这些类归置到指定的文件夹下，一般约定在</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">modules/example_module/src</div></pre></td></tr></table></figure>
<p>举个简单的例子，如：</p>
<blockquote>
<p>NO.1</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 声明命名空间</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span></div><div class="line"></div><div class="line">// 创建类</div><div class="line"><span class="title">class</span> <span class="title">Foo</span> &#123;&#125;</div></pre></td></tr></table></figure>
<p>这个对应的文件就是example_module/src/Foo.php。</p>
<blockquote>
<p>NO.2<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 声明命名空间</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span>\<span class="title">Foo</span></div><div class="line"></div><div class="line">// 创建类</div><div class="line"><span class="title">class</span> <span class="title">Bar</span> &#123;&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>这个对应的文件就是example_module/src/Foo/Bar.php。</p>
<p>以上，就是对Drupal8的命名空间做简单的梳理和介绍。欢迎拍砖交流！</p>
<p>参考文章：<br>1、<a href="https://www.drupal.org/node/1353118" target="_blank" rel="external">https://www.drupal.org/node/1353118</a><br>2、<a href="https://www.drupal.org/node/2156625" target="_blank" rel="external">https://www.drupal.org/node/2156625</a></p>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="url">
                  高性能mysql主从架构及MHA高可用负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-28T14:35:42+08:00" content="2015-11-28">
              2015-11-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>实验系统：CentOS 6.7_x86_64（4.2.3）</p>
<p>实验前提：防火墙和selinux都关闭</p>
<p>实验说明：本实验共有3台主机，拓扑图如下所示</p>
<p><img src="http://images.cnitblog.com/i/609710/201404/192216579327066.png" alt="拓扑图"></p>
<p>主机说明：<br>manager: 172.16.2.99<br>master: 172.16.115.101<br>备用master: 172.16.115.102<br>也可以加别的slave。</p>
<p>实验软件：</p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>mysql(mysql-5.5.46-1.el6.remi.x86_64)</p>
<p>###1、安装软件<br>三台机器都需要安装mha4mysql-node, master和slave还需要安装mysql, manager可以不装mysql. 当然manager也可以用slave机器来做。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install mysql mysql-server epel-release -y</div><div class="line"></div><div class="line">rpm -Uvh mha4mysql-node-0.56-0.el6.noarch.rpm</div></pre></td></tr></table></figure>
<p>manager还需要安装mha4mysql-manager.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm -y</div></pre></td></tr></table></figure>
<p>用localinstall会自动安装依赖。</p>
<p>###2、mysql主从配置</p>
<h4 id="master上编辑-etc-my-cnf，添加配置"><a href="#master上编辑-etc-my-cnf，添加配置" class="headerlink" title="master上编辑/etc/my.cnf，添加配置"></a>master上编辑/etc/my.cnf，添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># master config</span></div><div class="line">server-id = 1</div><div class="line">log_bin = mysql-bin</div><div class="line"><span class="built_in">log</span>-slave-updates</div><div class="line">binlog_do_db = drupal</div></pre></td></tr></table></figure>
<h4 id="slave上编辑-etc-my-cnf-添加配置"><a href="#slave上编辑-etc-my-cnf-添加配置" class="headerlink" title="slave上编辑/etc/my.cnf,添加配置"></a>slave上编辑/etc/my.cnf,添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># slave config</span></div><div class="line">server-id = 2</div><div class="line">log_bin = mysql-bin</div><div class="line"><span class="built_in">log</span>-slave-updates</div><div class="line">binlog_do_db = drupal</div></pre></td></tr></table></figure>
<h4 id="创建具有复制权限的用户"><a href="#创建具有复制权限的用户" class="headerlink" title="创建具有复制权限的用户"></a>创建具有复制权限的用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">'replicate'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span>;</div><div class="line"></div><div class="line">FLUSH PRIVILEGES;</div></pre></td></tr></table></figure>
<h4 id="设置slave"><a href="#设置slave" class="headerlink" title="设置slave"></a>设置slave</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -p123456</div><div class="line"></div><div class="line">mysql&gt; change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=3306,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_log_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=0;</div><div class="line"></div><div class="line">mysql&gt; start slave;</div></pre></td></tr></table></figure>
<h4 id="查看master-slave配置"><a href="#查看master-slave配置" class="headerlink" title="查看master/slave配置"></a>查看master/slave配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status;</div><div class="line"></div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000001 |      867 | drupal       |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show slave status\G;</div><div class="line"></div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</div><div class="line">                  Master_Host: 172.16.115.101</div><div class="line">                  Master_User: repl</div><div class="line">                  Master_Port: 3306</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: mysql-bin.000001</div><div class="line">          Read_Master_Log_Pos: 867</div><div class="line">               Relay_Log_File: mysqld-relay-bin.000002</div><div class="line">                Relay_Log_Pos: 1013</div><div class="line">        Relay_Master_Log_File: mysql-bin.000001</div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB: drupal</div><div class="line">          Replicate_Ignore_DB: </div><div class="line">           Replicate_Do_Table: </div><div class="line">       Replicate_Ignore_Table: </div><div class="line">      Replicate_Wild_Do_Table: </div><div class="line">  Replicate_Wild_Ignore_Table: </div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error: </div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 867</div><div class="line">              Relay_Log_Space: 1170</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File: </div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: No</div><div class="line">           Master_SSL_CA_File: </div><div class="line">           Master_SSL_CA_Path: </div><div class="line">              Master_SSL_Cert: </div><div class="line">            Master_SSL_Cipher: </div><div class="line">               Master_SSL_Key: </div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error: </div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error: </div><div class="line">  Replicate_Ignore_Server_Ids: </div><div class="line">             Master_Server_Id: 1</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>
<p>如果Slave_IO_Running和Slave_SQL_Running都是YES，说明slave服务器配置OK。</p>
<p>###3、MHA作用<br>1）从宕机崩溃的master保存二进制日志事件（binlog events）;</p>
<p>2）识别含有最新更新的slave；</p>
<p>3）应用差异的中继日志（relay log）到其他的slave；</p>
<p>4）应用从master保存的二进制日志事件（binlog events）；</p>
<p>5）提升一个slave为新的master；</p>
<p>6）使其他的slave连接新的master进行复制；</p>
<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">masterha_check_ssh              检查MHA的SSH配置状况</div><div class="line">masterha_check_repl             检查MySQL复制状况</div><div class="line">masterha_manger                 启动MHA</div><div class="line">masterha_check_status           检测当前MHA运行状态</div><div class="line">masterha_master_monitor         检测master是否宕机</div><div class="line">masterha_master_switch          控制故障转移（自动或者手动）</div><div class="line">masterha_conf_host              添加或删除配置的server信息</div></pre></td></tr></table></figure>
<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">save_binary_logs                保存和复制master的二进制日志</div><div class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</div><div class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</div><div class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</div></pre></td></tr></table></figure>
<p>###4、配置MHA</p>
<p>####创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment"># vim /etc/masterha/app1.cnf </span></div><div class="line"></div><div class="line">[server default]</div><div class="line">manager_log=/var/<span class="built_in">log</span>/mha/app1/manager.log //设置manager的日志</div><div class="line">manager_workdir=/var/<span class="built_in">log</span>/mha/app1.log //设置manager的工作目录</div><div class="line">master_binlog_dir=/var/lib/mysql //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</div><div class="line"></div><div class="line">user=repl  //设置监控用户root</div><div class="line">password=123456 //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</div><div class="line">ssh_user=root //设置ssh的登录用户名</div><div class="line">repl_user=repl //设置复制环境中的复制用户名</div><div class="line">repl_password=123456 //设置复制用户的密码</div><div class="line">ping_interval=10 //设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover</div><div class="line"></div><div class="line">shutdown_script=<span class="string">""</span> //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</div><div class="line">master_ip_online_change_script=<span class="string">""</span> //设置手动切换时候的切换脚本</div><div class="line">report_script=<span class="string">"/usr/bin/masterha_report_script"</span> //设置发生切换后发送的报警的脚本</div><div class="line">master_ip_failover_script=<span class="string">"/usr/bin/masterha_ip_failover"</span> //设置自动failover时候的切换脚本</div><div class="line"></div><div class="line">[server1]</div><div class="line">hostname=172.16.115.101</div><div class="line"></div><div class="line">[server2]</div><div class="line">hostname=172.16.115.102</div><div class="line">candidate_master=1 //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中时间最新的slave</div><div class="line">check_repl_delay=0   //默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</div></pre></td></tr></table></figure>
<p>####设置relay log的清除方式（在每个slave节点上）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@192.168.115.102 ~]<span class="comment"># mysql -e 'set global relay_log_purge=0'</span></div></pre></td></tr></table></figure>
<p>注意：</p>
<p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</p>
<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--user mysql                      用户名</div><div class="line">--password mysql                  密码</div><div class="line">--port                            端口号</div><div class="line">--workdir                         指定创建relay <span class="built_in">log</span>的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</div><div class="line">--disable_relay_log_purge         默认情况下，如果relay_log_purge=1，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_log_purge=1的情况下会将relay_log_purge设置为0。清理relay <span class="built_in">log</span>之后，最后将参数设置为OFF。</div></pre></td></tr></table></figure>
<p>####设置定期清理relay脚本（两台slave服务器）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@192.168.115.102 ~]<span class="comment"># cat purge_relay_log.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">user=root</div><div class="line">passwd=123456</div><div class="line">port=3306</div><div class="line">log_dir=<span class="string">'/var/log/masterha'</span></div><div class="line">work_dir=<span class="string">'/var/lib/mysql'</span></div><div class="line">purge=<span class="string">'/usr/local/bin/purge_relay_logs'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="variable">$log_dir</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">   mkdir <span class="variable">$log_dir</span> -p</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="variable">$purge</span> --user=<span class="variable">$user</span> --password=<span class="variable">$passwd</span> --disable_relay_log_purge --port=<span class="variable">$port</span> --workdir=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p>添加到crontab定期执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@192.168.115.102 ~]<span class="comment"># crontab -l</span></div><div class="line">0 4 * * * /bin/bash /root/purge_relay_log.sh</div></pre></td></tr></table></figure></p>
<p>####purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@192.168.115.102 ~]<span class="comment"># purge_relay_logs --user=root --password=123456 --port=3306 -disable_relay_log_purge --workdir=/data/</span></div><div class="line">2014-04-20 15:47:24: purge_relay_logs script started.</div><div class="line"> Found relay_log.info: /data/mysql/relay-log.info</div><div class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</div><div class="line"> Current relay <span class="built_in">log</span> file: /data/mysql/server03-relay-bin.000002</div><div class="line"> Archiving unused relay <span class="built_in">log</span> files (up to /data/mysql/server03-relay-bin.000001) ...</div><div class="line"> Creating hard link <span class="keyword">for</span> /data/mysql/server03-relay-bin.000001 under /data//server03-relay-bin.000001 .. ok.</div><div class="line"> Creating hard links <span class="keyword">for</span> unused relay <span class="built_in">log</span> files completed.</div><div class="line"> Executing SET GLOBAL relay_log_purge=1; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay <span class="built_in">log</span> files (<span class="keyword">if</span> it keeps up); SET GLOBAL relay_log_purge=0; .. ok.</div><div class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</div><div class="line">2014-04-20 15:47:27: All relay <span class="built_in">log</span> purging operations succeeded.</div></pre></td></tr></table></figure>
<p>###5、SSH配置<br>要想MHA顺利执行各项任务，还得打通每台机器的SSH。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 app1]<span class="comment"># ssh-keygen -t rsa</span></div><div class="line">[root@172.16.2.99 app1]<span class="comment"># ssh-copy-id -i .ssh/id_rsa.pub root@172.16.115.101</span></div><div class="line">.....</div></pre></td></tr></table></figure>
<p>记住，每台机器都要跟别的机器打通SSH。</p>
<p>检查MHA Manger到所有MHA Node的SSH连接状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></div><div class="line">Wed Dec  2 14:42:39 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Starting SSH connection tests..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug] </div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.101(172.16.115.101:22) to root@172.16.115.102(172.16.115.102:22)..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</div><div class="line">Wed Dec  2 14:42:40 2015 - [debug] </div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.102(172.16.115.102:22) to root@172.16.115.101(172.16.115.101:22)..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</div><div class="line">Wed Dec  2 14:42:40 2015 - [info] All SSH connection tests passed successfully.</div></pre></td></tr></table></figure>
<p>可以看见各个节点ssh验证都是ok的。</p>
<p>###6、检查整个复制环境状况<br>通过masterha_check_repl脚本查看整个集群的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></div><div class="line">Wed Dec  2 14:42:39 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:42:39 2015 - [info] Starting SSH connection tests..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug] </div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.101(172.16.115.101:22) to root@172.16.115.102(172.16.115.102:22)..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</div><div class="line">Wed Dec  2 14:42:40 2015 - [debug] </div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.102(172.16.115.102:22) to root@172.16.115.101(172.16.115.101:22)..</div><div class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</div><div class="line">Wed Dec  2 14:42:40 2015 - [info] All SSH connection tests passed successfully.</div><div class="line">[root@utn-cz-1-1<span class="_">-s</span>16h2 app1.log]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf  </span></div><div class="line">Wed Dec  2 14:43:49 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Dec  2 14:43:49 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:43:49 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:43:49 2015 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] GTID failover mode = 0</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Dead Servers:</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Alive Servers:</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.102(172.16.115.102:3306)</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Alive Slaves:</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.102(172.16.115.102:3306)  Version=5.5.46-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]     Replicating from 172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Current Alive Master: 172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Checking slave configurations..</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]  read_only=1 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</div><div class="line">Wed Dec  2 14:43:50 2015 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Checking replication filtering settings..</div><div class="line">Wed Dec  2 14:43:50 2015 - [info]  binlog_do_db= drupal, binlog_ignore_db= </div><div class="line">Wed Dec  2 14:43:50 2015 - [info]  Replication filtering check ok.</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] GTID (with auto-pos) is not supported</div><div class="line">Wed Dec  2 14:43:50 2015 - [info] Starting SSH connection tests..</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] All SSH connection tests passed successfully.</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] Checking MHA Node version..</div><div class="line">Wed Dec  2 14:43:51 2015 - [info]  Version check ok.</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] Checking SSH publickey authentication settings on the current master..</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] HealthCheck: SSH to 172.16.115.101 is reachable.</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] Master MHA Node version is 0.56.</div><div class="line">Wed Dec  2 14:43:51 2015 - [info] Checking recovery script configurations on 172.16.115.101(172.16.115.101:3306)..</div><div class="line">Wed Dec  2 14:43:51 2015 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.000021 </div><div class="line">Wed Dec  2 14:43:51 2015 - [info]   Connecting to root@172.16.115.101(172.16.115.101:22).. </div><div class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</div><div class="line">  Checking output directory is accessible or not..</div><div class="line">   ok.</div><div class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.000021</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Binlog setting check done.</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</div><div class="line">Wed Dec  2 14:43:52 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=172.16.115.102 --slave_ip=172.16.115.102 --slave_port=3306 --workdir=/var/tmp --target_version=5.5.46-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</div><div class="line">Wed Dec  2 14:43:52 2015 - [info]   Connecting to root@172.16.115.102(172.16.115.102:22).. </div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</div><div class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.000022</div><div class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.000022</div><div class="line">    Testing mysql connection and privileges.. done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Slaves settings check done.</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] </div><div class="line">172.16.115.101(172.16.115.101:3306) (current master)</div><div class="line"> +--172.16.115.102(172.16.115.102:3306)</div><div class="line"></div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Checking replication health on 172.16.115.102..</div><div class="line">Wed Dec  2 14:43:52 2015 - [info]  ok.</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Checking master_ip_failover_script status:</div><div class="line">Wed Dec  2 14:43:52 2015 - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=172.16.115.101 --orig_master_ip=172.16.115.101 --orig_master_port=3306 </div><div class="line"></div><div class="line"></div><div class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:0 down==/sbin/ifconfig eth0:0 172.16.115.200/24===</div><div class="line"></div><div class="line">Checking the Status of the script.. OK </div><div class="line">Wed Dec  2 14:43:52 2015 - [info]  OK.</div><div class="line">Wed Dec  2 14:43:52 2015 - [warning] shutdown_script is not defined.</div><div class="line">Wed Dec  2 14:43:52 2015 - [info] Got <span class="built_in">exit</span> code 0 (Not master dead).</div><div class="line"></div><div class="line">MySQL Replication Health is OK.</div></pre></td></tr></table></figure>
<p>###7、检查MHA Manager的状态<br>通过master_check_status脚本查看Manager的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></div><div class="line">app1 is stopped(2:NOT_RUNNING).</div></pre></td></tr></table></figure>
<p>注意：如果正常，会显示”PING_OK”，否则会显示”NOT_RUNNING”，这代表MHA监控没有开启。</p>
<p>###8、开启MHA Manager监控</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failover &gt; /var/log/mha/app1/manager.log &lt; /dev/null 2&gt;&amp;1 &amp;</span></div><div class="line">[1] 7303</div></pre></td></tr></table></figure>
<p>启动参数介绍：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--remove_dead_master_conf      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</div><div class="line">--manger_log                            日志存放位置</div><div class="line">--ignore_last_failover                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足8小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</div></pre></td></tr></table></figure>
<p>查看MHA Manager监控是否正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></div><div class="line">app1 (pid:20386) is running(0:PING_OK), master:172.16.115.101</div></pre></td></tr></table></figure>
<p>可以看见已经在监控了，而且master的主机为172.16.115.101</p>
<p>###9、查看启动日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment">#  cat /var/log/mha/app1/manager.log</span></div><div class="line">Wed Dec  2 14:46:37 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Dec  2 14:46:37 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:46:37 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Dec  2 14:46:37 2015 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] GTID failover mode = 0</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Dead Servers:</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Alive Servers:</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.102(172.16.115.102:3306)</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Alive Slaves:</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.102(172.16.115.102:3306)  Version=5.5.46-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]     Replicating from 172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Current Alive Master: 172.16.115.101(172.16.115.101:3306)</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Checking slave configurations..</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]  read_only=1 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</div><div class="line">Wed Dec  2 14:46:38 2015 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Checking replication filtering settings..</div><div class="line">Wed Dec  2 14:46:38 2015 - [info]  binlog_do_db= drupal, binlog_ignore_db= </div><div class="line">Wed Dec  2 14:46:38 2015 - [info]  Replication filtering check ok.</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] GTID (with auto-pos) is not supported</div><div class="line">Wed Dec  2 14:46:38 2015 - [info] Starting SSH connection tests..</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] All SSH connection tests passed successfully.</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Checking MHA Node version..</div><div class="line">Wed Dec  2 14:46:39 2015 - [info]  Version check ok.</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Checking SSH publickey authentication settings on the current master..</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] HealthCheck: SSH to 172.16.115.101 is reachable.</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Master MHA Node version is 0.56.</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Checking recovery script configurations on 172.16.115.101(172.16.115.101:3306)..</div><div class="line">Wed Dec  2 14:46:39 2015 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.000021 </div><div class="line">Wed Dec  2 14:46:39 2015 - [info]   Connecting to root@172.16.115.101(172.16.115.101:22).. </div><div class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</div><div class="line">  Checking output directory is accessible or not..</div><div class="line">   ok.</div><div class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.000021</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Binlog setting check done.</div><div class="line">Wed Dec  2 14:46:39 2015 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</div><div class="line">Wed Dec  2 14:46:39 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=172.16.115.102 --slave_ip=172.16.115.102 --slave_port=3306 --workdir=/var/tmp --target_version=5.5.46-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</div><div class="line">Wed Dec  2 14:46:39 2015 - [info]   Connecting to root@172.16.115.102(172.16.115.102:22).. </div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</div><div class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.000022</div><div class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.000022</div><div class="line">    Testing mysql connection and privileges.. done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</div><div class="line">Wed Dec  2 14:46:40 2015 - [info] Slaves settings check done.</div><div class="line">Wed Dec  2 14:46:40 2015 - [info] </div><div class="line">172.16.115.101(172.16.115.101:3306) (current master)</div><div class="line"> +--172.16.115.102(172.16.115.102:3306)</div><div class="line"></div><div class="line">Wed Dec  2 14:46:40 2015 - [info] Checking master_ip_failover_script status:</div><div class="line">Wed Dec  2 14:46:40 2015 - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=172.16.115.101 --orig_master_ip=172.16.115.101 --orig_master_port=3306 </div><div class="line"></div><div class="line"></div><div class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:0 down==/sbin/ifconfig eth0:0 172.16.115.200/24===</div><div class="line"></div><div class="line">Checking the Status of the script.. OK </div><div class="line">Wed Dec  2 14:46:40 2015 - [info]  OK.</div><div class="line">Wed Dec  2 14:46:40 2015 - [warning] shutdown_script is not defined.</div><div class="line">Wed Dec  2 14:46:40 2015 - [info] Set master ping interval 1 seconds.</div><div class="line">Wed Dec  2 14:46:40 2015 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</div><div class="line">Wed Dec  2 14:46:40 2015 - [info] Starting ping health check on 172.16.115.101(172.16.115.101:3306)..</div><div class="line">Wed Dec  2 14:46:40 2015 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></div></pre></td></tr></table></figure>
<p>###10、配置VIP</p>
<p>我们采用脚本的方式去配置vip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 ~]<span class="comment">#  vim /usr/bin/masterha_ip_failover</span></div><div class="line"></div><div class="line"><span class="comment">#!/usr/bin/env perl</span></div><div class="line"></div><div class="line">use strict;</div><div class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</div><div class="line"></div><div class="line">use Getopt::Long;</div><div class="line"></div><div class="line">my (</div><div class="line">    <span class="variable">$command</span>,          <span class="variable">$ssh_user</span>,        <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</div><div class="line">    <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span></div><div class="line">);</div><div class="line"></div><div class="line">my <span class="variable">$vip</span> = <span class="string">'172.16.115.200/24'</span>;</div><div class="line">my <span class="variable">$key</span> = <span class="string">'0'</span>;</div><div class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> <span class="variable">$vip</span>"</span>;</div><div class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> down"</span>;</div><div class="line"></div><div class="line">GetOptions(</div><div class="line">    <span class="string">'command=s'</span>          =&gt; \<span class="variable">$command</span>,</div><div class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \<span class="variable">$ssh_user</span>,</div><div class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$orig_master_host</span>,</div><div class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \<span class="variable">$orig_master_ip</span>,</div><div class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \<span class="variable">$orig_master_port</span>,</div><div class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</div><div class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \<span class="variable">$new_master_ip</span>,</div><div class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \<span class="variable">$new_master_port</span>,</div><div class="line">);</div><div class="line"></div><div class="line"><span class="built_in">exit</span> &amp;main();</div><div class="line"></div><div class="line">sub main &#123;</div><div class="line"></div><div class="line">    <span class="built_in">print</span> <span class="string">"\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</div><div class="line"></div><div class="line">        my <span class="variable">$exit_code</span> = 1;</div><div class="line">        <span class="built_in">eval</span> &#123;</div><div class="line">            <span class="built_in">print</span> <span class="string">"Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n"</span>;</div><div class="line">            &amp;stop_vip();</div><div class="line">            <span class="variable">$exit_code</span> = 0;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</div><div class="line">            warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</div><div class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</div><div class="line">    &#125;</div><div class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</div><div class="line"></div><div class="line">        my <span class="variable">$exit_code</span> = 10;</div><div class="line">        <span class="built_in">eval</span> &#123;</div><div class="line">            <span class="built_in">print</span> <span class="string">"Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</div><div class="line">            &amp;start_vip();</div><div class="line">            <span class="variable">$exit_code</span> = 0;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</div><div class="line">            warn <span class="variable">$@</span>;</div><div class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</div><div class="line">    &#125;</div><div class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</div><div class="line">        <span class="built_in">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</div><div class="line">        <span class="built_in">exit</span> 0;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        &amp;usage();</div><div class="line">        <span class="built_in">exit</span> 1;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</div><div class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \<span class="string">" <span class="variable">$ssh_start_vip</span> \"`;</span></div><div class="line">&#125;</div><div class="line">sub stop_vip() &#123;</div><div class="line">     return 0  unless  (<span class="variable">$ssh_user</span>);</div><div class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \" <span class="variable">$ssh_stop_vip</span> \"`;</div><div class="line">&#125;</div><div class="line"></div><div class="line">sub usage &#123;</div><div class="line">    print</div><div class="line">    "Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip </div><div class="line">            --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n<span class="string">";</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###11、邮件发送脚本send_report </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/perl</span></div><div class="line"></div><div class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></div><div class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></div><div class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></div><div class="line"><span class="comment">#  (at your option) any later version.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment">#  GNU General Public License for more details.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></div><div class="line"><span class="comment">#  Foundation, Inc.,</span></div><div class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></div><div class="line"></div><div class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></div><div class="line"></div><div class="line">use strict;</div><div class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</div><div class="line">use Mail::Sender;</div><div class="line">use Getopt::Long;</div><div class="line"></div><div class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></div><div class="line">my ( <span class="variable">$dead_master_host</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_slave_hosts</span>, <span class="variable">$subject</span>, <span class="variable">$body</span> );</div><div class="line">my <span class="variable">$smtp</span>=<span class="string">'smtp.163.com'</span>;</div><div class="line">my <span class="variable">$mail_from</span>=<span class="string">'services@163.com'</span>;</div><div class="line">my <span class="variable">$mail_user</span>=<span class="string">'services@163.com'</span>;</div><div class="line">my <span class="variable">$mail_pass</span>=<span class="string">'123456'</span>;</div><div class="line">my <span class="variable">$mail_to</span>=[<span class="string">'xxx@xxx.cn'</span>];</div><div class="line">GetOptions(</div><div class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$dead_master_host</span>,</div><div class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</div><div class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \<span class="variable">$new_slave_hosts</span>,</div><div class="line">  <span class="string">'subject=s'</span>          =&gt; \<span class="variable">$subject</span>,</div><div class="line">  <span class="string">'body=s'</span>             =&gt; \<span class="variable">$body</span>,</div><div class="line">);</div><div class="line"></div><div class="line">mailToContacts(<span class="variable">$smtp</span>,<span class="variable">$mail_from</span>,<span class="variable">$mail_user</span>,<span class="variable">$mail_pass</span>,<span class="variable">$mail_to</span>,<span class="variable">$subject</span>,<span class="variable">$body</span>);</div><div class="line"></div><div class="line">sub mailToContacts &#123;</div><div class="line">    my ( <span class="variable">$smtp</span>, <span class="variable">$mail_from</span>, <span class="variable">$user</span>, <span class="variable">$passwd</span>, <span class="variable">$mail_to</span>, <span class="variable">$subject</span>, <span class="variable">$msg</span> ) = @_;</div><div class="line">    open my <span class="variable">$DEBUG</span>, <span class="string">"&gt; /tmp/monitormail.log"</span></div><div class="line">        or die <span class="string">"Can't open the debug      file:$!\n"</span>;</div><div class="line">    my <span class="variable">$sender</span> = new Mail::Sender &#123;</div><div class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</div><div class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</div><div class="line">        smtp        =&gt; <span class="variable">$smtp</span>,</div><div class="line">        from        =&gt; <span class="variable">$mail_from</span>,</div><div class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</div><div class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</div><div class="line">        authid      =&gt; <span class="variable">$user</span>,</div><div class="line">        authpwd     =&gt; <span class="variable">$passwd</span>,</div><div class="line">        to          =&gt; <span class="variable">$mail_to</span>,</div><div class="line">        subject     =&gt; <span class="variable">$subject</span>,</div><div class="line">        debug       =&gt; <span class="variable">$DEBUG</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="variable">$sender</span>-&gt;MailMsg(</div><div class="line">        &#123;   msg   =&gt; <span class="variable">$msg</span>,</div><div class="line">            debug =&gt; <span class="variable">$DEBUG</span></div><div class="line">        &#125;</div><div class="line">    ) or <span class="built_in">print</span> <span class="variable">$Mail</span>::Sender::Error;</div><div class="line">    <span class="built_in">return</span> 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Do whatever you want here</span></div><div class="line"></div><div class="line"><span class="built_in">exit</span> 0;</div></pre></td></tr></table></figure>
<p>###12、测试<br>1.主库断电<br>2.主库断网<br>3.主库重启<br>4.主库关机<br>以上情况都测试过都能自动切换~<br>请看日志分析切换过程  </p>
<p>###13、主库模拟故障后的恢复  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@172.16.2.99 app1]<span class="comment"># grep -i "All other slaves should start" manager.log </span></div><div class="line">Mon Apr 21 22:28:33 2014 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.115.102'</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class="string">'mysql-bin.000022'</span>, MASTER_LOG_POS=506716, MASTER_USER=<span class="string">'repl'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</div><div class="line">[root@192.168.0.20 app1]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>然后再就得主库里执行下,再start slave ,然后就得主库就变为了新的主库的从库了。<br>记得看下show slave status\G;  </p>
<p>###14、报错记录总结<br>摘抄自google.</p>
<p>####报错记录1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@data01 ~]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></div><div class="line">Tue Apr 7 22:31:06 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</div><div class="line">Tue Apr 7 22:31:07 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</div><div class="line">Tue Apr 7 22:31:07 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</div><div class="line">Tue Apr 7 22:31:07 2015 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln303]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on192.168.52.130(192.168.52.130:3306)!</div><div class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pmline 315</div><div class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</div><div class="line">Tue Apr 7 22:31:07 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div><div class="line">[root@data01 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>解决办法：在192.168.52.130上面，vim /etc/my.cnf，在里面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">relay-log=/home/data/mysql/binlog/mysql-relay-bin</div></pre></td></tr></table></figure>
<p>然后重启mysql，再去重新设置slave连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">STOP SLAVE;</div><div class="line">RESET SLAVE;</div><div class="line">CHANGE MASTER TOMASTER_HOST=<span class="string">'192.168.52.129'</span>,MASTER_USER=<span class="string">'repl'</span>,MASTER_PASSWORD=<span class="string">'repl_1234'</span>,MASTER_LOG_FILE=<span class="string">'mysql-bin.000178'</span>,MASTER_LOG_POS=459;</div><div class="line">START SLAVE;</div></pre></td></tr></table></figure>
<p>Ok，搞定了。</p>
<p>####报错记录2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@data01 perl]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></div><div class="line">Thu Apr 9 00:54:32 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</div><div class="line">Thu Apr 9 00:54:32 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</div><div class="line">Thu Apr 9 00:54:32 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</div><div class="line">Thu Apr 9 00:54:32 2015 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln306]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on 192.168.52.130(192.168.52.130:3306)!</div><div class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm line 315</div><div class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</div><div class="line">Thu Apr 9 00:54:32 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div><div class="line">[root@data01 perl]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>解决方法：<br>/etc/masterha/app1.cnf文件里面的参数配置，user和repl_user都是mysql账号，需要创建好，这里是只创建了repl_user而没有创建好user账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">user=manager</div><div class="line">password=manager_1234</div><div class="line">repl_user=repl</div><div class="line">repl_password=repl_1234</div></pre></td></tr></table></figure>
<p>在mysql节点上，建立允许manager 访问数据库的“ manager manager ”账户，主要用于SHOW SLAVESTATUS,RESET SLAVE; 所以需要执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT SUPER,RELOAD,REPLICATIONCLIENT,SELECT ON *.* TO manager@<span class="string">'192.168.52.%'</span> IDENTIFIED BY <span class="string">'manager_1234'</span>;</div></pre></td></tr></table></figure>
<p>####错误记录3：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@oraclem1 ~]<span class="comment">#  masterha_check_repl--conf=/etc/masterha/app1.cnf</span></div><div class="line">Thu Apr 9 23:09:05 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</div><div class="line">Thu Apr 9 23:09:05 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</div><div class="line">Thu Apr 9 23:09:05 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</div><div class="line">Thu Apr 9 23:09:05 2015 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm,ln781] Multi-master configuration is detected, but two or more masters areeither writable (<span class="built_in">read</span>-only is not <span class="built_in">set</span>) or dead! Check configurations fordetails. Master configurations are as below:</div><div class="line">Master 192.168.52.130(192.168.52.130:3306),replicating from 192.168.52.129(192.168.52.129:3306)</div><div class="line">Master 192.168.52.129(192.168.52.129:3306),replicating from 192.168.52.130(192.168.52.130:3306)</div><div class="line"> </div><div class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm line 326</div><div class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</div><div class="line">Thu Apr 9 23:09:05 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div><div class="line">[root@oraclem1 ~]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; <span class="built_in">set</span> global read_only=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<p>####报错记录4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Thu Apr 9 23:54:32 2015 - [info] Checking SSH publickey authentication andchecking recovery script configurations on all alive slave servers..</div><div class="line">Thu Apr 9 23:54:32 2015 - [info]  Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span>--slave_user=<span class="string">'manager'</span> --slave_host=192.168.52.130 --slave_ip=192.168.52.130--slave_port=3306 --workdir=/var/tmp --target_version=5.6.12-log--manager_version=0.56 --relay_dir=/home/data/mysql/data--current_relay_log=mysqld-relay-bin.000011 --slave_pass=xxx</div><div class="line">Thu Apr 9 23:54:32 2015 - [info]  Connecting to root@192.168.52.130(192.168.52.130:22)..</div><div class="line">Can<span class="string">'t exec "mysqlbinlog": No suchfile or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 106.</span></div><div class="line">mysqlbinlog version command failed with rc1:0, please verify PATH, LD_LIBRARY_PATH, and client options</div><div class="line"> at/usr/local/bin/apply_diff_relay_logs line 493</div><div class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</div><div class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</div><div class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line 48</div><div class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</div><div class="line">Thu Apr 9 23:54:32 2015 - [info] Got exit code 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div><div class="line">[root@oraclem1 ~]#</div></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@data02 ~]<span class="comment"># type mysqlbinlog</span></div><div class="line">mysqlbinlog is/usr/<span class="built_in">local</span>/mysql/bin/mysqlbinlog</div><div class="line">[root@data02 ~]<span class="comment">#</span></div><div class="line">[root@data02 ~]<span class="comment"># ln -s/usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span></div></pre></td></tr></table></figure>
<p>####报错记录5：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Thu Apr 9 23:57:24 2015 - [info]  Connecting to root@192.168.52.130(192.168.52.130:22)..</div><div class="line"> Checking slave recovery environment settings..</div><div class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.000013</div><div class="line">   Temporary relay <span class="built_in">log</span> file is /home/data/mysql/data/mysqld-relay-bin.000013</div><div class="line">   Testing mysql connection and privileges..sh: mysql: <span class="built_in">command</span> not found</div><div class="line">mysql <span class="built_in">command</span> failed with rc 127:0!</div><div class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 375</div><div class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 497</div><div class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 475</div><div class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 120</div><div class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</div><div class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</div><div class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/bin/masterha_check_repl line 48</div><div class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</div><div class="line">Thu Apr 9 23:57:24 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/mysql/bin/mysql/usr/bin/mysql</div></pre></td></tr></table></figure>
<p>####报错记录6：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Fri Apr 10 00:58:36 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs--command=<span class="built_in">test</span> --slave_user=<span class="string">'manager'</span> --slave_host=192.168.52.130--slave_ip=192.168.52.130 --slave_port=3306 --workdir=/var/tmp--target_version=5.6.12-log --manager_version=0.56--relay_dir=/home/data/mysql/data--current_relay_log=mysqld-relay-bin.000011 --slave_pass=xxx</div><div class="line">Fri Apr 10 00:58:36 2015 - [info]   Connecting to root@192.168.52.130(192.168.52.130:22)..</div><div class="line"> Checking slave recovery environment settings..</div><div class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.000013</div><div class="line">   Temporary relay <span class="built_in">log</span> file is/home/data/mysql/data/mysqld-relay-bin.000013</div><div class="line">   Testing mysql connection and privileges..Warning: Using a password onthe <span class="built_in">command</span> line interface can be insecure.</div><div class="line">ERROR 1142 (42000) at line 1: CREATE<span class="built_in">command</span> denied to user <span class="string">'manager'</span>@<span class="string">'192.168.52.130'</span> <span class="keyword">for</span> table<span class="string">'apply_diff_relay_logs_test'</span></div><div class="line">mysql <span class="built_in">command</span> failed with rc 1:0!</div><div class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 375</div><div class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 497</div><div class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 475</div><div class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 120</div><div class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln205] Slaves settingscheck failed!</div><div class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln413] Slave configurationfailed.</div><div class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln424] Error happened onchecking configurations.  at/usr/<span class="built_in">local</span>/bin/masterha_check_repl line 48</div><div class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln523] Error happened onmonitoring servers.</div><div class="line">Fri Apr 10 00:58:37 2015 - [info] Got exitcode 1 (Not master dead).</div><div class="line"> </div><div class="line">MySQL Replication Health is NOT OK!</div></pre></td></tr></table></figure>
<p>解决办法：<br>执行如下授权语句sql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT CREATE,INSERT,UPDATE,DELETE,DROP ON*.* TO manager@<span class="string">'192.168.52.%'</span>;</div></pre></td></tr></table></figure>
<p>####其他<br>另外，如果nohup masterha_manager执行不了，请检查master和slave是否配置正确。可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=3306,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_log_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=0;</div></pre></td></tr></table></figure>
<p>重新设置slave。</p>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/27/使用gdb调试php-fpm/" itemprop="url">
                  使用gdb调试php-fpm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-27T16:17:10+08:00" content="2015-11-27">
              2015-11-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/27/使用gdb调试php-fpm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/27/使用gdb调试php-fpm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>有很多php开发人员经常问我，如果执行php代码的时候出现严重错误的时候，如何快速定位问题。我一般推荐他们用gdb去调试。</p>
<p>下面用php-fpm的一个段错误来举例说明，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">WARNING: [pool www] child 15109 exited on signal 11 (SIGSEGV) after 654.485221 seconds from start</div></pre></td></tr></table></figure>
<p>###1、安装gdb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install gdb php-dbg</div></pre></td></tr></table></figure>
<p>有的时候可能需要安装debuginfo相关的库，如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">debuginfo-install php-fpm</div></pre></td></tr></table></figure>
<p>###2、设置coredump</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'/tmp/core-%e.%p'</span> &gt; /proc/sys/kernel/core_pattern</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/core_uses_pid</div><div class="line"><span class="built_in">ulimit</span> -c unlimited</div></pre></td></tr></table></figure>
<p>当然,coredump的文件格式可以设置为其他的，这里是详细的设置项说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">%%  a single % character</div><div class="line">%c  core file size soft resource <span class="built_in">limit</span> of crashing process (since</div><div class="line">    Linux 2.6.24)</div><div class="line">%d  dump mode—same as value returned by prctl(2) PR_GET_DUMPABLE</div><div class="line">    (since Linux 3.7)</div><div class="line">%e  executable filename (without path prefix)</div><div class="line">%E  pathname of executable, with slashes (<span class="string">'/'</span>) replaced by</div><div class="line">    exclamation marks (<span class="string">'!'</span>) (since Linux 3.0).</div><div class="line">%g  (numeric) real GID of dumped process</div><div class="line">%h  hostname (same as nodename returned by uname(2))</div><div class="line">%p  PID of dumped process, as seen <span class="keyword">in</span> the PID namespace <span class="keyword">in</span> <span class="built_in">which</span></div><div class="line">    the process resides</div><div class="line">%P  PID of dumped process, as seen <span class="keyword">in</span> the initial PID namespace</div><div class="line">    (since Linux 3.12)</div><div class="line">%s  number of signal causing dump</div><div class="line">%t  time of dump, expressed as seconds since the Epoch,</div><div class="line">    1970-01-01 00:00:00 +0000 (UTC)</div><div class="line">%u  (numeric) real UID of dumped process</div></pre></td></tr></table></figure>
<p>###3、设置php-fpm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/php-fpm.d/www.conf</div></pre></td></tr></table></figure>
<p>找到关键字 rlimit_core，并修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rlimit_core = unlimited</div></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/sbin/php-fpm --daemonize</div></pre></td></tr></table></figure>
<p>这时就会在/tmp下看到有coredump文件生成了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost tmp]<span class="comment"># ls</span></div><div class="line">core-php-fpm.7279</div></pre></td></tr></table></figure>
<p>###4、追踪<br>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gdb /usr/sbin/php-fpm /tmp/core-php-fpm.7279</div></pre></td></tr></table></figure>
<p>执行bt命令就可以查看详细的错误日志了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(gdb) bt</div><div class="line"><span class="comment">#0  _zend_hash_init (ht=0x2b4d1a4f8100, nSize=174762, pDestructor=0, persistent=1 '\001') at /usr/src/debug/php-7.0.0RC8/Zend/zend_hash.c:172</span></div><div class="line"><span class="comment">#1  0x00002b4d0d0e87ac in zend_accel_init_shm (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2387</span></div><div class="line"><span class="comment">#2  accel_startup (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2640</span></div><div class="line"><span class="comment">#3  0x00000000005e8d21 in zend_extension_startup (extension=0x168c810) at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:176</span></div><div class="line"><span class="comment">#4  0x00000000005d2293 in zend_llist_apply_with_del (l=0x9dd420, func=0x5e8d10 &lt;zend_extension_startup&gt;) at /usr/src/debug/php-7.0.0RC8/Zend/zend_llist.c:171</span></div><div class="line"><span class="comment">#5  0x00000000005e8d07 in zend_startup_extensions () at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:197</span></div><div class="line"><span class="comment">#6  0x0000000000580985 in php_module_startup (sf=&lt;value optimized out&gt;, additional_modules=&lt;value optimized out&gt;, num_additional_modules=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/main/main.c:2197</span></div><div class="line"><span class="comment">#7  0x000000000067aec5 in php_cgi_startup (sapi_module=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:837</span></div><div class="line"><span class="comment">#8  0x000000000067bcfe in main (argc=2, argv=0x7fff1a037498) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:1788</span></div></pre></td></tr></table></figure>
<p>至此，整个追踪过程结束。</p>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="url">
                  centos6.6安装Percona Tokudb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-21T20:17:57+08:00" content="2015-11-21">
              2015-11-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/21/centos6-6安装Percona-Tokudb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>在percona官网<a href="https://www.percona.com/" target="_blank" rel="external">https://www.percona.com/</a><br>下载带有Tokudb的二进制包，也可以选择源码编译。tokudb有单独的包.<br>我这里下载的是最新的包，5.6.25-73<br>Percona-Server-5.6.25-rel73.1-Linux.x86_64.ssl101.tar.gz<br>Percona-Server-5.6.25-rel73.1-TokuDB.Linux.x86_64.ssl101.tar.gz</p>
<p>###前期账号创建<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell&gt; groupadd mysql</div><div class="line">shell&gt; useradd -g mysql mysql</div></pre></td></tr></table></figure></p>
<p>###解压软件包<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">shell&gt; cd /usr/local</div><div class="line">shell&gt; tar -zxvf Percona-Server<span class="number">-5.6</span><span class="number">.25</span>-rel73<span class="number">.1</span>-Linux.x86_64.ssl101.tar.gz</div><div class="line">shell&gt; tar -zxvf Percona-Server<span class="number">-5.6</span><span class="number">.25</span>-rel73<span class="number">.1</span>-TokuDB.Linux.x86_64.ssl101.tar.gz</div><div class="line">shell&gt; ln -s Percona-Server<span class="number">-5.6</span><span class="number">.25</span>-rel73<span class="number">.1</span>-Linux.x86_64.ssl101 mysql</div></pre></td></tr></table></figure></p>
<p>###设置权限<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell&gt; cd mysql</div><div class="line">shell&gt; chown -R mysql .</div><div class="line">shell&gt; chgrp -R mysql .</div></pre></td></tr></table></figure></p>
<p>###创建配置文件/etc/my.cnf<br>创建存放数据源的目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Shell&gt; mkdir -p /<span class="keyword">var</span>/lib/mysql</div><div class="line">Shell&gt; mkdir -p /data/mysqldata /data/mysqllog</div><div class="line">Shell&gt; chown -R mysql:mysql /<span class="keyword">var</span>/lib/mysql /data/mysqldata /data/mysqllog</div></pre></td></tr></table></figure>
<p>在附件中给出，请参考附配置文件内容</p>
<p>###初始化DB</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Shell&gt; scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf</div><div class="line">shell&gt; chown -R root .</div></pre></td></tr></table></figure>
<p>###修改系统参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</div></pre></td></tr></table></figure>
<p>建议写到 /etc/rc.local 中，重启后也可生效</p>
<p>###启动数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; bin/mysqld_safe --user=mysql &amp;</div></pre></td></tr></table></figure>
<p>###把启动文件放去自启动中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</div><div class="line">chkconfig --add mysqld</div><div class="line">service mysqld start</div><div class="line">service mysqld stop</div></pre></td></tr></table></figure>
<p>然后启动。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show engines;</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line">| InnoDB             | <span class="keyword">DEFAULT</span> | Percona-XtraDB, Supports transactions, row-level locking, <span class="keyword">and</span> foreign keys | YES          | YES  | YES        |</div><div class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</div><div class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</div><div class="line">| BLACKHOLE          | YES     | /dev/<span class="keyword">null</span> storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</div><div class="line">| MEMORY             | YES     | Hash based, stored in memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</div><div class="line">| TokuDB             | YES     | Tokutek TokuDB Storage Engine with Fractal Tree(tm) Technology             | YES          | YES  | YES        |</div><div class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</div><div class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</div><div class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</div><div class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                             | <span class="keyword">NULL</span>         | <span class="keyword">NULL</span> | <span class="keyword">NULL</span>       |</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line"><span class="number">10</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
<p>看到上面一行红字就代表数据库支持TokuDB的存储引擎了。</p>
<p>tokudb安装顺利完成，后附配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">[root@localhost mysql]<span class="comment"># cat /etc/my.cnf </span></div><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">user=mysql</div><div class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></div><div class="line">symbolic-links=0</div><div class="line"><span class="comment">#public</span></div><div class="line">max_connections=3000</div><div class="line">max_connect_errors=6000</div><div class="line">key_buffer_size = 384M</div><div class="line">low_priority_updates = 1</div><div class="line">back_log = 1500</div><div class="line">query_cache_type = 1</div><div class="line">query_cache_size = 64M</div><div class="line">query_cache_limit = 4M</div><div class="line">query_cache_min_res_unit = 2k</div><div class="line">tmp_table_size = 256M</div><div class="line">read_buffer_size=1M</div><div class="line">read_rnd_buffer_size = 16M</div><div class="line">bulk_insert_buffer_size = 64M</div><div class="line">max_allowed_packet = 64M</div><div class="line">thread_cache_size = 300</div><div class="line"><span class="comment">#file</span></div><div class="line">innodb_file_per_table</div><div class="line"><span class="comment">#buffer</span></div><div class="line">innodb_buffer_pool_size = 2500M</div><div class="line">innodb_log_buffer_size = 64M</div><div class="line">join_buffer_size = 16M</div><div class="line">sort_buffer_size = 16M</div><div class="line">innodb_max_dirty_pages_pct = 90</div><div class="line">innodb_lock_wait_timeout = 120</div><div class="line">innodb_thread_concurrency = 16</div><div class="line">innodb_flush_log_at_trx_commit = 2</div><div class="line">character_set_server=utf8</div><div class="line">init_connect=<span class="string">'SET NAMES utf8'</span></div><div class="line"></div><div class="line"><span class="comment">#tokudb</span></div><div class="line">plugin_dir =  /usr/<span class="built_in">local</span>/mysql/lib/mysql/plugin/</div><div class="line">plugin_load=ha_tokudb.so</div><div class="line"><span class="comment">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></div><div class="line">tokudb_data-dir = /data/mysqldata</div><div class="line">tokudb_log-dir = /data/mysqllog</div><div class="line"><span class="comment">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></div><div class="line">tokudb_row_format = tokudb_small</div><div class="line">tokudb_row_format = tokudb_fast</div><div class="line">tokudb_cache_size = 2G</div><div class="line"><span class="comment">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></div><div class="line">tokudb_commit_sync = 0</div><div class="line">tokudb_directio = 1</div><div class="line">tokudb_read_block_size = 128K</div><div class="line">tokudb_read_buf_size = 128K</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</div><div class="line">pid-file=/var/run/mysqld/mysqld.pid</div><div class="line">malloc_lib = /usr/<span class="built_in">local</span>/mysql/lib/mysql/libjemalloc.so <span class="comment">#只能放在mysqld_safe中，不得报错</span></div></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/20/centos6-6安装mariadb10-Tokudb/" itemprop="url">
                  centos6.6安装mariadb10 Tokudb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-20T20:17:18+08:00" content="2015-11-20">
              2015-11-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/20/centos6-6安装mariadb10-Tokudb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/20/centos6-6安装mariadb10-Tokudb/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ps: 如果想在mariadb10上使用tokudb就只能自己编译了。。。。</p>
<p>###一、环境准备：<br>tokudb的编译需要cmake 2.8.9+ 和 gcc 4.7+</p>
<p>本文选用cmake 2.8.9 和 gcc4.8.1。<br>这2个软件都只能使用源码编译安装。</p>
<p>cmake的很简单，直接下载<br>wget <a href="http://www.cmake.org/files/v2.8/cmake-2.8.9.tar.gz" target="_blank" rel="external">http://www.cmake.org/files/v2.8/cmake-2.8.9.tar.gz</a><br>然后解压进行编译<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure</div><div class="line">make &amp; make install</div></pre></td></tr></table></figure></p>
<p>###二、安装gcc 4.8.1</p>
<p>####1、下载gcc 4.8.1源码包：<br><a href="http://ftp.tsukuba.wide.ad.jp/software/gcc/releases/gcc-4.8.1/gcc-4.8.1.tar.bz2" target="_blank" rel="external">http://ftp.tsukuba.wide.ad.jp/software/gcc/releases/gcc-4.8.1/gcc-4.8.1.tar.bz2</a><br>我是虚拟机里面装的Linux，我嫌wget太慢，所以自己在Windows上用迅雷下好，然后共享到Linux中。</p>
<p>####2、解压：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -jxvf gcc-4.8.1.tar.bz2</div></pre></td></tr></table></figure></p>
<p>####3、下载编译所需的依赖包：<br>这个步骤有两种方式完成：<br>a) 如果Linux有网络连接，直接这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> gcc-4.8.1</div><div class="line">./contrib/download_prerequisites</div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure></p>
<p>b) 如果Linux没有网络连接（我主机和虚拟机是Host-only，不能联网，所以另外想办法），则用Windows上网下载这几个包：<br>ftp://ftp.gnu.org/gnu/gmp/gmp-4.3.2.tar.bz2<br><a href="http://www.mpfr.org/mpfr-2.4.2/mpfr-2.4.2.tar.bz2" target="_blank" rel="external">http://www.mpfr.org/mpfr-2.4.2/mpfr-2.4.2.tar.bz2</a><br><a href="http://www.multiprecision.org/mpc/download/mpc-0.8.1.tar.gz" target="_blank" rel="external">http://www.multiprecision.org/mpc/download/mpc-0.8.1.tar.gz</a><br>有人问，一定要下载几个版本吗？下载最新的版本行不行？我没试过，也不知道，我是按照gcc-4.8.1/contrib/download_prerequisites脚本里面的版本下载的。既然里面已经说了这几个版本，那我就严格按照它的要求来做。<br>然后解压并移动到gcc-4.8.1下面：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tar -xjf gmp-4.3.2.tar.bz2</div><div class="line">tar -xjf mpfr-2.4.2.tar.bz2</div><div class="line">tar -xzf mpc-0.8.1.tar.gz</div><div class="line">mv gmp-4.3.2 gcc-4.8.1/gmp</div><div class="line">mv mpfr-2.4.2 gcc-4.8.1/mpfr</div><div class="line">mv mpc-0.8.1 gcc-4.8.1/mpc</div></pre></td></tr></table></figure></p>
<p>这样的做法好处是，不用单独编译gmp、mpfr和mpc三个包，放在gcc源码下面一起编译（事实上这也是gcc-4.8.1/contrib/download_prerequisites脚本的做法，个人感觉更简洁些）。</p>
<p>####4、新建目录用于存放编译结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir gcc-build-4.8.1</div></pre></td></tr></table></figure></p>
<p>####5、进入新目录，并执行configure命令，产生makefile：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> gcc-build-4.8.1</div><div class="line">../gcc-4.8.1/configure --enable-checking=release --enable-languages=c,c++ --disable-multilib</div></pre></td></tr></table></figure></p>
<p>具体选项不多解释，大家可以自己查看，我只用到c和c++，所以只编译这两种语言的编译器。</p>
<p>####6、编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make -j4</div></pre></td></tr></table></figure></p>
<p>我是i5四核，所以开4个线程同时编译，要是有8核就更爽了~我在虚拟机里面花了30分钟不到的时间，不算太慢了。</p>
<p>####7、安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo make install</div></pre></td></tr></table></figure></p>
<p>####8、大功告成，检查版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">g++ --version</div><div class="line">g++ (GCC) 4.8.1</div><div class="line">Copyright (C) 2013 Free Software Foundation, Inc.</div><div class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions. There is NO</div><div class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</div></pre></td></tr></table></figure></p>
<p>###三、编译安装<br>下载mariadb源码mariadb-10.0.14.tar.gz<br> <a href="https://downloads.mariadb.org/mariadb/10.0.14/" target="_blank" rel="external">https://downloads.mariadb.org/mariadb/10.0.14/</a></p>
<p>首先需要修改tokudb的cmake编译文件，去掉fuse-linker-plugin相关内容<br>修改mariadb-10.0.14/storage/tokudb/ft-index/cmake_modules/TokuSetupCompiler.cmake<br>去掉所有的 -fuse-linker-plugin ：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  set(CMAKE_C_FLAGS_RELWITHDEBINFO "-flto -fuse-linker-plugin $&#123;CMAKE_C_FLAGS_RELWITHDEBINFO&#125; -g -O3 -UNDEBUG")</span></div><div class="line"><span class="comment">#  set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "-flto -fuse-linker-plugin $&#123;CMAKE_CXX_FLAGS_RELWITHDEBINFO&#125; -g -O3 -UNDEBUG")</span></div><div class="line"><span class="comment">#  set(CMAKE_C_FLAGS_RELEASE "-g -O3 -flto -fuse-linker-plugin $&#123;CMAKE_C_FLAGS_RELEASE&#125; -UNDEBUG")</span></div><div class="line"><span class="comment">#  set(CMAKE_CXX_FLAGS_RELEASE "-g -O3 -flto -fuse-linker-plugin $&#123;CMAKE_CXX_FLAGS_RELEASE&#125; -UNDEBUG")</span></div><div class="line"><span class="comment">#  set(CMAKE_EXE_LINKER_FLAGS "-g -fuse-linker-plugin $&#123;CMAKE_EXE_LINKER_FLAGS&#125;")</span></div><div class="line"><span class="comment">#  set(CMAKE_SHARED_LINKER_FLAGS "-g -fuse-linker-plugin $&#123;CMAKE_SHARED_LINKER_FLAGS&#125;")</span></div><div class="line"></div><div class="line">  <span class="built_in">set</span>(CMAKE_C_FLAGS_RELWITHDEBINFO <span class="string">"-flto  <span class="variable">$&#123;CMAKE_C_FLAGS_RELWITHDEBINFO&#125;</span> -g -O3 -UNDEBUG"</span>)</div><div class="line">  <span class="built_in">set</span>(CMAKE_CXX_FLAGS_RELWITHDEBINFO <span class="string">"-flto <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELWITHDEBINFO&#125;</span> -g -O3 -UNDEBUG"</span>)</div><div class="line">  <span class="built_in">set</span>(CMAKE_C_FLAGS_RELEASE <span class="string">"-g -O3 -flto  <span class="variable">$&#123;CMAKE_C_FLAGS_RELEASE&#125;</span> -UNDEBUG"</span>)</div><div class="line">  <span class="built_in">set</span>(CMAKE_CXX_FLAGS_RELEASE <span class="string">"-g -O3 -flto  <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELEASE&#125;</span> -UNDEBUG"</span>)</div><div class="line">  <span class="built_in">set</span>(CMAKE_EXE_LINKER_FLAGS <span class="string">"-g  <span class="variable">$&#123;CMAKE_EXE_LINKER_FLAGS&#125;</span>"</span>)</div><div class="line">  <span class="built_in">set</span>(CMAKE_SHARED_LINKER_FLAGS <span class="string">"-g  <span class="variable">$&#123;CMAKE_SHARED_LINKER_FLAGS&#125;</span>"</span>)</div></pre></td></tr></table></figure></p>
<p>然后是/home/gao-compile/mariadb-10.0.14/storage/tokudb/CMakeLists.txt<br>去掉所有的 -fuse-linker-plugin ：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#SET(CMAKE_MODULE_LINKER_FLAGS_RELEASE "$&#123;CMAKE_MODULE_LINKER_FLAGS_RELEASE&#125; -flto -fuse-linker-plugin")</span></div><div class="line"><span class="comment">#SET(CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO "$&#123;CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO&#125; -flto -fuse-linker-plugin")</span></div><div class="line"></div><div class="line">SET(CMAKE_MODULE_LINKER_FLAGS_RELEASE <span class="string">"<span class="variable">$&#123;CMAKE_MODULE_LINKER_FLAGS_RELEASE&#125;</span> -flto"</span>)</div><div class="line">SET(CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO <span class="string">"<span class="variable">$&#123;CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO&#125;</span> -flto"</span>)</div></pre></td></tr></table></figure></p>
<p>然后进行编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> mariadb-10.0.14</div><div class="line">mkdir release</div><div class="line">./BUILD/compile-pentium64-max --prefix=/home/gao-compile/mariadb-10.0.14/release</div><div class="line">make install</div></pre></td></tr></table></figure></p>
<p>然后在/home/gao-compile/mariadb-10.0.14/release/lib/plugin 目录中找到 ha_tokudb.so动态库。<br>这个就是我们要的东西了！</p>
<p>注：其实可以直接在mariadb-10.0.14/storage/tokudb目录中直接进行编译，而不用去编译整个mariadb，因为编译出来的也无法使用， mysqld可执行程序依赖GLIBCXX_3.4.15<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@GXX release]<span class="comment"># ldd bin/mysqld</span></div><div class="line">bin/mysqld: /usr/lib64/libstdc++.so.6: version `GLIBCXX_3.4.15<span class="string">' not found (required by bin/mysqld)</span></div></pre></td></tr></table></figure></p>
<p>在mariadb官网<a href="https://downloads.mariadb.org/mariadb/10.0.14/下载带有mariadb的二进制包。从mariadb官网下载10.0.14的不带tokudb的可执行程序tar包，然后将我们编译好的tokudb.so拷贝到" target="_blank" rel="external">https://downloads.mariadb.org/mariadb/10.0.14/下载带有mariadb的二进制包。从mariadb官网下载10.0.14的不带tokudb的可执行程序tar包，然后将我们编译好的tokudb.so拷贝到</a><br>[maradb10.0.14]/lib/plugin/下<br>我这里下载的包，10.0.14<br>mariadb-10.0.14-linux-x86_64.tar.gz </p>
<p>###四、初始化</p>
<p>####1、前期账号创建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell&gt; groupadd mysql</div><div class="line">shell&gt; useradd -g mysql mysql</div></pre></td></tr></table></figure></p>
<p>####2、解压软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell&gt; <span class="built_in">cd</span> /usr/<span class="built_in">local</span></div><div class="line">shell&gt; tar -zxvf mariadb-10.0.14-linux-x86_64.tar.gz</div><div class="line">shell&gt; ln <span class="_">-s</span> mariadb-10.0.14-linux-x86_64 mysql</div></pre></td></tr></table></figure></p>
<p>####3、设置权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell&gt; <span class="built_in">cd</span> mysql</div><div class="line">shell&gt; chown -R mysql .</div><div class="line">shell&gt; chgrp -R mysql .</div></pre></td></tr></table></figure></p>
<p>####4、创建配置文件/etc/my.cnf<br>创建存放数据源的目录<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Shell&gt; mkdir -p /<span class="keyword">var</span>/lib/mysql</div><div class="line">Shell&gt; mkdir -p /data/mysqldata /data/mysqllog</div><div class="line">Shell&gt; chown -R mysql:mysql /<span class="keyword">var</span>/lib/mysql /data/mysqldata /data/mysqllog</div></pre></td></tr></table></figure></p>
<p>在附件中给出，请参考附配置文件内容</p>
<p>####5、初始化DB<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Shell&gt; scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf</div><div class="line">shell&gt; chown -R root .</div></pre></td></tr></table></figure></p>
<p>####6、修改系统参数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</div></pre></td></tr></table></figure></p>
<p>建议写到 /etc/rc.local 中，重启后也可生效</p>
<p>####7、启动数据库<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; bin/mysqld_safe --user=mysql &amp;</div></pre></td></tr></table></figure></p>
<p>####8、把启动文件放去自启动中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</div><div class="line">chkconfig --add mysqld</div><div class="line">service mysqld start</div><div class="line">service mysqld stop</div></pre></td></tr></table></figure></p>
<p>####9、安装tokudb支持<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">INSTALL SONAME <span class="string">'ha_tokudb'</span>;</div></pre></td></tr></table></figure></p>
<p>查看是否支持<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; show engines</div><div class="line">    -&gt; ;</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</div><div class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</div><div class="line">| MRG_MyISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</div><div class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</div><div class="line">| MEMORY             | YES     | Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</div><div class="line">| TokuDB             | YES     | Tokutek TokuDB Storage Engine with Fractal Tree(tm) Technology             | YES          | YES  | YES        |</div><div class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</div><div class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</div><div class="line">| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |</div><div class="line">| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |</div><div class="line">| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |</div><div class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</div><div class="line">11 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.11 sec)</div></pre></td></tr></table></figure></p>
<p>看到上面一行红字就代表数据库支持TokuDB的存储引擎了。</p>
<p>tokudb安装顺利完成，后附配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[root@localhost mysql]<span class="comment"># cat /etc/my.cnf </span></div><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">user=mysql</div><div class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></div><div class="line">symbolic-links=0</div><div class="line"><span class="comment">#public</span></div><div class="line">max_connections=3000</div><div class="line">max_connect_errors=6000</div><div class="line">key_buffer_size = 384M</div><div class="line">low_priority_updates = 1</div><div class="line">back_log = 1500</div><div class="line">query_cache_type = 1</div><div class="line">query_cache_size = 64M</div><div class="line">query_cache_limit = 4M</div><div class="line">query_cache_min_res_unit = 2k</div><div class="line">tmp_table_size = 256M</div><div class="line">read_buffer_size=1M</div><div class="line">read_rnd_buffer_size = 16M</div><div class="line">bulk_insert_buffer_size = 64M</div><div class="line">max_allowed_packet = 64M</div><div class="line">thread_cache_size = 300</div><div class="line"><span class="comment">#file</span></div><div class="line">innodb_file_per_table</div><div class="line"><span class="comment">#buffer</span></div><div class="line">innodb_buffer_pool_size = 2500M</div><div class="line">innodb_log_buffer_size = 64M</div><div class="line">join_buffer_size = 16M</div><div class="line">sort_buffer_size = 16M</div><div class="line">innodb_max_dirty_pages_pct = 90</div><div class="line">innodb_lock_wait_timeout = 120</div><div class="line">innodb_thread_concurrency = 16</div><div class="line">innodb_flush_log_at_trx_commit = 2</div><div class="line">character_set_server=utf8</div><div class="line">init_connect=<span class="string">'SET NAMES utf8'</span></div><div class="line"></div><div class="line"><span class="comment">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></div><div class="line">tokudb_data-dir = /data/mysqldata</div><div class="line">tokudb_log-dir = /data/mysqllog</div><div class="line"><span class="comment">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></div><div class="line">tokudb_row_format = tokudb_small</div><div class="line">tokudb_row_format = tokudb_fast</div><div class="line">tokudb_cache_size = 2G</div><div class="line"><span class="comment">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></div><div class="line">tokudb_commit_sync = 0</div><div class="line">tokudb_directio = 1</div><div class="line">tokudb_read_block_size = 128K</div><div class="line">tokudb_read_buf_size = 128K</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</div><div class="line">pid-file=/var/run/mysqld/mysqld.pid</div></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/19/Drupal8主题-theme/" itemprop="url">
                  Drupal8主题(theme)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-19T16:35:16+08:00" content="2015-11-19">
              2015-11-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/19/Drupal8主题-theme/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/19/Drupal8主题-theme/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Drupal8中的Twig"><a href="#Drupal8中的Twig" class="headerlink" title="Drupal8中的Twig"></a>Drupal8中的Twig</h2><p>Drupal8中Twig替换了PHPTemplate作为默认的模板引擎，导致的结果之一就是模版的后缀由原来的.tpl.php变成了.html.twig</p>
<h3 id="搜索Twig模版中的变量"><a href="#搜索Twig模版中的变量" class="headerlink" title="搜索Twig模版中的变量"></a>搜索Twig模版中的变量</h3><p>在使用Twig模版的时候，大部分的变量都已注释的形式写在了模版中。然后，当我们新增了变量，我们就需要一个可以搜索到当前模版所有变量的方法。Twig提供了<code>dump</code>函数。</p>
<p><code>dump</code>函数并不会打印所有的输出，除非开启了debug。</p>
<p><code>dump</code>函数用于打印单个变量的信息或者模版中的所有变量。</p>
<h4 id="单个变量"><a href="#单个变量" class="headerlink" title="单个变量"></a>单个变量</h4><p>如果你的模版中有一个title变量，下面在你的模版中dump出这个变量的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; dump(title) &#125;&#125;</div></pre></td></tr></table></figure>
<h4 id="模版中的所有变量"><a href="#模版中的所有变量" class="headerlink" title="模版中的所有变量"></a>模版中的所有变量</h4><p>要打印出模版中的所有的变量，你可以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; dump() &#125;&#125;</div></pre></td></tr></table></figure>
<p>要打印出变量的键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; dump(_context|keys) &#125;&#125;</div></pre></td></tr></table></figure>
<p>PS: 这里的_context是一全局变量，指当前模版中所有的上下文和变量，比如通过theme函数传递的变量，preprocess函数处理的变量，或者调用set设置的变量。</p>
<p><strong>全局变量：</strong></p>
<ul>
<li>_context 当前模版中所有的上下文和变量</li>
<li>_charset 只当前的编码方式</li>
</ul>
<h4 id="慎用dump"><a href="#慎用dump" class="headerlink" title="慎用dump()"></a>慎用dump()</h4><p><code>dump()</code>函数虽然可以输出所有的变量，但是却带来了巨大的内存消耗，故你可以循环<code>_context</code>来查看所有的键：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ol&gt;</div><div class="line">  &#123;% for key, value in _context  %&#125;</div><div class="line">    &lt;li&gt;&#123;&#123; key &#125;&#125;&lt;/li&gt;</div><div class="line">  &#123;% endfor %&#125;</div><div class="line">&lt;/ol&gt;</div></pre></td></tr></table></figure>
<p>接下来再加上一些条件判断，就可以看到你需要的变量了。</p>
<h2 id="Drupal8主题"><a href="#Drupal8主题" class="headerlink" title="Drupal8主题"></a>Drupal8主题</h2><h3 id="模版命名惯例"><a href="#模版命名惯例" class="headerlink" title="模版命名惯例"></a>模版命名惯例</h3><p>Drupal是按照一定的命名惯例来加载模版的，这就方便开发者可以覆盖原有的模版。当然，记得清除缓存。</p>
<h4 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h4><p>HTML模版提供了包括head，title以及body标签等基础结构的html页面。</p>
<p>基础模版：html.html.twig(位于：core/modules/system/templates/html.html.twig)</p>
<p>下面是一些你可以覆盖的基础模版的例子：</p>
<ol>
<li>html–internalviewpath.html.twig</li>
<li>html–node–id.html.twig</li>
<li>html.html.twig</li>
</ol>
<h4 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h4><p>模版名称模式：page–[front|internal/path].html.twig</p>
<p>基础模版：page.html.twig(位于: core/modules/system/templates/page.html.twig)</p>
<p>下面是page模版的模版建议，举个例子“<a href="http://www.example.com/node/1/edit”：" target="_blank" rel="external">http://www.example.com/node/1/edit”：</a></p>
<ol>
<li>page–node–edit.html.twig</li>
<li>page–node–1.html.twig</li>
<li>page–node.html.twig</li>
<li>page.html.twig</li>
</ol>
<h4 id="Regions"><a href="#Regions" class="headerlink" title="Regions"></a>Regions</h4><p>模版名称模式：region–[region].html.twig</p>
<p>基础模版：region.html.twig(位于: core/modules/system/templates/region.html.twig)</p>
<p>当一个页面的区域中有内容时，系统会从区块系统或者一个类似于<code>hook_page_build()</code>的方法中调用区域模版。</p>
<h4 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h4><p>模版名称模式：block–[module|-delta]].html.twig</p>
<p>基础模版：block.html.twig (位于: core/modules/block/templates/block.html.twig)</p>
<ol>
<li>block–module–delta.html.twig</li>
<li>block–module.html.twig</li>
<li>block.html.twig</li>
</ol>
<p>这里的module就是模块名，delta是模块给区块设置的内部id标识</p>
<h4 id="Nodes"><a href="#Nodes" class="headerlink" title="Nodes"></a>Nodes</h4><p>模版名称模式：node–[type|nodeid]–[viewmode].html.twig<br>基础模版：node.html.twig (位于: core/modules/node/templates/node.html.twig)</p>
<p>模版建议：</p>
<ol>
<li>node–nodeid–viewmode.html.twig</li>
<li>node–nodeid.html.twig</li>
<li>node–type–viewmode.html.twig</li>
<li>node–type.html.twig</li>
<li>node–viewmode.html.twig</li>
<li>node.html.twig</li>
</ol>
<h4 id="Forums"><a href="#Forums" class="headerlink" title="Forums"></a>Forums</h4><p>模版名称模式：forums–[[container|topic]–forumID].html.twig</p>
<p>基础模版： forums.html.twig (位于: core/modules/forum/templates/forums.html.twig)</p>
<p>模版建议：</p>
<ul>
<li><p>论坛容器：</p>
<ol>
<li>forums–containers–forumID.html.twig</li>
<li>forums–forumID.html.twig</li>
<li>forums–containers.html.twig</li>
<li>forums.html.twig</li>
</ol>
</li>
<li><p>论坛主题内容</p>
<ol>
<li>forums–topics–forumID.html.twig</li>
<li>forums–forumID.html.twig</li>
<li>forums–topics.html.twig</li>
<li>forums.html.twig</li>
</ol>
</li>
</ul>
<h3 id="PHPTemplate与Twig主题范例的比较"><a href="#PHPTemplate与Twig主题范例的比较" class="headerlink" title="PHPTemplate与Twig主题范例的比较"></a>PHPTemplate与Twig主题范例的比较</h3><p>接下来，看下PHPTemplate与Twig的区别。</p>
<h4 id="关于Twig"><a href="#关于Twig" class="headerlink" title="关于Twig"></a>关于Twig</h4><p>Twig是基于php的编译模版语言。当你的页面需要渲染显示的时候，Twig引擎会找到对应的模版并把它编译成php模版，存放在sites/default/files/php_storage/目录下。</p>
<h5 id="1-Docblock"><a href="#1-Docblock" class="headerlink" title="1.Docblock"></a>1.Docblock</h5><p>PHPTemplate：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php </div><div class="line">/** </div><div class="line"> * @file</div><div class="line"> * File description</div><div class="line"> */</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>Twig：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;# </div><div class="line">/** </div><div class="line"> * @file</div><div class="line"> * File description</div><div class="line"> */</div><div class="line">#&#125;</div></pre></td></tr></table></figure>
<h5 id="2-文件和函数名"><a href="#2-文件和函数名" class="headerlink" title="2.文件和函数名"></a>2.文件和函数名</h5><p>PHPTemplate文件：node–article.tpl.php<br>Twig文件：node–article.html.twig</p>
<p>PHPTemplate函数：theme_node_links()<br>Twig文件：node-links.html.twig</p>
<h5 id="3-变量"><a href="#3-变量" class="headerlink" title="3.变量"></a>3.变量</h5><p><strong>输出一个变量</strong></p>
<p>PHPTemplate: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;content&quot;&gt;&lt;?php print $content; ?&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;content&quot;&gt;&#123;&#123; content &#125;&#125;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>输出一个哈希键值</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php print $item[&apos;#item&apos;][&apos;alt&apos;]; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; item[&apos;#item&apos;].alt &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>变量赋值</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php $custom_var = $content-&gt;comments; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% set custom_var = content.comments %&#125;</div></pre></td></tr></table></figure>
<p><strong>数组初始化</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  $args = array(&apos;!author&apos; =&gt; $author, &apos;!date&apos; =&gt; $created);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% set args = &#123;&apos;!author&apos;: author, &apos;!date&apos;: created&#125; %&#125;</div></pre></td></tr></table></figure>
<h5 id="4-条件判断"><a href="#4-条件判断" class="headerlink" title="4.条件判断"></a>4.条件判断</h5><p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php if ($content-&gt;comments): endif; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% if content.comments %&#125; &#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php if (!empty($content-&gt;comments)): endif; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% if content.comments is not empty %&#125; &#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php if (isset($content-&gt;comments)): endif; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% if content.comments is defined %&#125; &#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php if ($count &gt; 0): endif; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% if count &gt; 0 %&#125; &#123;% endif %&#125;</div></pre></td></tr></table></figure>
<h5 id="5-控制结构"><a href="#5-控制结构" class="headerlink" title="5.控制结构"></a>5.控制结构</h5><p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php foreach ($users as $user) &#123;&#125; ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% for user in users %&#125; &#123;% endfor %&#125;</div></pre></td></tr></table></figure>
<h5 id="6-过滤"><a href="#6-过滤" class="headerlink" title="6.过滤"></a>6.过滤</h5><p><strong>check_plain：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php print check_plain($title); ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; title|striptags &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>Translate：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php print t(&apos;Home&apos;); ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; &apos;Home&apos;|t &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>Translate with substitutions:</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  print t(&apos;Welcome, @username&apos;, array(&apos;@username&apos; =&gt; $user-&gt;name));</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; &apos;Welcome, @username&apos;|t(&#123; &apos;@username&apos;: user.name &#125;) &#125;&#125;</div></pre></td></tr></table></figure>
<p>Drupal8 Twig(采用<a href="https://drupal.org/node/2047135" target="_blank" rel="external">trans</a>标签扩展)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;% set username = user.name %&#125;</div><div class="line">&#123;% trans %&#125;</div><div class="line">  Welcome, &#123;&#123; username &#125;&#125;</div><div class="line">&#123;% endtrans %&#125;</div></pre></td></tr></table></figure>
<p><strong>implode:</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php echo implode(&apos;, &apos;, $usernames); ?&gt;</div></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; usernames | join(&apos;, &apos;) &#125;&#125;</div></pre></td></tr></table></figure>
<p>PHPTemplate的例子中$usernames需要是一个字符串数组。原生的Twig也需要$usernames是一个字符串数组。但是Drupal8中的twig还可以是一个可以渲染的数组对象。这就是Drupal8中的twig与原生twig的本质区别。Drupal8中的twig可以“打印”出纯文本和可渲染的数组。</p>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;% set numbers = [&#123;&apos;#markup&apos;: &apos;One&apos;&#125;, &#123;&apos;#markup&apos;:&apos;Two&apos;&#125;, &#123;&apos;#markup&apos;:&apos;Three&apos;&#125;] %&#125;</div><div class="line">&#123;&#123; numbers &#125;&#125;</div></pre></td></tr></table></figure>
<p>在上面的例子中，每一个数据项都是以逗号相隔的。但是，输出的结果却是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OneTwoThree</div></pre></td></tr></table></figure>
<p><strong>Escape：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php echo check_plain($title); ?&gt;</div></pre></td></tr></table></figure>
<p>原生Twig:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; title|e &#125;&#125;</div></pre></td></tr></table></figure>
<p>Drupal 8 Twig2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; title &#125;&#125;</div></pre></td></tr></table></figure>
<h5 id="7-空白"><a href="#7-空白" class="headerlink" title="7.空白"></a>7.空白</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;body&quot;&gt;</div><div class="line">  &#123;&#123;- block.content -&#125;&#125;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>类似于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;body&quot;&gt;&#123;&#123; block.content &#125;&#125;&lt;/div&gt;</div></pre></td></tr></table></figure>
<h3 id="debug-twig模版"><a href="#debug-twig模版" class="headerlink" title="debug twig模版"></a>debug twig模版</h3><p>twig模版引擎提供了一个debug工具。</p>
<h4 id="启用debugging"><a href="#启用debugging" class="headerlink" title="启用debugging"></a>启用debugging</h4><p>在sites/default/services.yml启用Twig Debugging。</p>
<p>设置debug变量为true</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">parameters:</div><div class="line">  twig.config:</div><div class="line">    debug: true</div></pre></td></tr></table></figure>
<h4 id="自动加载编译的模版"><a href="#自动加载编译的模版" class="headerlink" title="自动加载编译的模版"></a>自动加载编译的模版</h4><p>出于性能考虑，Twig模版被编译成一个PHP类存放在磁盘上，但这意味着默认情况下，你的模版不会在你做出更改时发生刷新。为了使Twig模版可以自动刷新，启用<code>services.yml</code>中的deubg选项。欲知详情，参见：<a href="https://drupal.org/node/1903374" target="_blank" rel="external">https://drupal.org/node/1903374</a></p>
<p><strong>打印所有的变量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;# 打印所有的变量 #&#125;</div><div class="line">&#123;&#123; dump() &#125;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;# 打印单个变量 #&#125;</div><div class="line">&#123;&#123; dump(var) &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="Filters—修改Twig模版中的变量"><a href="#Filters—修改Twig模版中的变量" class="headerlink" title="Filters—修改Twig模版中的变量"></a>Filters—修改Twig模版中的变量</h3><p>Twig中的Filters用于修改变量。Filters和变量之间用管道符号(|)分隔，还可能带点可选的参数。多个filters可以链式的连在一起，前一个的输出作为下一个的输入。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; ponies|safe_join(&quot;, &quot;)|lower&#125;&#125;</div></pre></td></tr></table></figure>
<p>Drupal的Twig模版中使用的filter由所有的Twig引擎自带的filter和drupal中的几个特殊的filters组成。</p>
<h4 id="Twig-filters"><a href="#Twig-filters" class="headerlink" title="Twig filters"></a>Twig filters</h4><p>详见：<a href="http://twig.sensiolabs.org/doc/filters/index.html" target="_blank" rel="external">twig filter列表</a></p>
<h4 id="Drupal自身的filters"><a href="#Drupal自身的filters" class="headerlink" title="Drupal自身的filters"></a>Drupal自身的filters</h4><p>Drupal中的filters是在<code>Drupal\Core\Template\TwigExtension::getFilters().</code>中声明的。</p>
<h5 id="翻译filters"><a href="#翻译filters" class="headerlink" title="翻译filters"></a>翻译filters</h5><p><strong>t</strong></p>
<p>t filter调用Drupal的t函数翻译给定的字符串，可用于任何字符串。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;&#123;&#123; url(&apos;&lt;front&gt;&apos;) &#125;&#125;&quot; title=&quot;&#123;&#123; &apos;Home&apos;|t &#125;&#125;&quot; rel=&quot;home&quot; class=&quot;site-logo&quot;&gt;&lt;/a&gt;</div></pre></td></tr></table></figure>
<p>placeholder输出安全的html并使用<code>drupal_placeholder()</code>进行格式化输出成强调文本。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;% trans %&#125;Submitted on &#123;&#123; date|placeholder &#125;&#125;&#123;% endtrans %&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; var1|t &#125;&#125;</div><div class="line">&#123;&#123; var1|placeholder &#125;&#125;</div><div class="line">&#123;% trans %&#125;&#123;&#123; var1 &#125;&#125;&#123;% endtrans %&#125;</div></pre></td></tr></table></figure>
<p>尽可能避免使用|raw filter，特别是你正在输出一些用户输入的数据的时候。详见<a href="https://www.drupal.org/node/2296163" target="_blank" rel="external">https://www.drupal.org/node/2296163</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; var1|raw &#125;&#125;</div></pre></td></tr></table></figure>
<h5 id="额外的filters"><a href="#额外的filters" class="headerlink" title="额外的filters"></a>额外的filters</h5><p><strong>drupal_escape</strong></p>
<p>drupal_escape用于将一个字符串进行安全处理后进行插入操作并输出显示，它替代了twig默认的escape filter。参见<a href="https://api.drupal.org/api/drupal/core%21themes%21engines%21twig%21twig.engine/function/twig_drupal_escape_filter/8" target="_blank" rel="external">twig_drupal_escape_filter</a></p>
<p><strong>safe_join</strong></p>
<p>safe_join将几个字符串用给定的分隔符连接在一块儿。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; items|safe_join(&apos;, &apos;) &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>without</strong></p>
<p>without会创建出当前这个可以渲染的数组的拷贝，但是会把传入的参数当作键，删除键关联的所有子元素。但是，当前这个数组不受影响，依旧可以打印出子元素。详见：<a href="https://api.drupal.org/api/drupal/core%21themes%21engines%21twig%21twig.engine/function/twig_without/8" target="_blank" rel="external">twig_without</a></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;# 打印content变量，除了content.links #&#125;</div><div class="line">&#123;&#123; content|without(&apos;links&apos;) &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>clean_class</strong></p>
<p>clean_class filter会处理出一个安全的可用的html类名。详见：<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Html.php/function/Html%3A%3AgetClass/8" target="_blank" rel="external">Html::getClass()</a></p>
<p><strong>clean_id</strong></p>
<p>clean_id filter会处理出一个安全的可用的html id。详见：<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Html.php/function/Html%3A%3AgetId/8" target="_blank" rel="external">Html:getID()</a></p>
<p><strong>format_date</strong></p>
<p>format_date filter格式化日期字符串，详见：<a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Datetime!DateFormatter.php/function/DateFormatter%3A%3Aformat/8" target="_blank" rel="external">DateFormatter::format()</a></p>
<h3 id="Functions—Twig模版中的函数"><a href="#Functions—Twig模版中的函数" class="headerlink" title="Functions—Twig模版中的函数"></a>Functions—Twig模版中的函数</h3><p><strong>url()</strong></p>
<p><strong>path()</strong></p>
<p><strong>url_from_path()</strong></p>
<p><strong>link($text, $url, $attributes)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; link(item.title, item.url, &#123; &apos;class&apos;:[&apos;foo&apos;, &apos;bar&apos;, &apos;baz&apos;]&#125; ) &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>file_url($uri)</strong></p>
<p>路径参数需要是相对网站根目录的相对路径，将会返回这个文件的绝对路径。</p>
<p><strong>attach_library()</strong></p>
<h3 id="Twig最佳实践—预处理函数和模版"><a href="#Twig最佳实践—预处理函数和模版" class="headerlink" title="Twig最佳实践—预处理函数和模版"></a>Twig最佳实践—预处理函数和模版</h3><p>为了使Drupal8的主题性能最大化，以及更加的定制化，请遵照如下的最佳实践方式：</p>
<h4 id="使用预处理函数返回可渲染数组"><a href="#使用预处理函数返回可渲染数组" class="headerlink" title="使用预处理函数返回可渲染数组"></a>使用预处理函数返回可渲染数组</h4><p>总是通过预处理函数返回可渲染数组，而不是调用<code>theme()</code>或者<code>drupal_render()</code>函数。</p>
<p>Twig会自动渲染，故没有必要调用<code>theme()</code>或者<code>drupal_render()</code>函数。此外，为了比直接输出已经渲染的html代码更具定制化，渲染数组应该传递给模版。</p>
<p>从预处理函数中删除<code>theme()</code>函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 之前，直接把渲染的html传递给模版</div><div class="line">$variables[&apos;table&apos;] = theme(&apos;table&apos;, array(&apos;header&apos; =&gt; $header, &apos;rows&apos; =&gt; $rows));</div><div class="line"></div><div class="line">// 之后，把渲染数组传递给模版</div><div class="line">$variables[&apos;table&apos;] = array(</div><div class="line">  &apos;#theme&apos; =&gt; &apos;table&apos;,</div><div class="line">  &apos;#header&apos; =&gt; $header,</div><div class="line">  &apos;#rows&apos; =&gt; $rows,</div><div class="line">);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>从预处理函数中删除<code>drupal_render()</code>函数就是不再调用它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 之前</div><div class="line">$variables[&apos;teaser&apos;] = drupal_render($node_teaser);</div><div class="line"></div><div class="line">// 之后</div><div class="line">$variables[&apos;teaser&apos;] = $node_teaser;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>通常情况下，<code>drupal_render()</code>函数是在添加表格数据的时候调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 之前</div><div class="line">$row[] = drupal_render($display[&apos;title&apos;]);</div><div class="line"></div><div class="line">// 之后  </div><div class="line">$row[][&apos;data&apos;] = $display[&apos;title&apos;];</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="在模版中调用filters和工具函数"><a href="#在模版中调用filters和工具函数" class="headerlink" title="在模版中调用filters和工具函数"></a>在模版中调用filters和工具函数</h4><p>举个例子：</p>
<p><strong>之前的做法：</strong></p>
<p>预处理函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$variables[&apos;no_content_text&apos;] = t(&apos;You have not created any content types yet. Go to the &lt;a href=&quot;@create-content&quot;&gt;content type creation page&lt;/a&gt; to add a new content type.&apos;, array(&apos;@create-content&apos; =&gt; url(&apos;admin/structure/types/add&apos;)));</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>模版中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;&#123;&#123; no_content_text &#125;&#125;&lt;/p&gt;</div></pre></td></tr></table></figure>
<p><strong>现在的做法：</strong></p>
<p>模版中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;&#123;&#123; &apos;You have not created any content types yet. Go to the &lt;a href=&quot;@create-content&quot;&gt;content type creation page&lt;/a&gt; to add a new content type.&apos;|t(&#123;&apos;@create-content&apos;: url(&apos;admin/structure/types/add&apos;)&#125;) &#125;&#125;&lt;/p&gt;</div></pre></td></tr></table></figure>
<h4 id="显示-隐藏-amp-删除drupal-render-children和element-children"><a href="#显示-隐藏-amp-删除drupal-render-children和element-children" class="headerlink" title="显示/隐藏 &amp; 删除drupal_render_children和element_children"></a>显示/隐藏 &amp; 删除drupal_render_children和element_children</h4><p>在原始的模版中，如果调用了<code>hide()</code>函数，而且<code>drupal_render_children</code>函数用于输出”剩下的“数据，我们将需要在预处理的时候把这些数据拆分成单个变量。</p>
<p><strong>之前(PHPTemplate模版)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  hide($form[&apos;advanced&apos;]);</div><div class="line">  hide($form[&apos;actions&apos;]);</div><div class="line">?&gt;</div><div class="line">&lt;div class=&quot;layout-node-form clearfix&quot;&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-main&quot;&gt;</div><div class="line">    &lt;?php print drupal_render_children($form); ?&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-secondary&quot;&gt;</div><div class="line">    &lt;?php print render($form[&apos;advanced&apos;]); ?&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-footer&quot;&gt;</div><div class="line">    &lt;?php print render($form[&apos;actions&apos;]); ?&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>之后(预处理)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function template_preprocess_node_edit_form(&amp;$variables) &#123;</div><div class="line">  $form = $variables[&apos;form&apos;];</div><div class="line">  </div><div class="line">  // @todo Update this once drupal.org/node/1920886 is resolved.</div><div class="line">  $variables[&apos;advanced&apos;] = $form[&apos;advanced&apos;];</div><div class="line">  $variables[&apos;actions&apos;] = $form[&apos;actions&apos;];</div><div class="line">  unset($form[&apos;advanced&apos;], $form[&apos;actions&apos;]);</div><div class="line">  $variables[&apos;form&apos;] = drupal_render_children($form);</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p><strong>之后(Twig模版)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;layout-node-form clearfix&quot;&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-main&quot;&gt;</div><div class="line">    &#123;&#123; form|without(&apos;advanced&apos;, &apos;actions&apos;) &#125;&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-secondary&quot;&gt;</div><div class="line">    &#123;&#123; form.advanced &#125;&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=&quot;layout-region layout-region-node-footer&quot;&gt;</div><div class="line">    &#123;&#123; form.actions &#125;&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<h2 id="创建Drupal8的主题"><a href="#创建Drupal8的主题" class="headerlink" title="创建Drupal8的主题"></a>创建Drupal8的主题</h2><h3 id="以一个-info-yml文件开始定义一个主题"><a href="#以一个-info-yml文件开始定义一个主题" class="headerlink" title="以一个.info.yml文件开始定义一个主题"></a>以一个.info.yml文件开始定义一个主题</h3><p>创建drupal8主题的第一步，就是创建一个THEMENAME.info.yml文件。有一点很重要，.info.yml文件中的“type”键需要设置成“theme”。</p>
<h4 id="创建一个-info-yml文件"><a href="#创建一个-info-yml文件" class="headerlink" title="创建一个.info.yml文件"></a>创建一个.info.yml文件</h4><p>在主题文件夹的根目录创建.info.yml文件。文件夹的名字应该保持与.info.yml文件名相同。所以，如果你的主题命名为“Fluffiness”，那么文件夹的名字就是“fluffiness”，而.info.yml文件的名字是“fluffiness/fluffiness.info.yml”。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">name: Fluffiness</div><div class="line">type: theme</div><div class="line">description: A cuddly theme that offers extra fluffiness.</div><div class="line">core: 8.x</div><div class="line">libraries:</div><div class="line">  - fluffiness/global-styling</div><div class="line">stylesheets-remove:</div><div class="line">  - &apos;@classy/css/components/tabs.css&apos;</div><div class="line">  - core/assets/vendor/normalize-css/normalize.css</div><div class="line">regions:</div><div class="line">  header: Header</div><div class="line">  content: Content</div><div class="line">  sidebar_first: &apos;Sidebar first&apos;</div><div class="line">  footer: Footer</div></pre></td></tr></table></figure>
<p>在你的drupal站点中，核心提供的主题包含着很多.info.yml文件可以供你查阅实例。</p>
<h4 id="配置文件中的键释义"><a href="#配置文件中的键释义" class="headerlink" title="配置文件中的键释义"></a>配置文件中的键释义</h4><ul>
<li>name: Fluffiness  必选。显示在站点外观页面的，可读主题名</li>
<li>description: An extra cuddly Drupal theme available in grey and blue  必选，主题描述，也会显示在站点外观管理页面</li>
<li>type: theme  必选项，扩展类型，比如：module, theme 或者 profile。对于主题，这里设置成“theme”</li>
<li>base theme: classy  可以从另一个主题继承其资源的主题</li>
<li>core: 8.x  必选，当前主题兼容的Drupal版本</li>
<li>version: 8.x-1.0</li>
<li>screenshot: fluffiness.png</li>
<li><p>libraries:</p>
<ul>
<li><p>fluffiness/global-styling</p>
<p>当主题启用时，为所有的页面加载资源库文件，包括css和js</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">global-styling:</div><div class="line">  version: 1.x</div><div class="line">  css:</div><div class="line">    theme:</div><div class="line">      css/style.css: &#123;&#125;</div><div class="line">      css/print.css: &#123; media: print &#125;</div></pre></td></tr></table></figure>
<p>当html解析时，就会是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;css/style.css&quot; media=&quot;all&quot; /&gt;</div><div class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;css/print.css&quot; media=&quot;print&quot; /&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>stylesheets-remove:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- core/assets/vendor/normalize-css/normalize.css # 1</div><div class="line">- &apos;@classy/css/components/tabs.css&apos; # 2</div></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ol>
<li>stylesheets-remove键定义需要删除的样式，需要设置成完全路径。</li>
<li>为了方式Drupal核心的资源（例如，jQuery UI的css文件）被删除，请设置为完全路径。此外，为了避免当前这个文件属于某个模块或者主题提供的库的，可以使用token。注意，如果使用token，由于@会被当成YAML，请记得使用引号。</li>
</ol>
</li>
<li><p>regions:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">header: Header</div><div class="line">content: Content # required!</div><div class="line">sidebar_first: &apos;Sidebar first&apos;</div><div class="line">footer: Footer</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="主题文件夹的结构"><a href="#主题文件夹的结构" class="headerlink" title="主题文件夹的结构"></a>主题文件夹的结构</h3><p>主题就是定了视图层的许多文件的集合。.info.yml文件是必须的，下面会列出一个典型的主题文件夹中所包含的文件和文件夹。</p>
<h4 id="主题的位置"><a href="#主题的位置" class="headerlink" title="主题的位置"></a>主题的位置</h4><p>主题必须放置在Drupal安装根目录的“themes”文件夹中。注意，核心的主题，例如：Bartik和Seven位于core/themes文件夹下。</p>
<p>一个好的建议是，创建一个名为“contrib”的文件夹用于存放下载的贡献主题，而“custom”文件夹用于存放自定义的主题。</p>
<p>主体名称必须小写。</p>
<h4 id="Drupal的目录结构："><a href="#Drupal的目录结构：" class="headerlink" title="Drupal的目录结构："></a>Drupal的目录结构：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">|-core</div><div class="line">|  |-modules</div><div class="line">|  |-themes</div><div class="line">|  |  |-bartik</div><div class="line">|  |  |-seven</div><div class="line">..</div><div class="line">|-modules</div><div class="line">|-themes</div><div class="line">|  |-contrib</div><div class="line">|  |  |-zen</div><div class="line">|  |  |-basic</div><div class="line">|  |  |-bluemarine</div><div class="line">|  |-custom</div><div class="line">|  |  |-fluffiness</div></pre></td></tr></table></figure>
<h4 id="主题文件夹结构，假设主题名称是：fluffiness"><a href="#主题文件夹结构，假设主题名称是：fluffiness" class="headerlink" title="主题文件夹结构，假设主题名称是：fluffiness"></a>主题文件夹结构，假设主题名称是：fluffiness</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">|-fluffiness.breakpoints.yml</div><div class="line">|-fluffiness.info.yml</div><div class="line">|-fluffiness.libraries.yml</div><div class="line">|-fluffiness.theme</div><div class="line">|-config</div><div class="line">|  |-install</div><div class="line">|  |  |-fluffiness.settings.yml</div><div class="line">|  |-schema</div><div class="line">|  |  |-fluffiness.schema.yml</div><div class="line">|-css</div><div class="line">|  |-style.css</div><div class="line">|-js</div><div class="line">|  |-fluffiness.js</div><div class="line">|-images</div><div class="line">|  |-buttons.png</div><div class="line">|-logo.png</div><div class="line">|-screenshot.png</div><div class="line">|-templates</div><div class="line">|  |-maintenance-page.html.twig</div><div class="line">|  |-node.html.twig</div></pre></td></tr></table></figure>
<p>下面，介绍一下主题文件夹中的通用文件。</p>
<h4 id="info-yml"><a href="#info-yml" class="headerlink" title="*.info.yml"></a>*.info.yml</h4><p>主题必须包含*.info.yml文件，此文件定义了meta数据，样式，还有区块和区域信息。</p>
<h4 id="libraries-yml"><a href="#libraries-yml" class="headerlink" title="*.libraries.yml"></a>*.libraries.yml</h4><p>*.libraries.yml文件用于主题启用时需要加载的定义js和css库，详情<a href="https://www.drupal.org/theme-guide/8/adding-javascript" target="_blank" rel="external">点击这里</a></p>
<h4 id="breakpoints-yml"><a href="#breakpoints-yml" class="headerlink" title="*.breakpoints.yml"></a>*.breakpoints.yml</h4><p>响应式设计相关的设置，详见：<a href="https://www.drupal.org/documentation/modules/breakpoint" target="_blank" rel="external">*.breakpoints.yml设置</a></p>
<h4 id="theme"><a href="#theme" class="headerlink" title="*.theme"></a>*.theme</h4><p>*.theme文件是一个php文件，包含了所有的逻辑处理代码和输出前的预处理。</p>
<h4 id="css"><a href="#css" class="headerlink" title="css/"></a>css/</h4><p>一个好的建议就是将css文件存放在“css”自目录下。</p>
<h4 id="js"><a href="#js" class="headerlink" title="js/"></a>js/</h4><p>存放着主题需要的js文件。</p>
<h4 id="images"><a href="#images" class="headerlink" title="images/"></a>images/</h4><p>存放主题需要的图片</p>
<h4 id="screenshot-png"><a href="#screenshot-png" class="headerlink" title="screenshot.png"></a>screenshot.png</h4><p>主题的预览图</p>
<h4 id="templates"><a href="#templates" class="headerlink" title="templates/"></a>templates/</h4><h4 id="核心主题Bartik的目录结构："><a href="#核心主题Bartik的目录结构：" class="headerlink" title="核心主题Bartik的目录结构："></a>核心主题Bartik的目录结构：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">|-bartik.breakpoints.yml</div><div class="line">|-bartik.info.yml</div><div class="line">|-bartik.libraries.yml</div><div class="line">|-bartik.theme</div><div class="line">|-color</div><div class="line">|  |-color.inc</div><div class="line">|  |-preview.css</div><div class="line">|  |-preview.html</div><div class="line">|  |-preview.js</div><div class="line">|-config</div><div class="line">|  |-schema</div><div class="line">|  |  |-bartik.schema.yml</div><div class="line">|-css</div><div class="line">|  |-base</div><div class="line">|  |  |-elements.css</div><div class="line">|  |-components</div><div class="line">|  |  |-block.css</div><div class="line">|  |  |-book.css</div><div class="line">|  |  |-breadcrumb.css</div><div class="line">...</div><div class="line">|  |-colors.css</div><div class="line">|  |-layout.css</div><div class="line">|  |-maintenance-page.css</div><div class="line">|  |-print.css</div><div class="line">|-images</div><div class="line">|  |-add.png</div><div class="line">|  |-required.svg</div><div class="line">|  |-tabs-border.png</div><div class="line">|-logo.svg</div><div class="line">|-screenshot.png</div><div class="line">|-templates</div><div class="line">|  |-block--search-form-block.html.twig</div><div class="line">|  |-block--system-branding-block.html.twig</div><div class="line">|  |-block--system-menu-block.html.twig</div><div class="line">|  |-block.html.twig</div><div class="line">|  |-comment.html.twig</div><div class="line">|  |-field--taxonomy-term-reference.html.twig</div><div class="line">|  |-maintenance-page.html.twig</div><div class="line">|  |-node.html.twig</div><div class="line">|  |-page.html.twig</div><div class="line">|  |-status-messages.html.twig</div></pre></td></tr></table></figure>
<h3 id="为主题添加区域"><a href="#为主题添加区域" class="headerlink" title="为主题添加区域"></a>为主题添加区域</h3><p>为主题添加区域需要两步：</p>
<ul>
<li>在主题文件.info.yml中添加区域的meta-data</li>
<li>编辑page.html.twig文件打印新的区域</li>
</ul>
<h4 id="info文件中添加区域"><a href="#info文件中添加区域" class="headerlink" title="info文件中添加区域"></a>info文件中添加区域</h4><p>区域定义成ragions键的子元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Regions</div><div class="line">regions:</div><div class="line">  header: &apos;Header&apos;</div><div class="line">  content: &apos;Content&apos;</div><div class="line">  footer: &apos;Footer&apos;</div></pre></td></tr></table></figure>
<p>Region 键应是个字符串，可以包含下划线“_”。</p>
<h4 id="模版中添加区域"><a href="#模版中添加区域" class="headerlink" title="模版中添加区域"></a>模版中添加区域</h4><p>为了显示区域中的内容，你需要确定新的区域也添加到了page.html.twig模版中。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">header: &apos;Header&apos;</div></pre></td></tr></table></figure>
<p>模版中输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; page.header &#125;&#125;</div></pre></td></tr></table></figure>
<p>此外，你可以把它们当成是Twig模版的普通变量，可以再任何需要的地方打印输出。</p>
<h4 id="默认区域"><a href="#默认区域" class="headerlink" title="默认区域"></a>默认区域</h4><p>可以在<a href="https://api.drupal.org/api/drupal/core%21modules%21system%21templates%21page.html.twig/8" target="_blank" rel="external">page.html.twig模版文档</a>中查阅默认的区域</p>
<ol>
<li>page.header</li>
<li>page.primary_menu</li>
<li>page.secondary_menu</li>
<li>page.highlighted</li>
<li>page.help</li>
<li>page.content</li>
<li>page.sidebar_first</li>
<li>page.sidebar_second</li>
<li>page.footer</li>
<li>page.breadcrumb</li>
</ol>
<h3 id="Drupal8主题中添加样式和js"><a href="#Drupal8主题中添加样式和js" class="headerlink" title="Drupal8主题中添加样式和js"></a>Drupal8主题中添加样式和js</h3><h4 id="与Drupal7主题的区别"><a href="#与Drupal7主题的区别" class="headerlink" title="与Drupal7主题的区别"></a>与Drupal7主题的区别</h4><p><strong>有四个比较重要的区别：</strong></p>
<ol>
<li>去掉了THEME.info文件，取而代之的是THEME.info.yml文件</li>
<li>THEME.info.yml文件中的stylesheets属性不复存在，改为库的方式引入</li>
<li>THEME.info.yml文件中的scripts属性不复存在，改为库的方式引入</li>
<li>每一个页面的js只在需要时才加载，默认情况下，Drupal对于匿名用户不会需要js。这意味着，jquery不会再在每个页面自动加载了。因此，如果你的主题需要jquery或者其它的js，你需要通过“声明依赖关系”来告诉Drupal这个js需要加载</li>
</ol>
<p><strong> 加载css/js的步骤：</strong></p>
<ol>
<li>将css或者js保存到一个文件</li>
<li>定义一个包含js和css文件的“library”</li>
<li>在钩子中，把这个库追加给渲染数组</li>
</ol>
<h4 id="定义一个库"><a href="#定义一个库" class="headerlink" title="定义一个库"></a>定义一个库</h4><p>在主题文件夹中创建*.libraries.yml文件来添加库（假设你的主题名称是<code>fluffiness</code>，那么文件名就是<code>fluffiness.libraries.yml</code>）。每一个库，都是css和js文件的详情列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cuddly-slider:</div><div class="line">  version: 1.x</div><div class="line">  css:</div><div class="line">    theme:</div><div class="line">      css/cuddly-slider.css: &#123;&#125;</div><div class="line">  js:</div><div class="line">    js/cuddly-slider.js: &#123;&#125;</div></pre></td></tr></table></figure>
<p>这个例子中，假设<code>cuddly-slider.js</code>文件位于主题的js子目录中。</p>
<p>然后，需要记住的是，默认情况下，Drupal8不会在每一个页面加载jquery；只在需要时加载。因此，我们需要自己声明，主题的<code>cuddly-slider</code>库依赖<code>jQuery</code>。</p>
<p>因此，为了保证上例的<code>js/cuddly-slider.js</code>可用，我们需要更新下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cuddly-slider:</div><div class="line">  version: 1.x</div><div class="line">  css:</div><div class="line">    theme:</div><div class="line">      css/cuddly-slider.css: &#123;&#125;</div><div class="line">  js:</div><div class="line">    js/cuddly-slider.js: &#123;&#125;</div><div class="line">  dependencies:</div><div class="line">    - core/jquery</div></pre></td></tr></table></figure>
<p>当然，库也可以只包含css，或者只包含js。大部分的主题可能会有一个<code>global-styling</code>库，用于全局加载样式文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">global-styling:</div><div class="line">  version: 1.x</div><div class="line">  css:</div><div class="line">    theme:</div><div class="line">      css/layout.css: &#123;&#125;</div><div class="line">      css/style.css: &#123;&#125;</div><div class="line">      css/colors.css: &#123;&#125;</div><div class="line">      css/print.css: &#123; media: print &#125;</div></pre></td></tr></table></figure>
<p>而且，正如你所想，库中定义的css的顺序就是将来加载的顺序。</p>
<p>在Drupal7中，你可以把媒体查询属性(screen, print, all)作为<code>stylesheets</code>属性的子键，而现在你可以把它当作值定义，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">css/print.css: &#123; media: print &#125;</div></pre></td></tr></table></figure>
<p>现在默认情况下，所有的js文件都在页脚加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">js-header:</div><div class="line">  header: true</div><div class="line">  js:</div><div class="line">    header.js: &#123;&#125;</div><div class="line"></div><div class="line">js-footer:</div><div class="line">  js:</div><div class="line">    footer.js: &#123;&#125;</div></pre></td></tr></table></figure>
<p>你得设置<code>header</code>属性为true。</p>
<h4 id="覆盖扩展库"><a href="#覆盖扩展库" class="headerlink" title="覆盖扩展库"></a>覆盖扩展库</h4><p>那些定义在<code>*.libraries.yml</code>文件中的库可以通过主题的<code>*.info.yml</code>文件中的<code>libraries-override</code>和<code>libraries-extend</code>项进行覆写和扩展。</p>
<p><strong>libraries-override</strong></p>
<p><code>libraries-override</code>是定义在库中，主题用来操作css/js的一种方式，包括删除、替换或者删除css/js。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">libraries-override:</div><div class="line">  # Replace an entire library.</div><div class="line">  core/drupal.collapse: mytheme/collapse</div><div class="line">  </div><div class="line">  # Replace an asset with another.</div><div class="line">  subtheme/library:</div><div class="line">    css:</div><div class="line">      theme:</div><div class="line">        css/layout.css: css/my-layout.css</div><div class="line">  </div><div class="line">  # Remove an asset.</div><div class="line">  drupal/dialog:</div><div class="line">    css:</div><div class="line">      theme:</div><div class="line">        dialog.theme.css: false</div><div class="line">  </div><div class="line">  # Remove an entire library.</div><div class="line">  core/modernizr: false</div></pre></td></tr></table></figure>
<p><strong>libraries-extend</strong></p>
<p><em>libraries-extend</em>为主题提供了一种可以修改库的方式。比如，添加额外的主题依赖的库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Extend drupal.user: add assets from classy&apos;s user libraries.</div><div class="line">libraries-extend:</div><div class="line">  core/drupal.user: </div><div class="line">    - classy/user1</div><div class="line">    - classy/user2</div></pre></td></tr></table></figure>
<h4 id="追加库到页面中"><a href="#追加库到页面中" class="headerlink" title="追加库到页面中"></a>追加库到页面中</h4><p><strong>在Twig模版中追加库</strong></p>
<p>通过调用twig的方法，<code>attach_library()</code>可以在twig模版中追加库，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; attach_library(&apos;fluffiness/cuddly-slider&apos;) &#125;&#125;</div><div class="line">&lt;div&gt;Some fluffy markup &#123;&#123; message &#125;&#125;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>追加给所有的页面</strong></p>
<p>为了所有页面都加载这个库，需要在主题的<code>*.info.yml</code>文件中，<code>libraries</code>键的下面声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">name: Example</div><div class="line">type: theme</div><div class="line">core: 8.x</div><div class="line">libraries:</div><div class="line">  - fluffiness/cuddly-slider</div></pre></td></tr></table></figure>
<h4 id="为一组页面添加库"><a href="#为一组页面添加库" class="headerlink" title="为一组页面添加库"></a>为一组页面添加库</h4><p>在大部分情况下，你可能不希望所有的页面加载你的库，而是部分页面加载。举个例子来说，你可能只想在某个特定的区块中加载，或者用户访问某个节点类型时加载。</p>
<p>主题可以通过实现<code>THEME_preprocess_HOOK()</code>方法达到这个效果。</p>
<p>例如，你想要在维护页面追加你的库，“HOOK”就是“maintenance_page”，然后你的方法就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function fluffiness_preprocess_maintenance_page(&amp;$variables) &#123;</div><div class="line">  $variables[&apos;#attached&apos;][&apos;library&apos;][] = &apos;fluffiness/cuddly-slider&apos;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>你也可以为主题的其它hook做同样的事情，当然你的函数中也可以包含逻辑处理。</p>
<p><strong>重要提示</strong>：最通用的用法是根据当前的路由来加载库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function fluffiness_preprocess_page(&amp;$variables) &#123;</div><div class="line">  $variables[&apos;#cache&apos;][&apos;contexts&apos;][] = &apos;route&apos;;</div><div class="line">  if (\Drupal::routeMatch()-&gt;getRouteName() === &apos;entity.node.preview&apos;) &#123;</div><div class="line">    $variables[&apos;#attached&apos;][&apos;library&apos;][] = &apos;fluffiness/node-preview&apos;;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="添加可定制的js"><a href="#添加可定制的js" class="headerlink" title="添加可定制的js"></a>添加可定制的js</h4><p>在某些情况下，你可能想要根据某些php计算信息来加载js。</p>
<p>在这种情况下，像之前一样，创建一个js文件并追加进来，再通过<code>drupalSettings</code>(替换Drupal7中的<code>Drupal.settings</code>)追加一些js设置项并由追加的js文件读取这些设置项。然后，为了使<code>drupalSettings</code>在我们的js文件中生效，我们得像引入jQuery一样操作：我们得在依赖中定义。</p>
<p>就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cuddly-slider:</div><div class="line">  version: 1.x</div><div class="line">  js:</div><div class="line">    js/cuddly-slider.js: &#123;&#125;</div><div class="line">  dependencies:</div><div class="line">    - core/jquery</div><div class="line">    - core/drupalSettings</div></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function fluffiness_page_attachments_alter(&amp;$page) &#123;</div><div class="line">  $page[&apos;#attached&apos;][&apos;library&apos;][] = &apos;fluffiness/cuddly-slider&apos;;</div><div class="line">  $page[&apos;#attached&apos;][&apos;drupalSettings&apos;][&apos;fluffiness&apos;][&apos;cuddlySlider&apos;][&apos;foo&apos;] = &apos;bar&apos;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>这样<code>cuddly-slider.js</code>就可以访问<code>drupalSettings.fluffiness.cuddlySlider.foo</code>了(这里 === ‘bar’)。</p>
<h3 id="在模版中使用attributes"><a href="#在模版中使用attributes" class="headerlink" title="在模版中使用attributes"></a>在模版中使用attributes</h3><p>attributes是一个在每个twig模版中都有效的对象。attributes用来存储所有的父容器的相关属性，并提供有用的方法给开发者处理这些数据。</p>
<h4 id="Attribute的方法"><a href="#Attribute的方法" class="headerlink" title="Attribute的方法"></a>Attribute的方法</h4><p><strong>attributes.addClass()</strong></p>
<p>单个类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div&#123;&#123;attributes.addClass(&apos;my-class&apos;)&#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>多个类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;%</div><div class="line">  set classes = [</div><div class="line">    &apos;red&apos;,</div><div class="line">    &apos;green&apos;,</div><div class="line">  ]</div><div class="line">%&#125;</div><div class="line">&lt;div&#123;&#123; attributes.addClass(classes) &#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;red green&quot;&gt;&lt;/div&gt;.</div></pre></td></tr></table></figure>
<p><em>html标签与twig语法之间不能有任何空格！</em></p>
<p><strong>attributes.removeClass()</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;#classes = [ &apos;red&apos;, &apos;green&apos;, &apos;blue&apos; ] #&#125;</div><div class="line"></div><div class="line">&lt;div&#123;&#123; attributes.addClass(classes).removeClass(&apos;green&apos;) &#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;red blue&quot;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>attributes.setAttribute($attribute, $value)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div&#123;&#123; attributes.setAttribute(&apos;id&apos;, &apos;myID&apos;) &#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div id=&quot;myID&quot;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>attributes.removeAttribute($attribute, $value)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div&#123;&#123; attributes.removeAttribute(&apos;id&apos;) &#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p><strong>attributes.hasClass($class)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% if attribute.hasClass(‘myClass&apos;) %&#125;</div><div class="line"> &#123;# do stuff #&#125;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<h4 id="其它有用的代码片段"><a href="#其它有用的代码片段" class="headerlink" title="其它有用的代码片段"></a>其它有用的代码片段</h4><p><strong>链式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;% set classes = [&apos;red&apos;, &apos;green&apos;, &apos;blue&apos;] %&#125;</div><div class="line">&#123;% set my_id = &apos;specific-id&apos; %&#125;</div><div class="line">&#123;% set image_src = &apos;https://www.drupal.org/files/powered-blue-135x42.png&apos; %&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img&#123;&#123; attributes.addClass(classes).removeClass(&apos;green&apos;).setAttribute(&apos;id&apos;, my_id).setAttribute(&apos;src&apos;, image_src) &#125;&#125;&gt;</div></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img id=&quot;specific-id&quot; class=&quot;red blue&quot; src=&quot;https://www.drupal.org/files/powered-blue-135x42.png&quot;&gt;</div></pre></td></tr></table></figure>
<p><strong>使用without filter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div class=”myclass &#123;&#123; attributes.class &#125;&#125;”&#123;&#123;attributes|without(‘class’) &#125;&#125;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<h3 id="Drupal6-7-8主题区别"><a href="#Drupal6-7-8主题区别" class="headerlink" title="Drupal6, 7, 8主题区别"></a>Drupal6, 7, 8主题区别</h3><p>这里列出的是比较重要的Drupal8中的主题变化</p>
<ol>
<li>Drupal8默认输出html5</li>
<li>除了jQuery2.x之外，Drupal8还引入更多的前端框架，例如：<a href="http://modernizr.com/" target="_blank" rel="external">Modernizr</a>，<a href="http://underscorejs.org/" target="_blank" rel="external">Underscore.js</a>，以及<a href="http://backbonejs.org/" target="_blank" rel="external">Backbone.js</a>。</li>
<li>Drupal8引入了Twig，替换了原来的默认模板引擎PHPTemplate。</li>
<li>Drupal8处于性能考虑，默认启用了类似css、js合并之类的默认特性。</li>
<li>在drupal6和drupal7中，可以调用<code>drupal_add_css()</code>和<code>drupal_add_js()</code>函数添加css或者js，现在替换成了在渲染数组中追加<code>#attached</code>属性调用库的方法。</li>
<li>Drupal8不再支持IE6、7、8，启用jQuery2.0，支持现代HTML5/CSS3浏览器。</li>
<li>Drupal8不支持那些不支持SVG的浏览器(包括IE8和安卓浏览器2.3)。</li>
<li>Drupal8的css中，减少了id的使用。</li>
<li>Drupal8的css结构(文件结构)基于<a href="https://smacss.com/" target="_blank" rel="external">SMACSS</a>和<a href="http://bem.info/" target="_blank" rel="external">BEM</a></li>
<li>Drupal8将预处理函数中的css类移到了Twig模版中。</li>
</ol>

            
          </span>
        
      
    </div>
    
    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://static.verycloud.cn/sites/default/files/pic/image/20150607/2015060790205_41484.jpeg" alt="RamboLau" itemprop="image"/>
          <p class="site-author-name" itemprop="name">RamboLau</p>
        </div>
        <p class="site-description motion-element" itemprop="description">记录生活，分享知识，传播乐趣</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives/">
              <span class="site-state-item-count">74</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories/">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags/">
              <span class="site-state-item-count">63</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/RamboLau" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RamboLau</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"176code"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
