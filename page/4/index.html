<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.useso.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Drupal linux unix vim" />





  <link rel="alternate" href="/atom.xml" title="Rambo's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="记录生活，分享知识，传播乐趣">
<meta property="og:type" content="website">
<meta property="og:title" content="Rambo's Blog">
<meta property="og:url" content="http://verynull.com/page/4/index.html">
<meta property="og:site_name" content="Rambo's Blog">
<meta property="og:description" content="记录生活，分享知识，传播乐趣">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rambo's Blog">
<meta name="twitter:description" content="记录生活，分享知识，传播乐趣">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Rambo's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Rambo's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">记录生活，分享知识，传播乐趣</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="url">
                  高性能mysql主从架构及MHA高可用负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-28T14:35:42+08:00" content="2015-11-28">
              2015-11-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>实验系统：CentOS 6.7_x86_64（4.2.3）</p>
<p>实验前提：防火墙和selinux都关闭</p>
<p>实验说明：本实验共有3台主机，拓扑图如下所示</p>
<p><img src="http://images.cnitblog.com/i/609710/201404/192216579327066.png" alt="拓扑图"></p>
<p>主机说明：<br>manager: 172.16.2.99<br>master: 172.16.115.101<br>备用master: 172.16.115.102<br>也可以加别的slave。</p>
<p>实验软件：</p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>mysql(mysql-5.5.46-1.el6.remi.x86_64)</p>
<h3 id="1、安装软件">1、安装软件</h3><p>三台机器都需要安装mha4mysql-node, master和slave还需要安装mysql, manager可以不装mysql. 当然manager也可以用slave机器来做。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql mysql-server epel-release -y</span><br><span class="line"></span><br><span class="line">rpm -Uvh mha4mysql-node-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>manager还需要安装mha4mysql-manager.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mha4mysql-manager-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm -y</span><br></pre></td></tr></table></figure>
<p>用localinstall会自动安装依赖。</p>
<h3 id="2、mysql主从配置">2、mysql主从配置</h3><h4 id="master上编辑/etc/my-cnf，添加配置">master上编辑/etc/my.cnf，添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master config</span></span><br><span class="line">server-id = <span class="number">1</span></span><br><span class="line"><span class="built_in">log</span>_bin = mysql-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates</span><br><span class="line">binlog_<span class="keyword">do</span>_db = drupal</span><br></pre></td></tr></table></figure>
<h4 id="slave上编辑/etc/my-cnf,添加配置">slave上编辑/etc/my.cnf,添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave config</span></span><br><span class="line">server-id = <span class="number">2</span></span><br><span class="line"><span class="built_in">log</span>_bin = mysql-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates</span><br><span class="line">binlog_<span class="keyword">do</span>_db = drupal</span><br></pre></td></tr></table></figure>
<h4 id="创建具有复制权限的用户">创建具有复制权限的用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">'replicate'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h4 id="设置slave">设置slave</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=<span class="number">3306</span>,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_<span class="built_in">log</span>_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>
<h4 id="查看master/slave配置">查看master/slave配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.<span class="number">000001</span> |      <span class="number">867</span> | drupal       |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"></span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: <span class="number">172.16</span>.<span class="number">115.101</span></span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">867</span></span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.<span class="number">000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">1013</span></span><br><span class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: drupal</span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">867</span></span><br><span class="line">              Relay_Log_Space: <span class="number">1170</span></span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: <span class="number">1</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>如果Slave_IO_Running和Slave_SQL_Running都是YES，说明slave服务器配置OK。</p>
<h3 id="3、MHA作用">3、MHA作用</h3><p>1）从宕机崩溃的master保存二进制日志事件（binlog events）;</p>
<p>2）识别含有最新更新的slave；</p>
<p>3）应用差异的中继日志（relay log）到其他的slave；</p>
<p>4）应用从master保存的二进制日志事件（binlog events）；</p>
<p>5）提升一个slave为新的master；</p>
<p>6）使其他的slave连接新的master进行复制；</p>
<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh              检查MHA的SSH配置状况</span><br><span class="line">masterha_check_repl             检查MySQL复制状况</span><br><span class="line">masterha_manger                 启动MHA</span><br><span class="line">masterha_check_status           检测当前MHA运行状态</span><br><span class="line">masterha_master_monitor         检测master是否宕机</span><br><span class="line">masterha_master_switch          控制故障转移（自动或者手动）</span><br><span class="line">masterha_conf_host              添加或删除配置的server信息</span><br></pre></td></tr></table></figure>
<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs                保存和复制master的二进制日志</span><br><span class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span><br><span class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure>
<h3 id="4、配置MHA">4、配置MHA</h3><h4 id="创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）">创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># vim /etc/masterha/app1.cnf </span></span><br><span class="line"></span><br><span class="line">[server default]</span><br><span class="line">manager_<span class="built_in">log</span>=/var/<span class="built_in">log</span>/mha/app1/manager.log //设置manager的日志</span><br><span class="line">manager_workdir=/var/<span class="built_in">log</span>/mha/app1.log //设置manager的工作目录</span><br><span class="line">master_binlog_dir=/var/lib/mysql //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span><br><span class="line"></span><br><span class="line">user=repl  //设置监控用户root</span><br><span class="line">password=<span class="number">123456</span> //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</span><br><span class="line">ssh_user=root //设置ssh的登录用户名</span><br><span class="line">repl_user=repl //设置复制环境中的复制用户名</span><br><span class="line">repl_password=<span class="number">123456</span> //设置复制用户的密码</span><br><span class="line">ping_interval=<span class="number">10</span> //设置监控主库，发送ping包的时间间隔，默认是<span class="number">3</span>秒，尝试三次没有回应的时候自动进行railover</span><br><span class="line"></span><br><span class="line">shutdown_script=<span class="string">""</span> //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span><br><span class="line">master_ip_online_change_script=<span class="string">""</span> //设置手动切换时候的切换脚本</span><br><span class="line">report_script=<span class="string">"/usr/bin/masterha_report_script"</span> //设置发生切换后发送的报警的脚本</span><br><span class="line">master_ip_failover_script=<span class="string">"/usr/bin/masterha_ip_failover"</span> //设置自动failover时候的切换脚本</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=<span class="number">172.16</span>.<span class="number">115.101</span></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=<span class="number">172.16</span>.<span class="number">115.102</span></span><br><span class="line">candidate_master=<span class="number">1</span> //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中时间最新的slave</span><br><span class="line">check_repl_delay=<span class="number">0</span>   //默认情况下如果一个slave落后master <span class="number">100</span>M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=<span class="number">0</span>,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=<span class="number">1</span>的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span><br></pre></td></tr></table></figure>
<h4 id="设置relay_log的清除方式（在每个slave节点上）：">设置relay log的清除方式（在每个slave节点上）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># mysql -e 'set global relay_log_purge=0'</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</p>
<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--user mysql                      用户名</span><br><span class="line">--password mysql                  密码</span><br><span class="line">--port                            端口号</span><br><span class="line">--workdir                         指定创建relay <span class="built_in">log</span>的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</span><br><span class="line">--disable_relay_<span class="built_in">log</span>_purge         默认情况下，如果relay_<span class="built_in">log</span>_purge=<span class="number">1</span>，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_<span class="built_in">log</span>_purge=<span class="number">1</span>的情况下会将relay_<span class="built_in">log</span>_purge设置为<span class="number">0</span>。清理relay <span class="built_in">log</span>之后，最后将参数设置为OFF。</span><br></pre></td></tr></table></figure>
<h4 id="设置定期清理relay脚本（两台slave服务器）">设置定期清理relay脚本（两台slave服务器）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># cat purge_relay_log.sh </span></span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">user=root</span><br><span class="line">passwd=<span class="number">123456</span></span><br><span class="line">port=<span class="number">3306</span></span><br><span class="line"><span class="built_in">log</span>_dir=<span class="string">'/var/log/masterha'</span></span><br><span class="line">work_dir=<span class="string">'/var/lib/mysql'</span></span><br><span class="line">purge=<span class="string">'/usr/local/bin/purge_relay_logs'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="operator">-d</span> <span class="variable">$log_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir <span class="variable">$log_dir</span> -p</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$purge</span> --user=<span class="variable">$user</span> --password=<span class="variable">$passwd</span> --disable_relay_<span class="built_in">log</span>_purge --port=<span class="variable">$port</span> --workdir=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>添加到crontab定期执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># crontab -l</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span> * * * /bin/bash /root/purge_relay_log.sh</span><br></pre></td></tr></table></figure></p>
<h4 id="purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。">purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># purge_relay_logs --user=root --password=123456 --port=3306 -disable_relay_log_purge --workdir=/data/</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">04</span>-<span class="number">20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">24</span>: purge_relay_logs script started.</span><br><span class="line"> Found relay_log.info: /data/mysql/relay-log.info</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</span><br><span class="line"> Current relay <span class="built_in">log</span> file: /data/mysql/server03-relay-bin.<span class="number">000002</span></span><br><span class="line"> Archiving unused relay <span class="built_in">log</span> files (up to /data/mysql/server03-relay-bin.<span class="number">000001</span>) ...</span><br><span class="line"> Creating hard link <span class="keyword">for</span> /data/mysql/server03-relay-bin.<span class="number">000001</span> under /data//server03-relay-bin.<span class="number">000001</span> .. ok.</span><br><span class="line"> Creating hard links <span class="keyword">for</span> unused relay <span class="built_in">log</span> files completed.</span><br><span class="line"> Executing SET GLOBAL relay_<span class="built_in">log</span>_purge=<span class="number">1</span>; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay <span class="built_in">log</span> files (<span class="keyword">if</span> it keeps up); SET GLOBAL relay_<span class="built_in">log</span>_purge=<span class="number">0</span>; .. ok.</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</span><br><span class="line"><span class="number">2014</span>-<span class="number">04</span>-<span class="number">20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">27</span>: All relay <span class="built_in">log</span> purging operations succeeded.</span><br></pre></td></tr></table></figure>
<h3 id="5、SSH配置">5、SSH配置</h3><p>要想MHA顺利执行各项任务，还得打通每台机器的SSH。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># ssh-keygen -t rsa</span></span><br><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># ssh-copy-id -i .ssh/id_rsa.pub root@172.16.115.101</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>记住，每台机器都要跟别的机器打通SSH。</p>
<p>检查MHA Manger到所有MHA Node的SSH连接状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>
<p>可以看见各个节点ssh验证都是ok的。</p>
<h3 id="6、检查整个复制环境状况">6、检查整个复制环境状况</h3><p>通过masterha_check_repl脚本查看整个集群的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@utn-cz-<span class="number">1</span>-<span class="number">1</span><span class="operator">-s</span>16h2 app1.log]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Dead Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Alive Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Alive Slaves:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)  Version=<span class="number">5.5</span>.<span class="number">46</span>-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]     Replicating from <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Current Alive Master: <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  <span class="built_in">read</span>_only=<span class="number">1</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [warning]  relay_<span class="built_in">log</span>_purge=<span class="number">0</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  binlog_<span class="keyword">do</span>_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]  Version check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] HealthCheck: SSH to <span class="number">172.16</span>.<span class="number">115.101</span> is reachable.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Master MHA Node version is <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking recovery script configurations on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=<span class="number">4</span> --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_<span class="built_in">test</span> --manager_version=<span class="number">0.56</span> --start_file=mysql-bin.<span class="number">000021</span> </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.<span class="number">000021</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Binlog setting check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_ip=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.5</span>.<span class="number">46</span>-log --manager_version=<span class="number">0.56</span> --relay_<span class="built_in">log</span>_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Testing mysql connection and privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Slaves settings check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] </span><br><span class="line"><span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking replication health on <span class="number">172.16</span>.<span class="number">115.102</span>..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]  ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_ip=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:<span class="number">0</span> down==/sbin/ifconfig eth0:<span class="number">0</span> <span class="number">172.16</span>.<span class="number">115.200</span>/<span class="number">24</span>===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]  OK.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">0</span> (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>
<h3 id="7、检查MHA_Manager的状态">7、检查MHA Manager的状态</h3><p>通过master_check_status脚本查看Manager的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 is stopped(<span class="number">2</span>:NOT_RUNNING).</span><br></pre></td></tr></table></figure>
<p>注意：如果正常，会显示”PING_OK”，否则会显示”NOT_RUNNING”，这代表MHA监控没有开启。</p>
<h3 id="8、开启MHA_Manager监控">8、开启MHA Manager监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failover &gt; /var/log/mha/app1/manager.log &lt; /dev/null 2&gt;&amp;1 &amp;</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">7303</span></span><br></pre></td></tr></table></figure>
<p>启动参数介绍：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--remove_dead_master_conf      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span><br><span class="line">--manger_<span class="built_in">log</span>                            日志存放位置</span><br><span class="line">--ignore_last_failover                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足<span class="number">8</span>小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</span><br></pre></td></tr></table></figure>
<p>查看MHA Manager监控是否正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">20386</span>) is running(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span>.<span class="number">115.101</span></span><br></pre></td></tr></table></figure>
<p>可以看见已经在监控了，而且master的主机为172.16.115.101</p>
<h3 id="9、查看启动日志">9、查看启动日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment">#  cat /var/log/mha/app1/manager.log</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Dead Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Alive Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Alive Slaves:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)  Version=<span class="number">5.5</span>.<span class="number">46</span>-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]     Replicating from <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Current Alive Master: <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  <span class="built_in">read</span>_only=<span class="number">1</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [warning]  relay_<span class="built_in">log</span>_purge=<span class="number">0</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  binlog_<span class="keyword">do</span>_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]  Version check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] HealthCheck: SSH to <span class="number">172.16</span>.<span class="number">115.101</span> is reachable.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Master MHA Node version is <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking recovery script configurations on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=<span class="number">4</span> --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_<span class="built_in">test</span> --manager_version=<span class="number">0.56</span> --start_file=mysql-bin.<span class="number">000021</span> </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.<span class="number">000021</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Binlog setting check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_ip=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.5</span>.<span class="number">46</span>-log --manager_version=<span class="number">0.56</span> --relay_<span class="built_in">log</span>_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Testing mysql connection and privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Slaves settings check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] </span><br><span class="line"><span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_ip=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:<span class="number">0</span> down==/sbin/ifconfig eth0:<span class="number">0</span> <span class="number">172.16</span>.<span class="number">115.200</span>/<span class="number">24</span>===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info]  OK.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Set master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Starting ping health check on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br></pre></td></tr></table></figure>
<h3 id="10、配置VIP">10、配置VIP</h3><p>我们采用脚本的方式去配置vip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment">#  vim /usr/bin/masterha_ip_failover</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    <span class="variable">$command</span>,          <span class="variable">$ssh_user</span>,        <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">'172.16.115.200/24'</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">'0'</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> <span class="variable">$vip</span>"</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> down"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \<span class="variable">$command</span>,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">"\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="variable">$@</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="built_in">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \<span class="string">" <span class="variable">$ssh_start_vip</span> \"`;</span><br><span class="line">&#125;</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     return 0  unless  (<span class="variable">$ssh_user</span>);</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \" <span class="variable">$ssh_stop_vip</span> \"`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    "</span>Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip </span><br><span class="line">            --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n<span class="string">";</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="11、邮件发送脚本send_report">11、邮件发送脚本send_report</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( <span class="variable">$dead_master_host</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_slave_hosts</span>, <span class="variable">$subject</span>, <span class="variable">$body</span> );</span><br><span class="line">my <span class="variable">$smtp</span>=<span class="string">'smtp.163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_from</span>=<span class="string">'services@163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_user</span>=<span class="string">'services@163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_pass</span>=<span class="string">'123456'</span>;</span><br><span class="line">my <span class="variable">$mail_to</span>=[<span class="string">'xxx@xxx.cn'</span>];</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$dead_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \<span class="variable">$new_slave_hosts</span>,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \<span class="variable">$subject</span>,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \<span class="variable">$body</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mailToContacts(<span class="variable">$smtp</span>,<span class="variable">$mail_from</span>,<span class="variable">$mail_user</span>,<span class="variable">$mail_pass</span>,<span class="variable">$mail_to</span>,<span class="variable">$subject</span>,<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( <span class="variable">$smtp</span>, <span class="variable">$mail_from</span>, <span class="variable">$user</span>, <span class="variable">$passwd</span>, <span class="variable">$mail_to</span>, <span class="variable">$subject</span>, <span class="variable">$msg</span> ) = @_;</span><br><span class="line">    open my <span class="variable">$DEBUG</span>, <span class="string">"&gt; /tmp/monitormail.log"</span></span><br><span class="line">        or die <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my <span class="variable">$sender</span> = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; <span class="variable">$smtp</span>,</span><br><span class="line">        from        =&gt; <span class="variable">$mail_from</span>,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; <span class="variable">$user</span>,</span><br><span class="line">        authpwd     =&gt; <span class="variable">$passwd</span>,</span><br><span class="line">        to          =&gt; <span class="variable">$mail_to</span>,</span><br><span class="line">        subject     =&gt; <span class="variable">$subject</span>,</span><br><span class="line">        debug       =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sender</span>-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; <span class="variable">$msg</span>,</span><br><span class="line">            debug =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">        &#125;</span><br><span class="line">    ) or <span class="built_in">print</span> <span class="variable">$Mail</span>::Sender::Error;</span><br><span class="line">    <span class="built_in">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h3 id="12、测试">12、测试</h3><p>1.主库断电<br>2.主库断网<br>3.主库重启<br>4.主库关机<br>以上情况都测试过都能自动切换~<br>请看日志分析切换过程  </p>
<h3 id="13、主库模拟故障后的恢复">13、主库模拟故障后的恢复</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># grep -i "All other slaves should start" manager.log </span></span><br><span class="line">Mon Apr <span class="number">21</span> <span class="number">22</span>:<span class="number">28</span>:<span class="number">33</span> <span class="number">2014</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.115.102'</span>, MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000022'</span>, MASTER_LOG_POS=<span class="number">506716</span>, MASTER_USER=<span class="string">'repl'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</span><br><span class="line">[root@<span class="number">192.168</span>.<span class="number">0.20</span> app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>然后再就得主库里执行下,再start slave ,然后就得主库就变为了新的主库的从库了。<br>记得看下show slave status\G;  </p>
<h3 id="14、报错记录总结">14、报错记录总结</h3><p>摘抄自google.</p>
<h4 id="报错记录1：">报错记录1：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 ~]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">06</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln303]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on192.<span class="number">168.52</span>.<span class="number">130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)!</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pmline <span class="number">315</span></span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：在192.168.52.130上面，vim /etc/my.cnf，在里面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relay-log=/home/data/mysql/binlog/mysql-relay-bin</span><br></pre></td></tr></table></figure>
<p>然后重启mysql，再去重新设置slave连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;</span><br><span class="line">RESET SLAVE;</span><br><span class="line">CHANGE MASTER TOMASTER_HOST=<span class="string">'192.168.52.129'</span>,MASTER_USER=<span class="string">'repl'</span>,MASTER_PASSWORD=<span class="string">'repl_1234'</span>,MASTER_LOG_FILE=<span class="string">'mysql-bin.000178'</span>,MASTER_LOG_POS=<span class="number">459</span>;</span><br><span class="line">START SLAVE;</span><br></pre></td></tr></table></figure>
<p>Ok，搞定了。</p>
<h4 id="报错记录2：">报错记录2：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 perl]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln306]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)!</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm line <span class="number">315</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 perl]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决方法：<br>/etc/masterha/app1.cnf文件里面的参数配置，user和repl_user都是mysql账号，需要创建好，这里是只创建了repl_user而没有创建好user账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user=manager</span><br><span class="line">password=manager_1234</span><br><span class="line">repl_user=repl</span><br><span class="line">repl_password=repl_1234</span><br></pre></td></tr></table></figure>
<p>在mysql节点上，建立允许manager 访问数据库的“ manager manager ”账户，主要用于SHOW SLAVESTATUS,RESET SLAVE; 所以需要执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT SUPER,RELOAD,REPLICATIONCLIENT,SELECT ON *.* TO manager@<span class="string">'192.168.52.%'</span> IDENTIFIED BY <span class="string">'manager_1234'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="错误记录3：">错误记录3：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@oraclem1 ~]<span class="comment">#  masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm,ln781] Multi-master configuration is detected, but two or more masters areeither writable (<span class="built_in">read</span>-only is not <span class="built_in">set</span>) or dead! Check configurations fordetails. Master configurations are as below:</span><br><span class="line">Master <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>),replicating from <span class="number">192.168</span>.<span class="number">52.129</span>(<span class="number">192.168</span>.<span class="number">52.129</span>:<span class="number">3306</span>)</span><br><span class="line">Master <span class="number">192.168</span>.<span class="number">52.129</span>(<span class="number">192.168</span>.<span class="number">52.129</span>:<span class="number">3306</span>),replicating from <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)</span><br><span class="line"> </span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm line <span class="number">326</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@oraclem1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global <span class="built_in">read</span>_only=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h4 id="报错记录4：">报错记录4：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication andchecking recovery script configurations on all alive slave servers..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info]  Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span>--slave_user=<span class="string">'manager'</span> --slave_host=<span class="number">192.168</span>.<span class="number">52.130</span> --slave_ip=<span class="number">192.168</span>.<span class="number">52.130</span>--slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.6</span>.<span class="number">12</span>-log--manager_version=<span class="number">0.56</span> --relay_dir=/home/data/mysql/data--current_relay_<span class="built_in">log</span>=mysqld-relay-bin.<span class="number">000011</span> --slave_pass=xxx</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info]  Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line">Can<span class="string">'t exec "mysqlbinlog": No suchfile or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 106.</span><br><span class="line">mysqlbinlog version command failed with rc1:0, please verify PATH, LD_LIBRARY_PATH, and client options</span><br><span class="line"> at/usr/local/bin/apply_diff_relay_logs line 493</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line 48</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [info] Got exit code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@oraclem1 ~]#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@data02 ~]<span class="comment"># type mysqlbinlog</span></span><br><span class="line">mysqlbinlog is/usr/<span class="built_in">local</span>/mysql/bin/mysqlbinlog</span><br><span class="line">[root@data02 ~]<span class="comment">#</span></span><br><span class="line">[root@data02 ~]<span class="comment"># ln -s/usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span></span><br></pre></td></tr></table></figure>
<h4 id="报错记录5：">报错记录5：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [info]  Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is /home/data/mysql/data/mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Testing mysql connection and privileges..sh: mysql: <span class="built_in">command</span> not found</span><br><span class="line">mysql <span class="built_in">command</span> failed with rc <span class="number">127</span>:<span class="number">0</span>!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">375</span></span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">497</span></span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">475</span></span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">120</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/bin/masterha_check_repl line <span class="number">48</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln <span class="operator">-s</span> /usr/<span class="built_in">local</span>/mysql/bin/mysql/usr/bin/mysql</span><br></pre></td></tr></table></figure>
<h4 id="报错记录6：">报错记录6：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">36</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs--command=<span class="built_in">test</span> --slave_user=<span class="string">'manager'</span> --slave_host=<span class="number">192.168</span>.<span class="number">52.130</span>--slave_ip=<span class="number">192.168</span>.<span class="number">52.130</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp--target_version=<span class="number">5.6</span>.<span class="number">12</span>-log --manager_version=<span class="number">0.56</span>--relay_dir=/home/data/mysql/data--current_relay_<span class="built_in">log</span>=mysqld-relay-bin.<span class="number">000011</span> --slave_pass=xxx</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">36</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is/home/data/mysql/data/mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Testing mysql connection and privileges..Warning: Using a password onthe <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1142</span> (<span class="number">42000</span>) at line <span class="number">1</span>: CREATE<span class="built_in">command</span> denied to user <span class="string">'manager'</span>@<span class="string">'192.168.52.130'</span> <span class="keyword">for</span> table<span class="string">'apply_diff_relay_logs_test'</span></span><br><span class="line">mysql <span class="built_in">command</span> failed with rc <span class="number">1</span>:<span class="number">0</span>!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">375</span></span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">497</span></span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">475</span></span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">120</span></span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln205] Slaves settingscheck failed!</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln413] Slave configurationfailed.</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln424] Error happened onchecking configurations.  at/usr/<span class="built_in">local</span>/bin/masterha_check_repl line <span class="number">48</span></span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln523] Error happened onmonitoring servers.</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Got exitcode <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>
<p>解决办法：<br>执行如下授权语句sql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT CREATE,INSERT,UPDATE,DELETE,DROP ON*.* TO manager@<span class="string">'192.168.52.%'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="其他">其他</h4><p>另外，如果nohup masterha_manager执行不了，请检查master和slave是否配置正确。可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=<span class="number">3306</span>,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_<span class="built_in">log</span>_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>重新设置slave。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/27/使用gdb调试php-fpm/" itemprop="url">
                  使用gdb调试php-fpm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-27T16:17:10+08:00" content="2015-11-27">
              2015-11-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/27/使用gdb调试php-fpm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/27/使用gdb调试php-fpm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>有很多php开发人员经常问我，如果执行php代码的时候出现严重错误的时候，如何快速定位问题。我一般推荐他们用gdb去调试。</p>
<p>下面用php-fpm的一个段错误来举例说明，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: [pool www] child <span class="number">15109</span> exited on signal <span class="number">11</span> (SIGSEGV) after <span class="number">654.485221</span> seconds from start</span><br></pre></td></tr></table></figure>
<h3 id="1、安装gdb">1、安装gdb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gdb php-dbg</span><br></pre></td></tr></table></figure>
<p>有的时候可能需要安装debuginfo相关的库，如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debuginfo-install php-fpm</span><br></pre></td></tr></table></figure>
<h3 id="2、设置coredump">2、设置coredump</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/tmp/core-%e.%p'</span> &gt; /proc/sys/kernel/core_pattern</span><br><span class="line"><span class="built_in">echo</span> <span class="number">0</span> &gt; /proc/sys/kernel/core_uses_pid</span><br><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>
<p>当然,coredump的文件格式可以设置为其他的，这里是详细的设置项说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">%%  a single % character</span><br><span class="line">%c  core file size soft resource <span class="built_in">limit</span> of crashing process (since</span><br><span class="line">    Linux <span class="number">2.6</span>.<span class="number">24</span>)</span><br><span class="line">%d  dump mode—same as value returned by prctl(<span class="number">2</span>) PR_GET_DUMPABLE</span><br><span class="line">    (since Linux <span class="number">3.7</span>)</span><br><span class="line">%e  executable filename (without path prefix)</span><br><span class="line">%E  pathname of executable, with slashes (<span class="string">'/'</span>) replaced by</span><br><span class="line">    exclamation marks (<span class="string">'!'</span>) (since Linux <span class="number">3.0</span>).</span><br><span class="line">%g  (numeric) real GID of dumped process</span><br><span class="line">%h  hostname (same as nodename returned by uname(<span class="number">2</span>))</span><br><span class="line">%p  PID of dumped process, as seen <span class="keyword">in</span> the PID namespace <span class="keyword">in</span> <span class="built_in">which</span></span><br><span class="line">    the process resides</span><br><span class="line">%P  PID of dumped process, as seen <span class="keyword">in</span> the initial PID namespace</span><br><span class="line">    (since Linux <span class="number">3.12</span>)</span><br><span class="line">%s  number of signal causing dump</span><br><span class="line">%t  time of dump, expressed as seconds since the Epoch,</span><br><span class="line">    <span class="number">1970</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> (UTC)</span><br><span class="line">%u  (numeric) real UID of dumped process</span><br></pre></td></tr></table></figure>
<h3 id="3、设置php-fpm">3、设置php-fpm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>
<p>找到关键字 rlimit_core，并修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rlimit_core = unlimited</span><br></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/php-fpm --daemonize</span><br></pre></td></tr></table></figure>
<p>这时就会在/tmp下看到有coredump文件生成了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]<span class="comment"># ls</span></span><br><span class="line">core-php-fpm.<span class="number">7279</span></span><br></pre></td></tr></table></figure>
<h3 id="4、追踪">4、追踪</h3><p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb /usr/sbin/php-fpm /tmp/core-php-fpm.<span class="number">7279</span></span><br></pre></td></tr></table></figure>
<p>执行bt命令就可以查看详细的错误日志了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  _zend_hash_init (ht=0x2b4d1a4f8100, nSize=174762, pDestructor=0, persistent=1 '\001') at /usr/src/debug/php-7.0.0RC8/Zend/zend_hash.c:172</span></span><br><span class="line"><span class="comment">#1  0x00002b4d0d0e87ac in zend_accel_init_shm (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2387</span></span><br><span class="line"><span class="comment">#2  accel_startup (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2640</span></span><br><span class="line"><span class="comment">#3  0x00000000005e8d21 in zend_extension_startup (extension=0x168c810) at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:176</span></span><br><span class="line"><span class="comment">#4  0x00000000005d2293 in zend_llist_apply_with_del (l=0x9dd420, func=0x5e8d10 &lt;zend_extension_startup&gt;) at /usr/src/debug/php-7.0.0RC8/Zend/zend_llist.c:171</span></span><br><span class="line"><span class="comment">#5  0x00000000005e8d07 in zend_startup_extensions () at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:197</span></span><br><span class="line"><span class="comment">#6  0x0000000000580985 in php_module_startup (sf=&lt;value optimized out&gt;, additional_modules=&lt;value optimized out&gt;, num_additional_modules=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/main/main.c:2197</span></span><br><span class="line"><span class="comment">#7  0x000000000067aec5 in php_cgi_startup (sapi_module=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:837</span></span><br><span class="line"><span class="comment">#8  0x000000000067bcfe in main (argc=2, argv=0x7fff1a037498) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:1788</span></span><br></pre></td></tr></table></figure>
<p>至此，整个追踪过程结束。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="url">
                  centos6.6安装Percona Tokudb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-21T20:17:57+08:00" content="2015-11-21">
              2015-11-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/21/centos6-6安装Percona-Tokudb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>在percona官网<a href="https://www.percona.com/" target="_blank" rel="external">https://www.percona.com/</a><br>下载带有Tokudb的二进制包，也可以选择源码编译。tokudb有单独的包.<br>我这里下载的是最新的包，5.6.25-73<br>Percona-Server-5.6.25-rel73.1-Linux.x86_64.ssl101.tar.gz<br>Percona-Server-5.6.25-rel73.1-TokuDB.Linux.x86_64.ssl101.tar.gz</p>
<h3 id="前期账号创建">前期账号创建</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; groupadd mysql</span><br><span class="line">shell&gt; useradd -g mysql mysql</span><br></pre></td></tr></table></figure>
<h3 id="解压软件包">解压软件包</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; cd /usr/local</span><br><span class="line">shell&gt; tar -zxvf Percona-Server-<span class="number">5.6</span>.25-rel73.1-Linux.x86_64.ssl101.tar.gz</span><br><span class="line">shell&gt; tar -zxvf Percona-Server-<span class="number">5.6</span>.25-rel73.1-TokuDB.Linux.x86_64.ssl101.tar.gz</span><br><span class="line">shell&gt; ln -s Percona-Server-<span class="number">5.6</span>.25-rel73.1-Linux.x86_64.ssl101 mysql</span><br></pre></td></tr></table></figure>
<h3 id="设置权限">设置权限</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; cd mysql</span><br><span class="line">shell&gt; chown -R mysql .</span><br><span class="line">shell&gt; chgrp -R mysql .</span><br></pre></td></tr></table></figure>
<h3 id="创建配置文件/etc/my-cnf">创建配置文件/etc/my.cnf</h3><p>创建存放数据源的目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; mkdir -p /<span class="keyword">var</span>/lib/mysql</span><br><span class="line">Shell&gt; mkdir -p /data/mysqldata /data/mysqllog</span><br><span class="line">Shell&gt; chown -R mysql:mysql /<span class="keyword">var</span>/lib/mysql /data/mysqldata /data/mysqllog</span><br></pre></td></tr></table></figure>
<p>在附件中给出，请参考附配置文件内容</p>
<h3 id="初始化DB">初始化DB</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf</span><br><span class="line">shell&gt; chown -R root .</span><br></pre></td></tr></table></figure>
<h3 id="修改系统参数">修改系统参数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
<p>建议写到 /etc/rc.local 中，重启后也可生效</p>
<h3 id="启动数据库">启动数据库</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; bin/mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure>
<h3 id="把启动文件放去自启动中">把启动文件放去自启动中</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">service mysqld start</span><br><span class="line">service mysqld stop</span><br></pre></td></tr></table></figure>
<p>然后启动。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | <span class="keyword">DEFAULT</span> | Percona-XtraDB, Supports transactions, row-level locking, <span class="keyword">and</span> foreign keys | YES          | YES  | YES        |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/<span class="keyword">null</span> storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</span><br><span class="line">| TokuDB             | YES     | Tokutek TokuDB Storage Engine with Fractal Tree(tm) Technology             | YES          | YES  | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                             | <span class="keyword">NULL</span>         | <span class="keyword">NULL</span> | <span class="keyword">NULL</span>       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line"><span class="number">10</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>看到上面一行红字就代表数据库支持TokuDB的存储引擎了。</p>
<p>tokudb安装顺利完成，后附配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=<span class="number">0</span></span><br><span class="line"><span class="comment">#public</span></span><br><span class="line">max_connections=<span class="number">3000</span></span><br><span class="line">max_connect_errors=<span class="number">6000</span></span><br><span class="line">key_buffer_size = <span class="number">384</span>M</span><br><span class="line">low_priority_updates = <span class="number">1</span></span><br><span class="line">back_<span class="built_in">log</span> = <span class="number">1500</span></span><br><span class="line">query_cache_<span class="built_in">type</span> = <span class="number">1</span></span><br><span class="line">query_cache_size = <span class="number">64</span>M</span><br><span class="line">query_cache_<span class="built_in">limit</span> = <span class="number">4</span>M</span><br><span class="line">query_cache_min_res_unit = <span class="number">2</span>k</span><br><span class="line">tmp_table_size = <span class="number">256</span>M</span><br><span class="line"><span class="built_in">read</span>_buffer_size=<span class="number">1</span>M</span><br><span class="line"><span class="built_in">read</span>_rnd_buffer_size = <span class="number">16</span>M</span><br><span class="line">bulk_insert_buffer_size = <span class="number">64</span>M</span><br><span class="line">max_allowed_packet = <span class="number">64</span>M</span><br><span class="line">thread_cache_size = <span class="number">300</span></span><br><span class="line"><span class="comment">#file</span></span><br><span class="line">innodb_file_per_table</span><br><span class="line"><span class="comment">#buffer</span></span><br><span class="line">innodb_buffer_pool_size = <span class="number">2500</span>M</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size = <span class="number">64</span>M</span><br><span class="line">join_buffer_size = <span class="number">16</span>M</span><br><span class="line">sort_buffer_size = <span class="number">16</span>M</span><br><span class="line">innodb_max_dirty_pages_pct = <span class="number">90</span></span><br><span class="line">innodb_lock_<span class="built_in">wait</span>_timeout = <span class="number">120</span></span><br><span class="line">innodb_thread_concurrency = <span class="number">16</span></span><br><span class="line">innodb_flush_<span class="built_in">log</span>_at_trx_commit = <span class="number">2</span></span><br><span class="line">character_<span class="built_in">set</span>_server=utf8</span><br><span class="line">init_connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tokudb</span></span><br><span class="line">plugin_dir =  /usr/<span class="built_in">local</span>/mysql/lib/mysql/plugin/</span><br><span class="line">plugin_load=ha_tokudb.so</span><br><span class="line"><span class="comment">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></span><br><span class="line">tokudb_data-dir = /data/mysqldata</span><br><span class="line">tokudb_<span class="built_in">log</span>-dir = /data/mysqllog</span><br><span class="line"><span class="comment">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></span><br><span class="line">tokudb_row_format = tokudb_small</span><br><span class="line">tokudb_row_format = tokudb_fast</span><br><span class="line">tokudb_cache_size = <span class="number">2</span>G</span><br><span class="line"><span class="comment">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></span><br><span class="line">tokudb_commit_sync = <span class="number">0</span></span><br><span class="line">tokudb_directio = <span class="number">1</span></span><br><span class="line">tokudb_<span class="built_in">read</span>_block_size = <span class="number">128</span>K</span><br><span class="line">tokudb_<span class="built_in">read</span>_buf_size = <span class="number">128</span>K</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">malloc_lib = /usr/<span class="built_in">local</span>/mysql/lib/mysql/libjemalloc.so <span class="comment">#只能放在mysqld_safe中，不得报错</span></span><br></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/20/centos6-6安装mariadb10-Tokudb/" itemprop="url">
                  centos6.6安装mariadb10 Tokudb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-20T20:17:18+08:00" content="2015-11-20">
              2015-11-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/20/centos6-6安装mariadb10-Tokudb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/20/centos6-6安装mariadb10-Tokudb/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>ps: 如果想在mariadb10上使用tokudb就只能自己编译了。。。。</p>
<h3 id="一、环境准备：">一、环境准备：</h3><p>tokudb的编译需要cmake 2.8.9+ 和 gcc 4.7+</p>
<p>本文选用cmake 2.8.9 和 gcc4.8.1。<br>这2个软件都只能使用源码编译安装。</p>
<p>cmake的很简单，直接下载<br>wget <a href="http://www.cmake.org/files/v2.8/cmake-2.8.9.tar.gz" target="_blank" rel="external">http://www.cmake.org/files/v2.8/cmake-2.8.9.tar.gz</a><br>然后解压进行编译<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make &amp; make install</span><br></pre></td></tr></table></figure></p>
<h3 id="二、安装gcc_4-8-1">二、安装gcc 4.8.1</h3><h4 id="1、下载gcc_4-8-1源码包：">1、下载gcc 4.8.1源码包：</h4><p><a href="http://ftp.tsukuba.wide.ad.jp/software/gcc/releases/gcc-4.8.1/gcc-4.8.1.tar.bz2" target="_blank" rel="external">http://ftp.tsukuba.wide.ad.jp/software/gcc/releases/gcc-4.8.1/gcc-4.8.1.tar.bz2</a><br>我是虚拟机里面装的Linux，我嫌wget太慢，所以自己在Windows上用迅雷下好，然后共享到Linux中。</p>
<h4 id="2、解压：">2、解压：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -jxvf gcc-<span class="number">4.8</span>.<span class="number">1</span>.tar.bz2</span><br></pre></td></tr></table></figure>
<h4 id="3、下载编译所需的依赖包：">3、下载编译所需的依赖包：</h4><p>这个步骤有两种方式完成：<br>a) 如果Linux有网络连接，直接这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> gcc-<span class="number">4.8</span>.<span class="number">1</span></span><br><span class="line">./contrib/download_prerequisites</span><br><span class="line"><span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure></p>
<p>b) 如果Linux没有网络连接（我主机和虚拟机是Host-only，不能联网，所以另外想办法），则用Windows上网下载这几个包：<br>ftp://ftp.gnu.org/gnu/gmp/gmp-4.3.2.tar.bz2<br><a href="http://www.mpfr.org/mpfr-2.4.2/mpfr-2.4.2.tar.bz2" target="_blank" rel="external">http://www.mpfr.org/mpfr-2.4.2/mpfr-2.4.2.tar.bz2</a><br><a href="http://www.multiprecision.org/mpc/download/mpc-0.8.1.tar.gz" target="_blank" rel="external">http://www.multiprecision.org/mpc/download/mpc-0.8.1.tar.gz</a><br>有人问，一定要下载几个版本吗？下载最新的版本行不行？我没试过，也不知道，我是按照gcc-4.8.1/contrib/download_prerequisites脚本里面的版本下载的。既然里面已经说了这几个版本，那我就严格按照它的要求来做。<br>然后解压并移动到gcc-4.8.1下面：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar -xjf gmp-<span class="number">4.3</span>.<span class="number">2</span>.tar.bz2</span><br><span class="line">tar -xjf mpfr-<span class="number">2.4</span>.<span class="number">2</span>.tar.bz2</span><br><span class="line">tar -xzf mpc-<span class="number">0.8</span>.<span class="number">1</span>.tar.gz</span><br><span class="line">mv gmp-<span class="number">4.3</span>.<span class="number">2</span> gcc-<span class="number">4.8</span>.<span class="number">1</span>/gmp</span><br><span class="line">mv mpfr-<span class="number">2.4</span>.<span class="number">2</span> gcc-<span class="number">4.8</span>.<span class="number">1</span>/mpfr</span><br><span class="line">mv mpc-<span class="number">0.8</span>.<span class="number">1</span> gcc-<span class="number">4.8</span>.<span class="number">1</span>/mpc</span><br></pre></td></tr></table></figure></p>
<p>这样的做法好处是，不用单独编译gmp、mpfr和mpc三个包，放在gcc源码下面一起编译（事实上这也是gcc-4.8.1/contrib/download_prerequisites脚本的做法，个人感觉更简洁些）。</p>
<h4 id="4、新建目录用于存放编译结果：">4、新建目录用于存放编译结果：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir gcc-build-<span class="number">4.8</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="5、进入新目录，并执行configure命令，产生makefile：">5、进入新目录，并执行configure命令，产生makefile：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> gcc-build-<span class="number">4.8</span>.<span class="number">1</span></span><br><span class="line">../gcc-<span class="number">4.8</span>.<span class="number">1</span>/configure --enable-checking=release --enable-languages=c,c++ --disable-multilib</span><br></pre></td></tr></table></figure>
<p>具体选项不多解释，大家可以自己查看，我只用到c和c++，所以只编译这两种语言的编译器。</p>
<h4 id="6、编译：">6、编译：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br></pre></td></tr></table></figure>
<p>我是i5四核，所以开4个线程同时编译，要是有8核就更爽了~我在虚拟机里面花了30分钟不到的时间，不算太慢了。</p>
<h4 id="7、安装：">7、安装：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h4 id="8、大功告成，检查版本：">8、大功告成，检查版本：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g++ --version</span><br><span class="line">g++ (GCC) <span class="number">4.8</span>.<span class="number">1</span></span><br><span class="line">Copyright (C) <span class="number">2013</span> Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions. There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure>
<h3 id="三、编译安装">三、编译安装</h3><p>下载mariadb源码mariadb-10.0.14.tar.gz<br> <a href="https://downloads.mariadb.org/mariadb/10.0.14/" target="_blank" rel="external">https://downloads.mariadb.org/mariadb/10.0.14/</a></p>
<p>首先需要修改tokudb的cmake编译文件，去掉fuse-linker-plugin相关内容<br>修改mariadb-10.0.14/storage/tokudb/ft-index/cmake_modules/TokuSetupCompiler.cmake<br>去掉所有的 -fuse-linker-plugin ：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  set(CMAKE_C_FLAGS_RELWITHDEBINFO "-flto -fuse-linker-plugin $&#123;CMAKE_C_FLAGS_RELWITHDEBINFO&#125; -g -O3 -UNDEBUG")</span></span><br><span class="line"><span class="comment">#  set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "-flto -fuse-linker-plugin $&#123;CMAKE_CXX_FLAGS_RELWITHDEBINFO&#125; -g -O3 -UNDEBUG")</span></span><br><span class="line"><span class="comment">#  set(CMAKE_C_FLAGS_RELEASE "-g -O3 -flto -fuse-linker-plugin $&#123;CMAKE_C_FLAGS_RELEASE&#125; -UNDEBUG")</span></span><br><span class="line"><span class="comment">#  set(CMAKE_CXX_FLAGS_RELEASE "-g -O3 -flto -fuse-linker-plugin $&#123;CMAKE_CXX_FLAGS_RELEASE&#125; -UNDEBUG")</span></span><br><span class="line"><span class="comment">#  set(CMAKE_EXE_LINKER_FLAGS "-g -fuse-linker-plugin $&#123;CMAKE_EXE_LINKER_FLAGS&#125;")</span></span><br><span class="line"><span class="comment">#  set(CMAKE_SHARED_LINKER_FLAGS "-g -fuse-linker-plugin $&#123;CMAKE_SHARED_LINKER_FLAGS&#125;")</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">set</span>(CMAKE_C_FLAGS_RELWITHDEBINFO <span class="string">"-flto  <span class="variable">$&#123;CMAKE_C_FLAGS_RELWITHDEBINFO&#125;</span> -g -O3 -UNDEBUG"</span>)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_CXX_FLAGS_RELWITHDEBINFO <span class="string">"-flto <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELWITHDEBINFO&#125;</span> -g -O3 -UNDEBUG"</span>)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_C_FLAGS_RELEASE <span class="string">"-g -O3 -flto  <span class="variable">$&#123;CMAKE_C_FLAGS_RELEASE&#125;</span> -UNDEBUG"</span>)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_CXX_FLAGS_RELEASE <span class="string">"-g -O3 -flto  <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELEASE&#125;</span> -UNDEBUG"</span>)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_EXE_LINKER_FLAGS <span class="string">"-g  <span class="variable">$&#123;CMAKE_EXE_LINKER_FLAGS&#125;</span>"</span>)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_SHARED_LINKER_FLAGS <span class="string">"-g  <span class="variable">$&#123;CMAKE_SHARED_LINKER_FLAGS&#125;</span>"</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后是/home/gao-compile/mariadb-10.0.14/storage/tokudb/CMakeLists.txt<br>去掉所有的 -fuse-linker-plugin ：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#SET(CMAKE_MODULE_LINKER_FLAGS_RELEASE "$&#123;CMAKE_MODULE_LINKER_FLAGS_RELEASE&#125; -flto -fuse-linker-plugin")</span></span><br><span class="line"><span class="comment">#SET(CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO "$&#123;CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO&#125; -flto -fuse-linker-plugin")</span></span><br><span class="line"></span><br><span class="line">SET(CMAKE_MODULE_LINKER_FLAGS_RELEASE <span class="string">"<span class="variable">$&#123;CMAKE_MODULE_LINKER_FLAGS_RELEASE&#125;</span> -flto"</span>)</span><br><span class="line">SET(CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO <span class="string">"<span class="variable">$&#123;CMAKE_MODULE_LINKER_FLAGS_RELWITHDEBINFO&#125;</span> -flto"</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后进行编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mariadb-<span class="number">10.0</span>.<span class="number">14</span></span><br><span class="line">mkdir release</span><br><span class="line">./BUILD/compile-pentium64-max --prefix=/home/gao-compile/mariadb-<span class="number">10.0</span>.<span class="number">14</span>/release</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>然后在/home/gao-compile/mariadb-10.0.14/release/lib/plugin 目录中找到 ha_tokudb.so动态库。<br>这个就是我们要的东西了！</p>
<p>注：其实可以直接在mariadb-10.0.14/storage/tokudb目录中直接进行编译，而不用去编译整个mariadb，因为编译出来的也无法使用， mysqld可执行程序依赖GLIBCXX_3.4.15<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@GXX release]<span class="comment"># ldd bin/mysqld</span></span><br><span class="line">bin/mysqld: /usr/lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4.15</span><span class="string">' not found (required by bin/mysqld)</span></span><br></pre></td></tr></table></figure></p>
<p>在mariadb官网<a href="https://downloads.mariadb.org/mariadb/10.0.14/下载带有mariadb的二进制包。从mariadb官网下载10.0.14的不带tokudb的可执行程序tar包，然后将我们编译好的tokudb.so拷贝到" target="_blank" rel="external">https://downloads.mariadb.org/mariadb/10.0.14/下载带有mariadb的二进制包。从mariadb官网下载10.0.14的不带tokudb的可执行程序tar包，然后将我们编译好的tokudb.so拷贝到</a><br>[maradb10.0.14]/lib/plugin/下<br>我这里下载的包，10.0.14<br>mariadb-10.0.14-linux-x86_64.tar.gz </p>
<h3 id="四、初始化">四、初始化</h3><h4 id="1、前期账号创建">1、前期账号创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; groupadd mysql</span><br><span class="line">shell&gt; useradd -g mysql mysql</span><br></pre></td></tr></table></figure>
<h4 id="2、解压软件包">2、解压软件包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; <span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line">shell&gt; tar -zxvf mariadb-<span class="number">10.0</span>.<span class="number">14</span>-linux-x86_64.tar.gz</span><br><span class="line">shell&gt; ln <span class="operator">-s</span> mariadb-<span class="number">10.0</span>.<span class="number">14</span>-linux-x86_64 mysql</span><br></pre></td></tr></table></figure>
<h4 id="3、设置权限">3、设置权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; <span class="built_in">cd</span> mysql</span><br><span class="line">shell&gt; chown -R mysql .</span><br><span class="line">shell&gt; chgrp -R mysql .</span><br></pre></td></tr></table></figure>
<h4 id="4、创建配置文件/etc/my-cnf">4、创建配置文件/etc/my.cnf</h4><p>创建存放数据源的目录<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; mkdir -p /<span class="keyword">var</span>/lib/mysql</span><br><span class="line">Shell&gt; mkdir -p /data/mysqldata /data/mysqllog</span><br><span class="line">Shell&gt; chown -R mysql:mysql /<span class="keyword">var</span>/lib/mysql /data/mysqldata /data/mysqllog</span><br></pre></td></tr></table></figure></p>
<p>在附件中给出，请参考附配置文件内容</p>
<h4 id="5、初始化DB">5、初始化DB</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf</span><br><span class="line">shell&gt; chown -R root .</span><br></pre></td></tr></table></figure>
<h4 id="6、修改系统参数">6、修改系统参数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
<p>建议写到 /etc/rc.local 中，重启后也可生效</p>
<h4 id="7、启动数据库">7、启动数据库</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; bin/mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure>
<h4 id="8、把启动文件放去自启动中">8、把启动文件放去自启动中</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">service mysqld start</span><br><span class="line">service mysqld stop</span><br></pre></td></tr></table></figure>
<h4 id="9、安装tokudb支持">9、安装tokudb支持</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL SONAME <span class="string">'ha_tokudb'</span>;</span><br></pre></td></tr></table></figure>
<p>查看是否支持<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show engines</span><br><span class="line">    -&gt; ;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</span><br><span class="line">| MRG_MyISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</span><br><span class="line">| TokuDB             | YES     | Tokutek TokuDB Storage Engine with Fractal Tree(tm) Technology             | YES          | YES  | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |</span><br><span class="line">| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |</span><br><span class="line">| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line"><span class="number">11</span> rows <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.11</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>看到上面一行红字就代表数据库支持TokuDB的存储引擎了。</p>
<p>tokudb安装顺利完成，后附配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=<span class="number">0</span></span><br><span class="line"><span class="comment">#public</span></span><br><span class="line">max_connections=<span class="number">3000</span></span><br><span class="line">max_connect_errors=<span class="number">6000</span></span><br><span class="line">key_buffer_size = <span class="number">384</span>M</span><br><span class="line">low_priority_updates = <span class="number">1</span></span><br><span class="line">back_<span class="built_in">log</span> = <span class="number">1500</span></span><br><span class="line">query_cache_<span class="built_in">type</span> = <span class="number">1</span></span><br><span class="line">query_cache_size = <span class="number">64</span>M</span><br><span class="line">query_cache_<span class="built_in">limit</span> = <span class="number">4</span>M</span><br><span class="line">query_cache_min_res_unit = <span class="number">2</span>k</span><br><span class="line">tmp_table_size = <span class="number">256</span>M</span><br><span class="line"><span class="built_in">read</span>_buffer_size=<span class="number">1</span>M</span><br><span class="line"><span class="built_in">read</span>_rnd_buffer_size = <span class="number">16</span>M</span><br><span class="line">bulk_insert_buffer_size = <span class="number">64</span>M</span><br><span class="line">max_allowed_packet = <span class="number">64</span>M</span><br><span class="line">thread_cache_size = <span class="number">300</span></span><br><span class="line"><span class="comment">#file</span></span><br><span class="line">innodb_file_per_table</span><br><span class="line"><span class="comment">#buffer</span></span><br><span class="line">innodb_buffer_pool_size = <span class="number">2500</span>M</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size = <span class="number">64</span>M</span><br><span class="line">join_buffer_size = <span class="number">16</span>M</span><br><span class="line">sort_buffer_size = <span class="number">16</span>M</span><br><span class="line">innodb_max_dirty_pages_pct = <span class="number">90</span></span><br><span class="line">innodb_lock_<span class="built_in">wait</span>_timeout = <span class="number">120</span></span><br><span class="line">innodb_thread_concurrency = <span class="number">16</span></span><br><span class="line">innodb_flush_<span class="built_in">log</span>_at_trx_commit = <span class="number">2</span></span><br><span class="line">character_<span class="built_in">set</span>_server=utf8</span><br><span class="line">init_connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></span><br><span class="line">tokudb_data-dir = /data/mysqldata</span><br><span class="line">tokudb_<span class="built_in">log</span>-dir = /data/mysqllog</span><br><span class="line"><span class="comment">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></span><br><span class="line">tokudb_row_format = tokudb_small</span><br><span class="line">tokudb_row_format = tokudb_fast</span><br><span class="line">tokudb_cache_size = <span class="number">2</span>G</span><br><span class="line"><span class="comment">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></span><br><span class="line">tokudb_commit_sync = <span class="number">0</span></span><br><span class="line">tokudb_directio = <span class="number">1</span></span><br><span class="line">tokudb_<span class="built_in">read</span>_block_size = <span class="number">128</span>K</span><br><span class="line">tokudb_<span class="built_in">read</span>_buf_size = <span class="number">128</span>K</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/19/Drupal8主题-theme/" itemprop="url">
                  Drupal8主题(theme)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-19T16:35:16+08:00" content="2015-11-19">
              2015-11-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/19/Drupal8主题-theme/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/19/Drupal8主题-theme/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Drupal8中的Twig">Drupal8中的Twig</h2><p>Drupal8中Twig替换了PHPTemplate作为默认的模板引擎，导致的结果之一就是模版的后缀由原来的.tpl.php变成了.html.twig</p>
<h3 id="搜索Twig模版中的变量">搜索Twig模版中的变量</h3><p>在使用Twig模版的时候，大部分的变量都已注释的形式写在了模版中。然后，当我们新增了变量，我们就需要一个可以搜索到当前模版所有变量的方法。Twig提供了<code>dump</code>函数。</p>
<p><code>dump</code>函数并不会打印所有的输出，除非开启了debug。</p>
<p><code>dump</code>函数用于打印单个变量的信息或者模版中的所有变量。</p>
<h4 id="单个变量">单个变量</h4><p>如果你的模版中有一个title变量，下面在你的模版中dump出这个变量的内容：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; dump<span class="list">(<span class="keyword">title</span>)</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="模版中的所有变量">模版中的所有变量</h4><p>要打印出模版中的所有的变量，你可以：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; dump<span class="list">()</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p>要打印出变量的键：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; dump<span class="list">(<span class="keyword">_context</span>|keys)</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p>PS: 这里的_context是一全局变量，指当前模版中所有的上下文和变量，比如通过theme函数传递的变量，preprocess函数处理的变量，或者调用set设置的变量。</p>
<p><strong>全局变量：</strong></p>
<ul>
<li>_context 当前模版中所有的上下文和变量</li>
<li>_charset 只当前的编码方式</li>
</ul>
<h4 id="慎用dump()">慎用dump()</h4><p><code>dump()</code>函数虽然可以输出所有的变量，但是却带来了巨大的内存消耗，故你可以循环<code>_context</code>来查看所有的键：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">ol</span>&gt;</span></span><br><span class="line">  </span><span class="template_tag">&#123;% <span class="keyword">for</span> key, value <span class="keyword">in</span> _context  %&#125;</span><span class="xml"></span><br><span class="line">    <span class="tag">&lt;<span class="title">li</span>&gt;</span></span><span class="variable">&#123;&#123; key &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">  </span><span class="template_tag">&#123;% <span class="keyword">endfor</span> %&#125;</span><span class="xml"></span><br><span class="line"><span class="tag">&lt;/<span class="title">ol</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>接下来再加上一些条件判断，就可以看到你需要的变量了。</p>
<h2 id="Drupal8主题">Drupal8主题</h2><h3 id="模版命名惯例">模版命名惯例</h3><p>Drupal是按照一定的命名惯例来加载模版的，这就方便开发者可以覆盖原有的模版。当然，记得清除缓存。</p>
<h4 id="HTML">HTML</h4><p>HTML模版提供了包括head，title以及body标签等基础结构的html页面。</p>
<p>基础模版：html.html.twig(位于：core/modules/system/templates/html.html.twig)</p>
<p>下面是一些你可以覆盖的基础模版的例子：</p>
<ol>
<li>html—internalviewpath.html.twig</li>
<li>html—node—id.html.twig</li>
<li>html.html.twig</li>
</ol>
<h4 id="Page">Page</h4><p>模版名称模式：page—[front|internal/path].html.twig</p>
<p>基础模版：page.html.twig(位于: core/modules/system/templates/page.html.twig)</p>
<p>下面是page模版的模版建议，举个例子“<a href="http://www.example.com/node/1/edit”：" target="_blank" rel="external">http://www.example.com/node/1/edit”：</a></p>
<ol>
<li>page—node—edit.html.twig</li>
<li>page—node—1.html.twig</li>
<li>page—node.html.twig</li>
<li>page.html.twig</li>
</ol>
<h4 id="Regions">Regions</h4><p>模版名称模式：region—[region].html.twig</p>
<p>基础模版：region.html.twig(位于: core/modules/system/templates/region.html.twig)</p>
<p>当一个页面的区域中有内容时，系统会从区块系统或者一个类似于<code>hook_page_build()</code>的方法中调用区域模版。</p>
<h4 id="Blocks">Blocks</h4><p>模版名称模式：block—[module|-delta]].html.twig</p>
<p>基础模版：block.html.twig (位于: core/modules/block/templates/block.html.twig)</p>
<ol>
<li>block—module—delta.html.twig</li>
<li>block—module.html.twig</li>
<li>block.html.twig</li>
</ol>
<p>这里的module就是模块名，delta是模块给区块设置的内部id标识</p>
<h4 id="Nodes">Nodes</h4><p>模版名称模式：node—[type|nodeid]—[viewmode].html.twig<br>基础模版：node.html.twig (位于: core/modules/node/templates/node.html.twig)</p>
<p>模版建议：</p>
<ol>
<li>node—nodeid—viewmode.html.twig</li>
<li>node—nodeid.html.twig</li>
<li>node—type—viewmode.html.twig</li>
<li>node—type.html.twig</li>
<li>node—viewmode.html.twig</li>
<li>node.html.twig</li>
</ol>
<h4 id="Forums">Forums</h4><p>模版名称模式：forums—[[container|topic]—forumID].html.twig</p>
<p>基础模版： forums.html.twig (位于: core/modules/forum/templates/forums.html.twig)</p>
<p>模版建议：</p>
<ul>
<li><p>论坛容器：</p>
<ol>
<li>forums—containers—forumID.html.twig</li>
<li>forums—forumID.html.twig</li>
<li>forums—containers.html.twig</li>
<li>forums.html.twig</li>
</ol>
</li>
<li><p>论坛主题内容</p>
<ol>
<li>forums—topics—forumID.html.twig</li>
<li>forums—forumID.html.twig</li>
<li>forums—topics.html.twig</li>
<li>forums.html.twig</li>
</ol>
</li>
</ul>
<h3 id="PHPTemplate与Twig主题范例的比较">PHPTemplate与Twig主题范例的比较</h3><p>接下来，看下PHPTemplate与Twig的区别。</p>
<h4 id="关于Twig">关于Twig</h4><p>Twig是基于php的编译模版语言。当你的页面需要渲染显示的时候，Twig引擎会找到对应的模版并把它编译成php模版，存放在sites/default/files/php_storage/目录下。</p>
<h5 id="1-Docblock">1.Docblock</h5><p>PHPTemplate：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> </span><br><span class="line"><span class="comment">/** </span><br><span class="line"> *<span class="phpdoc"> @file</span></span><br><span class="line"> * File description</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment"># </span></span><br><span class="line">/<span class="keyword">*</span><span class="keyword">*</span> </span><br><span class="line"> <span class="keyword">*</span> <span class="comment">@file</span></span><br><span class="line"> <span class="keyword">*</span> File description</span><br><span class="line"> <span class="keyword">*</span>/</span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-文件和函数名">2.文件和函数名</h5><p>PHPTemplate文件：node—article.tpl.php<br>Twig文件：node—article.html.twig</p>
<p>PHPTemplate函数：theme_node_links()<br>Twig文件：node-links.html.twig</p>
<h5 id="3-变量">3.变量</h5><p><strong>输出一个变量</strong></p>
<p>PHPTemplate: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content"</span>&gt;</span><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> <span class="variable">$content</span>; <span class="preprocessor">?&gt;</span></span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content"</span>&gt;</span></span><span class="expression">&#123;&#123; <span class="variable">content</span> &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>输出一个哈希键值</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> <span class="variable">$item</span>[<span class="string">'#item'</span>][<span class="string">'alt'</span>]; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">item</span>['<span class="begin-block">#item</span>']<span class="variable">.alt</span> &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>变量赋值</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="variable">$custom_var</span> = <span class="variable">$content</span>-&gt;comments; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">set</span> custom_var = content.comments %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>数组初始化</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">  <span class="variable">$args</span> = <span class="keyword">array</span>(<span class="string">'!author'</span> =&gt; <span class="variable">$author</span>, <span class="string">'!date'</span> =&gt; <span class="variable">$created</span>);</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="preprocessor">%</span> set args = &#123;<span class="string">'!author'</span>: author, <span class="string">'!date'</span>: created&#125; <span class="preprocessor">%</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-条件判断">4.条件判断</h5><p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">if</span> (<span class="variable">$content</span>-&gt;comments): <span class="keyword">endif</span>; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">if</span> content.comments %&#125;</span><span class="xml"> </span><span class="template_tag">&#123;% <span class="keyword">endif</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$content</span>-&gt;comments)): <span class="keyword">endif</span>; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">if</span> content.comments is not <span class="keyword">empty</span> %&#125;</span><span class="xml"> </span><span class="template_tag">&#123;% <span class="keyword">endif</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$content</span>-&gt;comments)): <span class="keyword">endif</span>; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">if</span> content.comments is defined %&#125;</span><span class="xml"> </span><span class="template_tag">&#123;% <span class="keyword">endif</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">if</span> (<span class="variable">$count</span> &gt; <span class="number">0</span>): <span class="keyword">endif</span>; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">if</span> count &gt; 0 %&#125;</span><span class="xml"> </span><span class="template_tag">&#123;% <span class="keyword">endif</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<h5 id="5-控制结构">5.控制结构</h5><p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;&#125; <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">for</span> user <span class="keyword">in</span> users %&#125;</span><span class="xml"> </span><span class="template_tag">&#123;% <span class="keyword">endfor</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<h5 id="6-过滤">6.过滤</h5><p><strong>check_plain：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> check_plain(<span class="variable">$title</span>); <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="variable">&#123;&#123; title<span class="filter">|<span class="keyword">striptags</span></span> &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>Translate：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> t(<span class="string">'Home'</span>); <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; '<span class="variable">Home</span>'|<span class="variable">t</span> &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>Translate with substitutions:</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">  <span class="keyword">print</span> t(<span class="string">'Welcome, @username'</span>, <span class="keyword">array</span>(<span class="string">'@username'</span> =&gt; <span class="variable">$user</span>-&gt;name));</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; '<span class="variable">Welcome</span>, @<span class="variable">username</span>'|<span class="variable">t</span>(&#123; '@<span class="variable">username</span>': <span class="variable">user.name</span> &#125;) &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>Drupal8 Twig(采用<a href="https://drupal.org/node/2047135" target="_blank" rel="external">trans</a>标签扩展)</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% set username = user.name %&#125;</span><span class="xml"></span><br><span class="line"></span><span class="template_tag">&#123;% <span class="keyword">trans</span> %&#125;</span><span class="xml"></span><br><span class="line">  Welcome, </span><span class="variable">&#123;&#123; username &#125;&#125;</span><span class="xml"></span><br><span class="line"></span><span class="template_tag">&#123;% endtrans %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>implode:</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">echo</span> implode(<span class="string">', '</span>, <span class="variable">$usernames</span>); <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Twig:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; usernames | join<span class="list">(<span class="keyword">'</span>, ')</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p>PHPTemplate的例子中$usernames需要是一个字符串数组。原生的Twig也需要$usernames是一个字符串数组。但是Drupal8中的twig还可以是一个可以渲染的数组对象。这就是Drupal8中的twig与原生twig的本质区别。Drupal8中的twig可以“打印”出纯文本和可渲染的数组。</p>
<p>举个例子：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">set</span> numbers = [&#123;<span class="string">'#markup'</span>: <span class="string">'One'</span>&#125;, &#123;<span class="string">'#markup'</span>:<span class="string">'Two'</span>&#125;, &#123;<span class="string">'#markup'</span>:<span class="string">'Three'</span>&#125;] %&#125;</span><br><span class="line">&#123;&#123; numbers &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的例子中，每一个数据项都是以逗号相隔的。但是，输出的结果却是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OneTwoThree</span><br></pre></td></tr></table></figure>
<p><strong>Escape：</strong></p>
<p>PHPTemplate:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">echo</span> check_plain(<span class="variable">$title</span>); <span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>原生Twig:</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">title</span>|<span class="variable">e</span> &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>Drupal 8 Twig2:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; title &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="7-空白">7.空白</h5><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"body"</span>&gt;</span></span><br><span class="line">  </span><span class="expression">&#123;&#123;<span class="variable">-</span> <span class="variable">block.content</span> <span class="variable">-</span>&#125;&#125;</span><span class="xml"></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>类似于</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"body"</span>&gt;</span></span><span class="expression">&#123;&#123; <span class="variable">block.content</span> &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="debug_twig模版">debug twig模版</h3><p>twig模版引擎提供了一个debug工具。</p>
<h4 id="启用debugging">启用debugging</h4><p>在sites/default/services.yml启用Twig Debugging。</p>
<p>设置debug变量为true</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">parameters:</span></span><br><span class="line">  twig.<span class="string">config:</span></span><br><span class="line"><span class="label">    debug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="自动加载编译的模版">自动加载编译的模版</h4><p>出于性能考虑，Twig模版被编译成一个PHP类存放在磁盘上，但这意味着默认情况下，你的模版不会在你做出更改时发生刷新。为了使Twig模版可以自动刷新，启用<code>services.yml</code>中的deubg选项。欲知详情，参见：<a href="https://drupal.org/node/1903374" target="_blank" rel="external">https://drupal.org/node/1903374</a></p>
<p><strong>打印所有的变量</strong></p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;# 打印所有的变量 #&#125;</span></span><br><span class="line"><span class="collection">&#123;<span class="collection">&#123; dump<span class="list">()</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;# 打印单个变量 #&#125;</span></span><br><span class="line"><span class="collection">&#123;<span class="collection">&#123; dump<span class="list">(<span class="keyword"><span class="built_in">var</span></span>)</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Filters—-修改Twig模版中的变量">Filters—-修改Twig模版中的变量</h3><p>Twig中的Filters用于修改变量。Filters和变量之间用管道符号(|)分隔，还可能带点可选的参数。多个filters可以链式的连在一起，前一个的输出作为下一个的输入。</p>
<p>例如：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">ponies</span>|<span class="variable">safe</span>_<span class="variable">join</span>(<span class="string">", "</span>)|<span class="variable">lower</span>&#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>Drupal的Twig模版中使用的filter由所有的Twig引擎自带的filter和drupal中的几个特殊的filters组成。</p>
<h4 id="Twig_filters">Twig filters</h4><p>详见：<a href="http://twig.sensiolabs.org/doc/filters/index.html" target="_blank" rel="external">twig filter列表</a></p>
<h4 id="Drupal自身的filters">Drupal自身的filters</h4><p>Drupal中的filters是在<code>Drupal\Core\Template\TwigExtension::getFilters().</code>中声明的。</p>
<h5 id="翻译filters">翻译filters</h5><p><strong>t</strong></p>
<p>t filter调用Drupal的t函数翻译给定的字符串，可用于任何字符串。</p>
<p>例如：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"</span></span></span><span class="expression">&#123;&#123; <span class="variable">url</span>('&lt;<span class="variable">front</span>&gt;') &#125;&#125;</span><span class="xml"><span class="tag"><span class="value">"</span> <span class="attribute">title</span>=<span class="value">"</span></span></span><span class="expression">&#123;&#123; '<span class="variable">Home</span>'|<span class="variable">t</span> &#125;&#125;</span><span class="xml"><span class="tag"><span class="value">"</span> <span class="attribute">rel</span>=<span class="value">"home"</span> <span class="attribute">class</span>=<span class="value">"site-logo"</span>&gt;</span><span class="tag">&lt;/<span class="title">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>placeholder输出安全的html并使用<code>drupal_placeholder()</code>进行格式化输出成强调文本。</p>
<p>例如：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">trans</span> %&#125;</span><span class="xml">Submitted on </span><span class="variable">&#123;&#123; date<span class="filter">|placeholder</span> &#125;&#125;</span><span class="xml"></span><span class="template_tag">&#123;% endtrans %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; var1|t &#125;</span>&#125;</span></span><br><span class="line"><span class="collection">&#123;<span class="collection">&#123; var1|placeholder &#125;</span>&#125;</span></span><br><span class="line"><span class="collection">&#123;% trans %&#125;</span><span class="collection">&#123;<span class="collection">&#123; var1 &#125;</span>&#125;</span><span class="collection">&#123;% endtrans %&#125;</span></span><br></pre></td></tr></table></figure>
<p>尽可能避免使用|raw filter，特别是你正在输出一些用户输入的数据的时候。详见<a href="https://www.drupal.org/node/2296163" target="_blank" rel="external">https://www.drupal.org/node/2296163</a>：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">var</span>1|<span class="variable">raw</span> &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<h5 id="额外的filters">额外的filters</h5><p><strong>drupal_escape</strong></p>
<p>drupal_escape用于将一个字符串进行安全处理后进行插入操作并输出显示，它替代了twig默认的escape filter。参见<a href="https://api.drupal.org/api/drupal/core%21themes%21engines%21twig%21twig.engine/function/twig_drupal_escape_filter/8" target="_blank" rel="external">twig_drupal_escape_filter</a></p>
<p><strong>safe_join</strong></p>
<p>safe_join将几个字符串用给定的分隔符连接在一块儿。</p>
<p>例如：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; items|safe_join<span class="list">(<span class="keyword">'</span>, ')</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>without</strong></p>
<p>without会创建出当前这个可以渲染的数组的拷贝，但是会把传入的参数当作键，删除键关联的所有子元素。但是，当前这个数组不受影响，依旧可以打印出子元素。详见：<a href="https://api.drupal.org/api/drupal/core%21themes%21engines%21twig%21twig.engine/function/twig_without/8" target="_blank" rel="external">twig_without</a></p>
<p>例如：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;# 打印content变量，除了content.links #&#125;</span></span><br><span class="line"><span class="collection">&#123;<span class="collection">&#123; content|without<span class="list">(<span class="keyword">'links'</span>)</span> &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>clean_class</strong></p>
<p>clean_class filter会处理出一个安全的可用的html类名。详见：<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Html.php/function/Html%3A%3AgetClass/8" target="_blank" rel="external">Html::getClass()</a></p>
<p><strong>clean_id</strong></p>
<p>clean_id filter会处理出一个安全的可用的html id。详见：<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Component%21Utility%21Html.php/function/Html%3A%3AgetId/8" target="_blank" rel="external">Html:getID()</a></p>
<p><strong>format_date</strong></p>
<p>format_date filter格式化日期字符串，详见：<a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Datetime!DateFormatter.php/function/DateFormatter%3A%3Aformat/8" target="_blank" rel="external">DateFormatter::format()</a></p>
<h3 id="Functions—-Twig模版中的函数">Functions—-Twig模版中的函数</h3><p><strong>url()</strong></p>
<p><strong>path()</strong></p>
<p><strong>url_from_path()</strong></p>
<p><strong>link($text, $url, $attributes)</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">link</span>(<span class="variable">item.title</span>, <span class="variable">item.url</span>, &#123; '<span class="variable">class</span>':['<span class="variable">foo</span>', '<span class="variable">bar</span>', '<span class="variable">baz</span>']&#125; ) &#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p><strong>file_url($uri)</strong></p>
<p>路径参数需要是相对网站根目录的相对路径，将会返回这个文件的绝对路径。</p>
<p><strong>attach_library()</strong></p>
<h3 id="Twig最佳实践—-预处理函数和模版">Twig最佳实践—-预处理函数和模版</h3><p>为了使Drupal8的主题性能最大化，以及更加的定制化，请遵照如下的最佳实践方式：</p>
<h4 id="使用预处理函数返回可渲染数组">使用预处理函数返回可渲染数组</h4><p>总是通过预处理函数返回可渲染数组，而不是调用<code>theme()</code>或者<code>drupal_render()</code>函数。</p>
<p>Twig会自动渲染，故没有必要调用<code>theme()</code>或者<code>drupal_render()</code>函数。此外，为了比直接输出已经渲染的html代码更具定制化，渲染数组应该传递给模版。</p>
<p>从预处理函数中删除<code>theme()</code>函数：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">// 之前，直接把渲染的html传递给模版</span></span><br><span class="line"><span class="variable">$variables</span>[<span class="string">'table'</span>] = theme(<span class="string">'table'</span>, <span class="keyword">array</span>(<span class="string">'header'</span> =&gt; <span class="variable">$header</span>, <span class="string">'rows'</span> =&gt; <span class="variable">$rows</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后，把渲染数组传递给模版</span></span><br><span class="line"><span class="variable">$variables</span>[<span class="string">'table'</span>] = <span class="keyword">array</span>(</span><br><span class="line">  <span class="string">'#theme'</span> =&gt; <span class="string">'table'</span>,</span><br><span class="line">  <span class="string">'#header'</span> =&gt; <span class="variable">$header</span>,</span><br><span class="line">  <span class="string">'#rows'</span> =&gt; <span class="variable">$rows</span>,</span><br><span class="line">);</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>从预处理函数中删除<code>drupal_render()</code>函数就是不再调用它：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">// 之前</span></span><br><span class="line"><span class="variable">$variables</span>[<span class="string">'teaser'</span>] = drupal_render(<span class="variable">$node_teaser</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后</span></span><br><span class="line"><span class="variable">$variables</span>[<span class="string">'teaser'</span>] = <span class="variable">$node_teaser</span>;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>通常情况下，<code>drupal_render()</code>函数是在添加表格数据的时候调用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">// 之前</span></span><br><span class="line"><span class="variable">$row</span>[] = drupal_render(<span class="variable">$display</span>[<span class="string">'title'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之后  </span></span><br><span class="line"><span class="variable">$row</span>[][<span class="string">'data'</span>] = <span class="variable">$display</span>[<span class="string">'title'</span>];</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="在模版中调用filters和工具函数">在模版中调用filters和工具函数</h4><p>举个例子：</p>
<p><strong>之前的做法：</strong></p>
<p>预处理函数中：</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$variables[<span class="symbol">'no_content_text'</span>] = t(<span class="symbol">'You</span> have not created any content types yet. <span class="type">Go</span> <span class="keyword">to</span> the &lt;a href=<span class="string">"@create-content"</span>&gt;content <span class="keyword">type</span> creation page&lt;/a&gt; <span class="keyword">to</span> add a <span class="keyword">new</span> content <span class="keyword">type</span>.<span class="char">', array('</span>@create-content' =&gt; url(<span class="symbol">'admin</span>/structure/types/add')));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>模版中：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><span class="expression">&#123;&#123; <span class="variable">no</span>_<span class="variable">content</span>_<span class="variable">text</span> &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>现在的做法：</strong></p>
<p>模版中：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span><span class="expression">&#123;&#123; '<span class="variable">You</span> <span class="variable">have</span> <span class="variable">not</span> <span class="variable">created</span> <span class="variable">any</span> <span class="variable">content</span> <span class="variable">types</span> <span class="variable">yet.</span> <span class="variable">Go</span> <span class="variable">to</span> <span class="variable">the</span> &lt;<span class="variable">a</span> <span class="variable">href</span>=<span class="string">"@create-content"</span>&gt;<span class="variable">content</span> <span class="variable">type</span> <span class="variable">creation</span> <span class="variable">page</span>&lt;<span class="end-block">/a</span>&gt; <span class="variable">to</span> <span class="variable">add</span> <span class="variable">a</span> <span class="variable">new</span> <span class="variable">content</span> <span class="variable">type.</span>'|<span class="variable">t</span>(&#123;'@<span class="variable">create-content</span>': <span class="variable">url</span>('<span class="variable">admin</span><span class="end-block">/structure</span><span class="end-block">/types</span><span class="end-block">/add</span>')&#125;) &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="显示/隐藏_&amp;_删除drupal_render_children和element_children">显示/隐藏 &amp; 删除drupal_render_children和element_children</h4><p>在原始的模版中，如果调用了<code>hide()</code>函数，而且<code>drupal_render_children</code>函数用于输出”剩下的“数据，我们将需要在预处理的时候把这些数据拆分成单个变量。</p>
<p><strong>之前(PHPTemplate模版)：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">  hide(<span class="variable">$form</span>[<span class="string">'advanced'</span>]);</span><br><span class="line">  hide(<span class="variable">$form</span>[<span class="string">'actions'</span>]);</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-node-form clearfix"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-main"</span>&gt;</span></span><br><span class="line">    <span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> drupal_render_children(<span class="variable">$form</span>); <span class="preprocessor">?&gt;</span></span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-secondary"</span>&gt;</span></span><br><span class="line">    <span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> render(<span class="variable">$form</span>[<span class="string">'advanced'</span>]); <span class="preprocessor">?&gt;</span></span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-footer"</span>&gt;</span></span><br><span class="line">    <span class="php"><span class="preprocessor">&lt;?php</span> <span class="keyword">print</span> render(<span class="variable">$form</span>[<span class="string">'actions'</span>]); <span class="preprocessor">?&gt;</span></span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>之后(预处理)：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">template_preprocess_node_edit_form</span><span class="params">(&amp;<span class="variable">$variables</span>)</span> </span>&#123;</span><br><span class="line">  <span class="variable">$form</span> = <span class="variable">$variables</span>[<span class="string">'form'</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// @todo Update this once drupal.org/node/1920886 is resolved.</span></span><br><span class="line">  <span class="variable">$variables</span>[<span class="string">'advanced'</span>] = <span class="variable">$form</span>[<span class="string">'advanced'</span>];</span><br><span class="line">  <span class="variable">$variables</span>[<span class="string">'actions'</span>] = <span class="variable">$form</span>[<span class="string">'actions'</span>];</span><br><span class="line">  <span class="keyword">unset</span>(<span class="variable">$form</span>[<span class="string">'advanced'</span>], <span class="variable">$form</span>[<span class="string">'actions'</span>]);</span><br><span class="line">  <span class="variable">$variables</span>[<span class="string">'form'</span>] = drupal_render_children(<span class="variable">$form</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>之后(Twig模版)：</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-node-form clearfix"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-main"</span>&gt;</span></span><br><span class="line">    </span><span class="expression">&#123;&#123; <span class="variable">form</span>|<span class="variable">without</span>('<span class="variable">advanced</span>', '<span class="variable">actions</span>') &#125;&#125;</span><span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-secondary"</span>&gt;</span></span><br><span class="line">    </span><span class="expression">&#123;&#123; <span class="variable">form.advanced</span> &#125;&#125;</span><span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"layout-region layout-region-node-footer"</span>&gt;</span></span><br><span class="line">    </span><span class="expression">&#123;&#123; <span class="variable">form.actions</span> &#125;&#125;</span><span class="xml"></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="创建Drupal8的主题">创建Drupal8的主题</h2><h3 id="以一个-info-yml文件开始定义一个主题">以一个.info.yml文件开始定义一个主题</h3><p>创建drupal8主题的第一步，就是创建一个THEMENAME.info.yml文件。有一点很重要，.info.yml文件中的“type”键需要设置成“theme”。</p>
<h4 id="创建一个-info-yml文件">创建一个.info.yml文件</h4><p>在主题文件夹的根目录创建.info.yml文件。文件夹的名字应该保持与.info.yml文件名相同。所以，如果你的主题命名为“Fluffiness”，那么文件夹的名字就是“fluffiness”，而.info.yml文件的名字是“fluffiness/fluffiness.info.yml”。</p>
<p>例如：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">name</span>: Fluffiness</span><br><span class="line"><span class="attribute">type</span>: theme</span><br><span class="line"><span class="attribute">description</span>: A cuddly theme that offers extra fluffiness.</span><br><span class="line"><span class="attribute">core</span>: <span class="number">8</span>.x</span><br><span class="line"><span class="attribute">libraries</span>:</span><br><span class="line">  - fluffiness/global-styling</span><br><span class="line"><span class="attribute">stylesheets-remove</span>:</span><br><span class="line">  - <span class="string">'@classy/css/components/tabs.css'</span></span><br><span class="line">  - core/assets/vendor/normalize-css/normalize.css</span><br><span class="line"><span class="attribute">regions</span>:</span><br><span class="line">  <span class="attribute">header</span>: Header</span><br><span class="line">  <span class="attribute">content</span>: Content</span><br><span class="line">  <span class="attribute">sidebar_first</span>: <span class="string">'Sidebar first'</span></span><br><span class="line">  <span class="attribute">footer</span>: Footer</span><br></pre></td></tr></table></figure>
<p>在你的drupal站点中，核心提供的主题包含着很多.info.yml文件可以供你查阅实例。</p>
<h4 id="配置文件中的键释义">配置文件中的键释义</h4><ul>
<li>name: Fluffiness  必选。显示在站点外观页面的，可读主题名</li>
<li>description: An extra cuddly Drupal theme available in grey and blue  必选，主题描述，也会显示在站点外观管理页面</li>
<li>type: theme  必选项，扩展类型，比如：module, theme 或者 profile。对于主题，这里设置成“theme”</li>
<li>base theme: classy  可以从另一个主题继承其资源的主题</li>
<li>core: 8.x  必选，当前主题兼容的Drupal版本</li>
<li>version: 8.x-1.0</li>
<li>screenshot: fluffiness.png</li>
<li><p>libraries:</p>
<ul>
<li><p>fluffiness/global-styling</p>
<p>当主题启用时，为所有的页面加载资源库文件，包括css和js</p>
<p>例如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">global-<span class="string">styling:</span></span><br><span class="line"><span class="label">  version:</span> <span class="number">1.</span>x</span><br><span class="line"><span class="label">  css:</span></span><br><span class="line"><span class="label">    theme:</span></span><br><span class="line">      css/style.<span class="string">css:</span> &#123;&#125;</span><br><span class="line">      css/print.<span class="string">css:</span> &#123; <span class="string">media:</span> print &#125;</span><br></pre></td></tr></table></figure>
<p>当html解析时，就会是：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;link <span class="variable">rel=</span><span class="string">"stylesheet"</span> <span class="variable">href=</span><span class="string">"css/style.css"</span> <span class="variable">media=</span><span class="string">"all"</span> /&gt;</span><br><span class="line">&lt;link <span class="variable">rel=</span><span class="string">"stylesheet"</span> <span class="variable">href=</span><span class="string">"css/print.css"</span> <span class="variable">media=</span><span class="string">"print"</span> /&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>stylesheets-remove:</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"> core/assets/vendor/normalize-css/normalize.css <span class="comment"># 1</span></span><br><span class="line"></span>-<span class="ruby"> <span class="string">'@classy/css/components/tabs.css'</span> <span class="comment"># 2</span></span></span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ol>
<li>stylesheets-remove键定义需要删除的样式，需要设置成完全路径。</li>
<li>为了方式Drupal核心的资源（例如，jQuery UI的css文件）被删除，请设置为完全路径。此外，为了避免当前这个文件属于某个模块或者主题提供的库的，可以使用token。注意，如果使用token，由于@会被当成YAML，请记得使用引号。</li>
</ol>
</li>
<li><p>regions:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">header</span>: <span class="string">Header</span></span><br><span class="line"><span class="attribute">content</span>: <span class="string">Content # required!</span></span><br><span class="line"><span class="attribute">sidebar_first</span>: <span class="string">'Sidebar first'</span></span><br><span class="line"><span class="attribute">footer</span>: <span class="string">Footer</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="主题文件夹的结构">主题文件夹的结构</h3><p>主题就是定了视图层的许多文件的集合。.info.yml文件是必须的，下面会列出一个典型的主题文件夹中所包含的文件和文件夹。</p>
<h4 id="主题的位置">主题的位置</h4><p>主题必须放置在Drupal安装根目录的“themes”文件夹中。注意，核心的主题，例如：Bartik和Seven位于core/themes文件夹下。</p>
<p>一个好的建议是，创建一个名为“contrib”的文件夹用于存放下载的贡献主题，而“custom”文件夹用于存放自定义的主题。</p>
<p>主体名称必须小写。</p>
<h4 id="Drupal的目录结构：">Drupal的目录结构：</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-core</span></span><br><span class="line"><span class="string">|  |-modules</span></span><br><span class="line"><span class="string">|  |-themes</span></span><br><span class="line"><span class="string">|  |  |-bartik</span></span><br><span class="line"><span class="string">|  |  |-seven</span></span><br><span class="line">..</span><br><span class="line"><span class="string">|-modules</span></span><br><span class="line"><span class="string">|-themes</span></span><br><span class="line"><span class="string">|  |-contrib</span></span><br><span class="line"><span class="string">|  |  |-zen</span></span><br><span class="line"><span class="string">|  |  |-basic</span></span><br><span class="line"><span class="string">|  |  |-bluemarine</span></span><br><span class="line"><span class="string">|  |-custom</span></span><br><span class="line"><span class="string">|  |  |-fluffiness</span></span><br></pre></td></tr></table></figure>
<h4 id="主题文件夹结构，假设主题名称是：fluffiness">主题文件夹结构，假设主题名称是：fluffiness</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-fluffiness.breakpoints.yml</span></span><br><span class="line"><span class="string">|-fluffiness.info.yml</span></span><br><span class="line"><span class="string">|-fluffiness.libraries.yml</span></span><br><span class="line"><span class="string">|-fluffiness.theme</span></span><br><span class="line"><span class="string">|-config</span></span><br><span class="line"><span class="string">|  |-install</span></span><br><span class="line"><span class="string">|  |  |-fluffiness.settings.yml</span></span><br><span class="line"><span class="string">|  |-schema</span></span><br><span class="line"><span class="string">|  |  |-fluffiness.schema.yml</span></span><br><span class="line"><span class="string">|-css</span></span><br><span class="line"><span class="string">|  |-style.css</span></span><br><span class="line"><span class="string">|-js</span></span><br><span class="line"><span class="string">|  |-fluffiness.js</span></span><br><span class="line"><span class="string">|-images</span></span><br><span class="line"><span class="string">|  |-buttons.png</span></span><br><span class="line"><span class="string">|-logo.png</span></span><br><span class="line"><span class="string">|-screenshot.png</span></span><br><span class="line"><span class="string">|-templates</span></span><br><span class="line"><span class="string">|  |-maintenance-page.html.twig</span></span><br><span class="line"><span class="string">|  |-node.html.twig</span></span><br></pre></td></tr></table></figure>
<p>下面，介绍一下主题文件夹中的通用文件。</p>
<h4 id="*-info-yml">*.info.yml</h4><p>主题必须包含*.info.yml文件，此文件定义了meta数据，样式，还有区块和区域信息。</p>
<h4 id="*-libraries-yml">*.libraries.yml</h4><p>*.libraries.yml文件用于主题启用时需要加载的定义js和css库，详情<a href="https://www.drupal.org/theme-guide/8/adding-javascript" target="_blank" rel="external">点击这里</a></p>
<h4 id="*-breakpoints-yml">*.breakpoints.yml</h4><p>响应式设计相关的设置，详见：<a href="https://www.drupal.org/documentation/modules/breakpoint" target="_blank" rel="external">*.breakpoints.yml设置</a></p>
<h4 id="*-theme">*.theme</h4><p>*.theme文件是一个php文件，包含了所有的逻辑处理代码和输出前的预处理。</p>
<h4 id="css/">css/</h4><p>一个好的建议就是将css文件存放在“css”自目录下。</p>
<h4 id="js/">js/</h4><p>存放着主题需要的js文件。</p>
<h4 id="images/">images/</h4><p>存放主题需要的图片</p>
<h4 id="screenshot-png">screenshot.png</h4><p>主题的预览图</p>
<h4 id="templates/">templates/</h4><h4 id="核心主题Bartik的目录结构：">核心主题Bartik的目录结构：</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-bartik.breakpoints.yml</span></span><br><span class="line"><span class="string">|-bartik.info.yml</span></span><br><span class="line"><span class="string">|-bartik.libraries.yml</span></span><br><span class="line"><span class="string">|-bartik.theme</span></span><br><span class="line"><span class="string">|-color</span></span><br><span class="line"><span class="string">|  |-color.inc</span></span><br><span class="line"><span class="string">|  |-preview.css</span></span><br><span class="line"><span class="string">|  |-preview.html</span></span><br><span class="line"><span class="string">|  |-preview.js</span></span><br><span class="line"><span class="string">|-config</span></span><br><span class="line"><span class="string">|  |-schema</span></span><br><span class="line"><span class="string">|  |  |-bartik.schema.yml</span></span><br><span class="line"><span class="string">|-css</span></span><br><span class="line"><span class="string">|  |-base</span></span><br><span class="line"><span class="string">|  |  |-elements.css</span></span><br><span class="line"><span class="string">|  |-components</span></span><br><span class="line"><span class="string">|  |  |-block.css</span></span><br><span class="line"><span class="string">|  |  |-book.css</span></span><br><span class="line"><span class="string">|  |  |-breadcrumb.css</span></span><br><span class="line">...</span><br><span class="line"><span class="string">|  |-colors.css</span></span><br><span class="line"><span class="string">|  |-layout.css</span></span><br><span class="line"><span class="string">|  |-maintenance-page.css</span></span><br><span class="line"><span class="string">|  |-print.css</span></span><br><span class="line"><span class="string">|-images</span></span><br><span class="line"><span class="string">|  |-add.png</span></span><br><span class="line"><span class="string">|  |-required.svg</span></span><br><span class="line"><span class="string">|  |-tabs-border.png</span></span><br><span class="line"><span class="string">|-logo.svg</span></span><br><span class="line"><span class="string">|-screenshot.png</span></span><br><span class="line"><span class="string">|-templates</span></span><br><span class="line"><span class="string">|  |-block--search-form-block.html.twig</span></span><br><span class="line"><span class="string">|  |-block--system-branding-block.html.twig</span></span><br><span class="line"><span class="string">|  |-block--system-menu-block.html.twig</span></span><br><span class="line"><span class="string">|  |-block.html.twig</span></span><br><span class="line"><span class="string">|  |-comment.html.twig</span></span><br><span class="line"><span class="string">|  |-field--taxonomy-term-reference.html.twig</span></span><br><span class="line"><span class="string">|  |-maintenance-page.html.twig</span></span><br><span class="line"><span class="string">|  |-node.html.twig</span></span><br><span class="line"><span class="string">|  |-page.html.twig</span></span><br><span class="line"><span class="string">|  |-status-messages.html.twig</span></span><br></pre></td></tr></table></figure>
<h3 id="为主题添加区域">为主题添加区域</h3><p>为主题添加区域需要两步：</p>
<ul>
<li>在主题文件.info.yml中添加区域的meta-data</li>
<li>编辑page.html.twig文件打印新的区域</li>
</ul>
<h4 id="info文件中添加区域">info文件中添加区域</h4><p>区域定义成ragions键的子元素：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Regions</span></span><br><span class="line">regions:</span><br><span class="line">  header: <span class="string">'Header'</span></span><br><span class="line">  <span class="literal">content</span>: <span class="string">'Content'</span></span><br><span class="line">  footer: <span class="string">'Footer'</span></span><br></pre></td></tr></table></figure>
<p>Region 键应是个字符串，可以包含下划线“_”。</p>
<h4 id="模版中添加区域">模版中添加区域</h4><p>为了显示区域中的内容，你需要确定新的区域也添加到了page.html.twig模版中。</p>
<p>例如：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">header</span>: <span class="string">'Header'</span></span><br></pre></td></tr></table></figure>
<p>模版中输出：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;<span class="collection">&#123; page.header &#125;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p>此外，你可以把它们当成是Twig模版的普通变量，可以再任何需要的地方打印输出。</p>
<h4 id="默认区域">默认区域</h4><p>可以在<a href="https://api.drupal.org/api/drupal/core%21modules%21system%21templates%21page.html.twig/8" target="_blank" rel="external">page.html.twig模版文档</a>中查阅默认的区域</p>
<ol>
<li>page.header</li>
<li>page.primary_menu</li>
<li>page.secondary_menu</li>
<li>page.highlighted</li>
<li>page.help</li>
<li>page.content</li>
<li>page.sidebar_first</li>
<li>page.sidebar_second</li>
<li>page.footer</li>
<li>page.breadcrumb</li>
</ol>
<h3 id="Drupal8主题中添加样式和js">Drupal8主题中添加样式和js</h3><h4 id="与Drupal7主题的区别">与Drupal7主题的区别</h4><p><strong>有四个比较重要的区别：</strong></p>
<ol>
<li>去掉了THEME.info文件，取而代之的是THEME.info.yml文件</li>
<li>THEME.info.yml文件中的stylesheets属性不复存在，改为库的方式引入</li>
<li>THEME.info.yml文件中的scripts属性不复存在，改为库的方式引入</li>
<li>每一个页面的js只在需要时才加载，默认情况下，Drupal对于匿名用户不会需要js。这意味着，jquery不会再在每个页面自动加载了。因此，如果你的主题需要jquery或者其它的js，你需要通过“声明依赖关系”来告诉Drupal这个js需要加载</li>
</ol>
<p><strong> 加载css/js的步骤：</strong></p>
<ol>
<li>将css或者js保存到一个文件</li>
<li>定义一个包含js和css文件的“library”</li>
<li>在钩子中，把这个库追加给渲染数组</li>
</ol>
<h4 id="定义一个库">定义一个库</h4><p>在主题文件夹中创建*.libraries.yml文件来添加库（假设你的主题名称是<code>fluffiness</code>，那么文件名就是<code>fluffiness.libraries.yml</code>）。每一个库，都是css和js文件的详情列表：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cuddly-<span class="string">slider:</span></span><br><span class="line"><span class="label">  version:</span> <span class="number">1.</span>x</span><br><span class="line"><span class="label">  css:</span></span><br><span class="line"><span class="label">    theme:</span></span><br><span class="line">      css/cuddly-slider.<span class="string">css:</span> &#123;&#125;</span><br><span class="line"><span class="label">  js:</span></span><br><span class="line">    js/cuddly-slider.<span class="string">js:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子中，假设<code>cuddly-slider.js</code>文件位于主题的js子目录中。</p>
<p>然后，需要记住的是，默认情况下，Drupal8不会在每一个页面加载jquery；只在需要时加载。因此，我们需要自己声明，主题的<code>cuddly-slider</code>库依赖<code>jQuery</code>。</p>
<p>因此，为了保证上例的<code>js/cuddly-slider.js</code>可用，我们需要更新下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cuddly-<span class="string">slider:</span></span><br><span class="line"><span class="label">  version:</span> <span class="number">1.</span>x</span><br><span class="line"><span class="label">  css:</span></span><br><span class="line"><span class="label">    theme:</span></span><br><span class="line">      css/cuddly-slider.<span class="string">css:</span> &#123;&#125;</span><br><span class="line"><span class="label">  js:</span></span><br><span class="line">    js/cuddly-slider.<span class="string">js:</span> &#123;&#125;</span><br><span class="line"><span class="label">  dependencies:</span></span><br><span class="line">    - core/jquery</span><br></pre></td></tr></table></figure>
<p>当然，库也可以只包含css，或者只包含js。大部分的主题可能会有一个<code>global-styling</code>库，用于全局加载样式文件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">global-<span class="string">styling:</span></span><br><span class="line"><span class="label">  version:</span> <span class="number">1.</span>x</span><br><span class="line"><span class="label">  css:</span></span><br><span class="line"><span class="label">    theme:</span></span><br><span class="line">      css/layout.<span class="string">css:</span> &#123;&#125;</span><br><span class="line">      css/style.<span class="string">css:</span> &#123;&#125;</span><br><span class="line">      css/colors.<span class="string">css:</span> &#123;&#125;</span><br><span class="line">      css/print.<span class="string">css:</span> &#123; <span class="string">media:</span> print &#125;</span><br></pre></td></tr></table></figure>
<p>而且，正如你所想，库中定义的css的顺序就是将来加载的顺序。</p>
<p>在Drupal7中，你可以把媒体查询属性(screen, print, all)作为<code>stylesheets</code>属性的子键，而现在你可以把它当作值定义，例如：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">css</span>/<span class="tag">print</span><span class="class">.css</span>: &#123; <span class="attribute">media</span>: print &#125;</span><br></pre></td></tr></table></figure>
<p>现在默认情况下，所有的js文件都在页脚加载。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">js-<span class="string">header:</span></span><br><span class="line"><span class="label">  header:</span> <span class="literal">true</span></span><br><span class="line"><span class="label">  js:</span></span><br><span class="line">    header.<span class="string">js:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">js-<span class="string">footer:</span></span><br><span class="line"><span class="label">  js:</span></span><br><span class="line">    footer.<span class="string">js:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>你得设置<code>header</code>属性为true。</p>
<h4 id="覆盖扩展库">覆盖扩展库</h4><p>那些定义在<code>*.libraries.yml</code>文件中的库可以通过主题的<code>*.info.yml</code>文件中的<code>libraries-override</code>和<code>libraries-extend</code>项进行覆写和扩展。</p>
<p><strong>libraries-override</strong></p>
<p><code>libraries-override</code>是定义在库中，主题用来操作css/js的一种方式，包括删除、替换或者删除css/js。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">libraries-override:</span><br><span class="line">  <span class="comment"># Replace an entire library.</span></span><br><span class="line">  core/drupal.collapse: mytheme/collapse</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Replace an asset with another.</span></span><br><span class="line">  subtheme/library:</span><br><span class="line">    css:</span><br><span class="line">      theme:</span><br><span class="line">        css/layout.css: css/<span class="keyword">my</span>-layout.css</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Remove an asset.</span></span><br><span class="line">  drupal/dialog:</span><br><span class="line">    css:</span><br><span class="line">      theme:</span><br><span class="line">        dialog.theme.css: <span class="constant">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Remove an entire library.</span></span><br><span class="line">  core/modernizr: <span class="constant">false</span></span><br></pre></td></tr></table></figure>
<p><strong>libraries-extend</strong></p>
<p><em>libraries-extend</em>为主题提供了一种可以修改库的方式。比如，添加额外的主题依赖的库。</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Extend drupal.user: add assets from classy's user libraries.</span><br><span class="line">libraries-extend:</span><br><span class="line">  core/drupal.user: </span><br><span class="line">    -<span class="ruby"> classy/user1</span><br><span class="line"></span>    -<span class="ruby"> classy/user2</span></span><br></pre></td></tr></table></figure>
<h4 id="追加库到页面中">追加库到页面中</h4><p><strong>在Twig模版中追加库</strong></p>
<p>通过调用twig的方法，<code>attach_library()</code>可以在twig模版中追加库，例如：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="expression">&#123;&#123; <span class="variable">attach</span>_<span class="variable">library</span>('<span class="variable">fluffiness</span><span class="end-block">/cuddly-slider</span>') &#125;&#125;</span><span class="xml"></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span>&gt;</span>Some fluffy markup </span><span class="expression">&#123;&#123; <span class="variable">message</span> &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>追加给所有的页面</strong></p>
<p>为了所有页面都加载这个库，需要在主题的<code>*.info.yml</code>文件中，<code>libraries</code>键的下面声明：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">name:</span> Example</span><br><span class="line"><span class="label">type:</span> theme</span><br><span class="line"><span class="label">core:</span> <span class="number">8.</span><span class="built_in">x</span></span><br><span class="line"><span class="label">libraries:</span></span><br><span class="line">  - fluffiness/cuddly-slider</span><br></pre></td></tr></table></figure>
<h4 id="为一组页面添加库">为一组页面添加库</h4><p>在大部分情况下，你可能不希望所有的页面加载你的库，而是部分页面加载。举个例子来说，你可能只想在某个特定的区块中加载，或者用户访问某个节点类型时加载。</p>
<p>主题可以通过实现<code>THEME_preprocess_HOOK()</code>方法达到这个效果。</p>
<p>例如，你想要在维护页面追加你的库，“HOOK”就是“maintenance_page”，然后你的方法就是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fluffiness_preprocess_maintenance_page</span><span class="params">(&amp;<span class="variable">$variables</span>)</span> </span>&#123;</span><br><span class="line">  <span class="variable">$variables</span>[<span class="string">'#attached'</span>][<span class="string">'library'</span>][] = <span class="string">'fluffiness/cuddly-slider'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>你也可以为主题的其它hook做同样的事情，当然你的函数中也可以包含逻辑处理。</p>
<p><strong>重要提示</strong>：最通用的用法是根据当前的路由来加载库：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fluffiness_preprocess_page</span><span class="params">(&amp;<span class="variable">$variables</span>)</span> </span>&#123;</span><br><span class="line">  <span class="variable">$variables</span>[<span class="string">'#cache'</span>][<span class="string">'contexts'</span>][] = <span class="string">'route'</span>;</span><br><span class="line">  <span class="keyword">if</span> (\Drupal::routeMatch()-&gt;getRouteName() === <span class="string">'entity.node.preview'</span>) &#123;</span><br><span class="line">    <span class="variable">$variables</span>[<span class="string">'#attached'</span>][<span class="string">'library'</span>][] = <span class="string">'fluffiness/node-preview'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="添加可定制的js">添加可定制的js</h4><p>在某些情况下，你可能想要根据某些php计算信息来加载js。</p>
<p>在这种情况下，像之前一样，创建一个js文件并追加进来，再通过<code>drupalSettings</code>(替换Drupal7中的<code>Drupal.settings</code>)追加一些js设置项并由追加的js文件读取这些设置项。然后，为了使<code>drupalSettings</code>在我们的js文件中生效，我们得像引入jQuery一样操作：我们得在依赖中定义。</p>
<p>就像这样：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cuddly-slider:</span><br><span class="line">  version: 1.x</span><br><span class="line">  js:</span><br><span class="line">    js/cuddly-slider.js: &#123;&#125;</span><br><span class="line">  dependencies:</span><br><span class="line">    -<span class="ruby"> core/jquery</span><br><span class="line"></span>    -<span class="ruby"> core/drupalSettings</span></span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fluffiness_page_attachments_alter</span><span class="params">(&amp;<span class="variable">$page</span>)</span> </span>&#123;</span><br><span class="line">  <span class="variable">$page</span>[<span class="string">'#attached'</span>][<span class="string">'library'</span>][] = <span class="string">'fluffiness/cuddly-slider'</span>;</span><br><span class="line">  <span class="variable">$page</span>[<span class="string">'#attached'</span>][<span class="string">'drupalSettings'</span>][<span class="string">'fluffiness'</span>][<span class="string">'cuddlySlider'</span>][<span class="string">'foo'</span>] = <span class="string">'bar'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>这样<code>cuddly-slider.js</code>就可以访问<code>drupalSettings.fluffiness.cuddlySlider.foo</code>了(这里 === ‘bar’)。</p>
<h3 id="在模版中使用attributes">在模版中使用attributes</h3><p>attributes是一个在每个twig模版中都有效的对象。attributes用来存储所有的父容器的相关属性，并提供有用的方法给开发者处理这些数据。</p>
<h4 id="Attribute的方法">Attribute的方法</h4><p><strong>attributes.addClass()</strong></p>
<p>单个类：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span></span></span><span class="expression">&#123;&#123;<span class="variable">attributes.addClass</span>('<span class="variable">my-class</span>')&#125;&#125;</span><span class="xml"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>多个类：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="preprocessor">%</span></span><br><span class="line">  set classes = [</span><br><span class="line">    <span class="string">'red'</span>,</span><br><span class="line">    <span class="string">'green'</span>,</span><br><span class="line">  ]</span><br><span class="line"><span class="preprocessor">%</span>&#125;</span><br><span class="line">&lt;div&#123;&#123; attributes.addClass<span class="comment">(classes)</span> &#125;&#125;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="type">class</span>=<span class="string">"red green"</span>&gt;&lt;/<span class="keyword">div</span>&gt;.</span><br></pre></td></tr></table></figure>
<p><em>html标签与twig语法之间不能有任何空格！</em></p>
<p><strong>attributes.removeClass()</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;#classes = [ 'red', 'green', 'blue' ] #&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span></span></span><span class="expression">&#123;&#123; <span class="variable">attributes.addClass</span>(<span class="variable">classes</span>)<span class="variable">.removeClass</span>('<span class="variable">green</span>') &#125;&#125;</span><span class="xml"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="type">class</span>=<span class="string">"red blue"</span>&gt;&lt;/<span class="keyword">div</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>attributes.setAttribute($attribute, $value)</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span></span></span><span class="expression">&#123;&#123; <span class="variable">attributes.setAttribute</span>('<span class="variable">id</span>', '<span class="variable">myID</span>') &#125;&#125;</span><span class="xml"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">div</span> <span class="property">id</span>=<span class="string">"myID"</span>&gt;&lt;/<span class="keyword">div</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>attributes.removeAttribute($attribute, $value)</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span></span></span><span class="expression">&#123;&#123; <span class="variable">attributes.removeAttribute</span>('<span class="variable">id</span>') &#125;&#125;</span><span class="xml"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>attributes.hasClass($class)</strong></p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template_tag">&#123;% <span class="keyword">if</span> <span class="function"><span class="keyword">attribute</span>.</span>hasClass(‘myClass') %&#125;</span><span class="xml"></span><br><span class="line"> </span><span class="comment">&#123;# do stuff #&#125;</span><span class="xml"></span><br><span class="line"></span><span class="template_tag">&#123;% <span class="keyword">endif</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<h4 id="其它有用的代码片段">其它有用的代码片段</h4><p><strong>链式</strong></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="preprocessor">%</span> set classes = [<span class="string">'red'</span>, <span class="string">'green'</span>, <span class="string">'blue'</span>] <span class="preprocessor">%</span>&#125;</span><br><span class="line">&#123;<span class="preprocessor">%</span> set my_id = <span class="string">'specific-id'</span> <span class="preprocessor">%</span>&#125;</span><br><span class="line">&#123;<span class="preprocessor">%</span> set image_src = <span class="string">'https://www.drupal.org/files/powered-blue-135x42.png'</span> <span class="preprocessor">%</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">img</span></span></span><span class="expression">&#123;&#123; <span class="variable">attributes.addClass</span>(<span class="variable">classes</span>)<span class="variable">.removeClass</span>('<span class="variable">green</span>')<span class="variable">.setAttribute</span>('<span class="variable">id</span>', <span class="variable">my</span>_<span class="variable">id</span>)<span class="variable">.setAttribute</span>('<span class="variable">src</span>', <span class="variable">image</span>_<span class="variable">src</span>) &#125;&#125;</span><span class="xml"><span class="tag">&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>将会输出：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="variable">id=</span><span class="string">"specific-id"</span> <span class="variable">class=</span><span class="string">"red blue"</span> <span class="variable">src=</span><span class="string">"https://www.drupal.org/files/powered-blue-135x42.png"</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>使用without filter</strong></p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">”myclass</span> </span></span><span class="expression">&#123;&#123; <span class="variable">attributes.class</span> &#125;&#125;</span><span class="xml"><span class="tag">”</span></span><span class="expression">&#123;&#123;<span class="variable">attributes</span>|<span class="variable">without</span>(‘<span class="variable">class</span>’) &#125;&#125;</span><span class="xml"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="Drupal6,_7,_8主题区别">Drupal6, 7, 8主题区别</h3><p>这里列出的是比较重要的Drupal8中的主题变化</p>
<ol>
<li>Drupal8默认输出html5</li>
<li>除了jQuery2.x之外，Drupal8还引入更多的前端框架，例如：<a href="http://modernizr.com/" target="_blank" rel="external">Modernizr</a>，<a href="http://underscorejs.org/" target="_blank" rel="external">Underscore.js</a>，以及<a href="http://backbonejs.org/" target="_blank" rel="external">Backbone.js</a>。</li>
<li>Drupal8引入了Twig，替换了原来的默认模板引擎PHPTemplate。</li>
<li>Drupal8处于性能考虑，默认启用了类似css、js合并之类的默认特性。</li>
<li>在drupal6和drupal7中，可以调用<code>drupal_add_css()</code>和<code>drupal_add_js()</code>函数添加css或者js，现在替换成了在渲染数组中追加<code>#attached</code>属性调用库的方法。</li>
<li>Drupal8不再支持IE6、7、8，启用jQuery2.0，支持现代HTML5/CSS3浏览器。</li>
<li>Drupal8不支持那些不支持SVG的浏览器(包括IE8和安卓浏览器2.3)。</li>
<li>Drupal8的css中，减少了id的使用。</li>
<li>Drupal8的css结构(文件结构)基于<a href="https://smacss.com/" target="_blank" rel="external">SMACSS</a>和<a href="http://bem.info/" target="_blank" rel="external">BEM</a></li>
<li>Drupal8将预处理函数中的css类移到了Twig模版中。</li>
</ol>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/18/Drupal8模板引擎-twig/" itemprop="url">
                  Drupal8模板引擎-twig
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-18T16:35:16+08:00" content="2015-11-18">
              2015-11-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/18/Drupal8模板引擎-twig/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/18/Drupal8模板引擎-twig/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="一、简介">一、简介</h2><p>Twig是一个高效、安全并可扩展的PHP模板引擎。</p>
<p>如果你具有Smarty, Django或者Jinja这养的基于文本的模板语言的经验，那么你对Twig会感觉一见如故。在遵循PHP理念的基础之上，提供了具备强大功能的模板环境，不论是对开发者还是设计者来说，这一引擎都具有良好的可用性。</p>
<p>关键特性：</p>
<ul>
<li>快速：Twig把模板编译成为优化后的PHP代码。相对普通PHP代码来说，其额外开销非常轻微。</li>
<li>安全：Twig会使用一个沙箱模式来运行不信任的模板代码。这使得Twig可以在用户可以修改模板设计的应用中工作良好。</li>
<li>弹性：Twig试用了弹性的词法和语法分析器。开发者可以定义自己的标记和过滤，并创建自己的DSL。</li>
</ul>
<h3 id="需求">需求</h3><p>Twig需要的最小运行环境为PHP <strong>5.2.4</strong></p>
<h3 id="安装">安装</h3><p>推荐使用Composer安装Twig：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require <span class="string">"twig/twig:~1.0"</span></span><br></pre></td></tr></table></figure>
<h3 id="基础API用法">基础API用法</h3><p>本节对Twig PHP API做一个简单介绍。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">'/path/to/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Array(</span><br><span class="line">    <span class="string">'index'</span> =&gt; <span class="string">'Hello &#123;&#123; name &#125;&#125;!'</span>,</span><br><span class="line">);</span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$twig</span>-&gt;render(<span class="string">'index'</span>, <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="string">'Fabien'</span>));</span><br></pre></td></tr></table></figure>
<p>Twig使用一个加载器(Twig_Loader_Array)来定位模板文件，使用一个环境(Twig_Environment)来存储配置，render()方法的第一个参数指定了模板，后面的参数则为渲染提供了变量。 模板一般是保存在文件系统中，所以Twig提供了一个文件系统加载器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Filesystem(<span class="string">'/path/to/templates'</span>);</span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>, <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'cache'</span> =&gt; <span class="string">'/path/to/compilation_cache'</span>,</span><br><span class="line">));</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$twig</span>-&gt;render(<span class="string">'index.html'</span>, <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="string">'Fabien'</span>));</span><br></pre></td></tr></table></figure>
<p>如果没有使用 Composer，可以使用 Twig 的内置加载器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">'/path/to/lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register();</span><br></pre></td></tr></table></figure>
<h2 id="二、模板设计者的Twig">二、模板设计者的Twig</h2><p>本文描述了模板引擎中涉及到的语法和语义，对Twig模板的设计会很有帮助。</p>
<h3 id="概要">概要</h3><p>模板是一个简单的文本文件。它能够生成任何文本格式（HTML, XML, CSV, LaTeX等）。他没有固定的扩展名，html、xml都没关系。</p>
<p>模板中包含变量和表达式在模板被处理时会被替换为真实的值，tags则对模板的逻辑进行控制。</p>
<p>下面用一个小例子展示一些基础内容，当然，后面会做进一步的深入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">      &lt;title&gt;My Webpage&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;ul id=<span class="string">"navigation"</span>&gt;</span><br><span class="line">    &#123;% raw %&#125;</span><br><span class="line">    &#123;% <span class="keyword">for</span> item in navigation %&#125;</span><br><span class="line">        &lt;li&gt;&lt;a href=<span class="string">"&#123;&#123; item.href &#125;&#125;"</span>&gt;&#123;&#123; item.caption &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &#123;% endraw %&#125;</span><br><span class="line">    &lt;h1&gt;My Webpage&lt;/h1&gt;</span><br><span class="line">    &#123;% raw %&#125;</span><br><span class="line">    &#123;&#123; a_variable &#125;&#125;</span><br><span class="line">    &#123;% endraw %&#125;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

上面代码中有两种分隔符：{% ... %}和{{ ... }}。第一种用于执行for循环之类的语句，第二种用于输出表达式结果。

<h3 id="变量">变量</h3><p>应用会把变量传递给模板进行处理。变量自身也可以拥有属性或元素供外部访问。变量的具体形态取决于提供变量的应用。</p>
<p>可以利用句点（.）来访问变量的属性（相当于PHP对象的属性或方法，或者PHP数组的成员），或者也可以使用下标语法（[]）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; foo.bar &#125;&#125;</span><br><span class="line">&#123;&#123; foo[<span class="string">'bar'</span>] &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>当属性名字中包含了特别字符（例如“-”会被当做减号处理）的时候，可以使用attribute函数来访问变量的属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment"># 等价于不能工作的：foo.data-foo #&#125;</span></span><br><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; attribute(foo, <span class="string">'data-foo'</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em>大括号是打印指令，而不是变量的组成部分。当在tag中访问变量的时候，不要在Tag中访问变量的时候使用这种语法。</em></p>
<p>在strict_variables选项为false的时候，如果变量或属性不存在，会返回null；而如果该选项设置为true，这种情况就会抛出错误</p>
<h3 id="实现">实现</h3><p>foo.bar在PHP这一层次做了如下事情：</p>
<ul>
<li>检查foo是不是数组，bar是不是其中的一个有效元素；</li>
<li>如果不是，且foo是一个对象，检查bar是不是有效的属性；</li>
<li>如果不是，且foo是一个对象，检查bar是不是有效的方法（即使bar是构造器——所以请使用__construct()）；</li>
<li>如果不是，且foo是一个对象，检查getBar是不是有效的方法；</li>
<li>如果不是，且foo是一个对象，检查isBar是不是有效的方法；</li>
<li>如果都不是，返回null。</li>
</ul>
<p>另一方面，foo[‘bar’]只对PHP数组工作 - 检查foo是不是一个数组，bar是不是一个有效元素； - 如果不是，返回null。</p>
<p><strong>如果要访问变量的动态属性，应该使用attribute()函数。</strong></p>
<h3 id="全局变量">全局变量</h3><p>模板中随时可以使用如下的变量：</p>
<ul>
<li>_self：当前的模板；</li>
<li>_context：当前上下文</li>
<li>_charset：当前编码</li>
</ul>
<h3 id="设置变量">设置变量</h3><p>可以在代码中为变量赋值。赋值过程使用settag完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set foo = <span class="string">'foo'</span> %&#125;</span><br><span class="line">&#123;% set foo = [<span class="number">1</span>, <span class="number">2</span>] %&#125;</span><br><span class="line">&#123;% set foo = &#123;<span class="string">'foo'</span>: <span class="string">'bar'</span>&#125; %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Filters">Filters</h3><p>变量可以用filters进行修改。Filters和变量之间用管道符（|）进行分隔，可以用括号来包含参数。多个Filter可能进行链式调用——前一个Filter的输出可作为下一个Filter的输入。</p>
<p>下面的例子清理所有的HTML标记，并做标题大写处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; name|striptags|title &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>Filter可以用括号的形式接收参数。这个例子用逗号连接一个列表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">list</span>|join(<span class="string">', '</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>要对一段代码使用Filter，可以用filter tag操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% filter upper %&#125;</span><br><span class="line">  This text becomes uppercase</span><br><span class="line">&#123;% endfilter %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="函数">函数</h3><p>调用函数可以生成内容。调用函数的方式是：函数名称加括号，括号中可能包含参数。</p>
<p>例如range函数返回一个递增的整数列表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> i in range(<span class="number">0</span>, <span class="number">3</span>) %&#125;</span><br><span class="line">  &#123;&#123; i &#125;&#125;,</span><br><span class="line">&#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>前往<a href="http://twig.sensiolabs.org/doc/functions/index.html" target="_blank" rel="external">functions</a>一节可以学习更多内置函数的内容。</p>
<h3 id="具名参数">具名参数</h3><p>1.12版中新增</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> i in range(low=<span class="number">1</span>, high=<span class="number">10</span>, step=<span class="number">2</span>) %&#125;</span><br><span class="line">  &#123;&#123; i &#125;&#125;,</span><br><span class="line">&#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>有了具名参数，传递给模板的参数可以更加明确，让模板更加易用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; data|convert_encoding(<span class="string">'UTF-8'</span>, <span class="string">'iso-2022-jp'</span>) &#125;&#125;</span><br><span class="line">&#123;<span class="comment"># 相比： #&#125;</span></span><br><span class="line">&#123;&#123; data|convert_encoding(from=<span class="string">'iso-2022-jp'</span>, to=<span class="string">'UTF-8'</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>具名参数还能在不传递某些参数时候直接跳过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;<span class="comment"># the first argument is the date format, which defaults to the global date format if null is passed #&#125;</span></span><br><span class="line">&#123;&#123; <span class="string">"now"</span>|date(<span class="keyword">null</span>, <span class="string">"Europe/Paris"</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># or skip the format value by using a named argument for the time zone #&#125;</span></span><br><span class="line">&#123;&#123; <span class="string">"now"</span>|date(timezone=<span class="string">"Europe/Paris"</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>还可以用顺序参数和具名参数夹杂的方式进行调用，这里要保证顺序参数必须比具名参数先出现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">"now"</span>|date(<span class="string">'d/m/Y H:i'</span>, timezone=<span class="string">"Europe/Paris"</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em>每个函数和Filter的文档中，如果该函数或者Filter支持具名参数，都会有一节列出所有的参数名称。</em></p>
<h3 id="控制结构">控制结构</h3>
控制结构指的是所有能够控制程序流程的元素——条件判断（也就是if/elseif/else）、for循环，以及语句块等。控制结构用{% ... %}包裹

<p>例如，要显示一个users变量中所有的列表成员，使用for：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Members&lt;/h1&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">  &#123;% raw %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> user in users %&#125;</span><br><span class="line">      &lt;li&gt;&#123;&#123; user.username|e &#125;&#125;&lt;/li&gt;</span><br><span class="line">  &#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">  &#123;% endraw %&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<p>可以用if进行条件判断：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> users|length &gt; <span class="number">0</span> %&#125;</span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">    &#123;% raw %&#125;</span><br><span class="line">    &#123;% <span class="keyword">for</span> user in users %&#125;</span><br><span class="line">      &lt;li&gt;&#123;&#123; user.username|e &#125;&#125;&lt;/li&gt;</span><br><span class="line">    &#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">    &#123;% endraw %&#125;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">&#123;% <span class="keyword">endif</span> %&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://twig.sensiolabs.org/doc/tags/index.html" target="_blank" rel="external">Tags</a>页中描述了各种内置Tag。</p>
<h3 id="注释">注释</h3><p>在模板中进行注释，使用注释语法`：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;<span class="comment"># 注：禁用这一块东西，不再需要了</span></span><br><span class="line">&#123;% <span class="keyword">for</span> user in users %&#125;</span><br><span class="line">  ...</span><br><span class="line">&#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="包含其他模板">包含其他模板</h3><p>include标签用于包含其它模版，并把该模版的渲染结果返回到当前页面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">include</span> <span class="string">'sidebar.html'</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>缺省状况下，当前的上下文会被传递给被包含的模板。</p>
<p>传递给被包含模板中的上下文包含当前模板中定义的变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">for</span> box in boxes %&#125;</span><br><span class="line">  &#123;% <span class="keyword">include</span> <span class="string">"render_box.html"</span> %&#125;</span><br><span class="line">&#123;% <span class="keyword">endfor</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子中，render_box.html可以访问box变量。</p>
<p>模板文件名的选取，取决于模板加载器。比如Twig_Loader_Filesystem允许通过文件名访问其他的模板。可以使用子目录来访问其他模板：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">include</span> <span class="string">"sections/articles/sidebar.html"</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="模版继承">模版继承</h3><p>Twig最强大的能力就是继承。这一个能力可以让你建立一个包含所有基础元素的基础模板，并定义可以被子模板覆盖的block。</p>
<p>这部分内容并不像听起来那么复杂。下面的例子能让你更好的理解这个概念。</p>
<p>我们创建一个名为base.html的基本模板，在其中定义了一个简单的HTML结构，后面可以用在一个简单的两列布局的页面上：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &#123;% raw %&#125;</span><br><span class="line">    &#123;% block head %&#125;</span><br><span class="line">      &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"style.css"</span> /&gt;</span><br><span class="line">      &lt;title&gt;&#123;% block title %&#125;&#123;% endblock %&#125; - My Webpage&lt;/title&gt;</span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line">    &#123;% endraw %&#125;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;div id=<span class="string">"content"</span>&gt;</span><br><span class="line">      &#123;% raw %&#125;</span><br><span class="line">      &#123;% block content %&#125;</span><br><span class="line">      &#123;% endblock %&#125;</span><br><span class="line">      &#123;% endraw %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div id=<span class="string">"footer"</span>&gt;</span><br><span class="line">      &#123;% raw %&#125;</span><br><span class="line">      &#123;% block footer %&#125;</span><br><span class="line">          &amp;copy; Copyright <span class="number">2011</span> by &lt;a href=<span class="string">"http://domain.invalid/"</span>&gt;you&lt;/a&gt;.</span><br><span class="line">      &#123;% endblock %&#125;</span><br><span class="line">      &#123;% endraw %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，<a href="http://twig.sensiolabs.org/doc/tags/block.html" target="_blank" rel="external">Block标记</a>定义了四个Block，子模板可以对这四个Block进行填充。所有的Block标记的作用就在于告诉模板引擎——子模板可能对模板的这一部分进行覆盖。</p>
<p>一个子模板看起来大概是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Index&#123;% endblock %&#125;</span><br><span class="line">&#123;% block head %&#125;</span><br><span class="line">  &#123;&#123; parent() &#125;&#125;</span><br><span class="line">  &lt;style type="text/css"&gt;</span><br><span class="line">      .important &#123; color: #336699; &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;h1&gt;Index&lt;/h1&gt;</span><br><span class="line">  &lt;p class="important"&gt;</span><br><span class="line">      Welcome to my awesome homepage.</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>此处的关键就在于<a href="http://twig.sensiolabs.org/doc/tags/extends.html" target="_blank" rel="external">Extends tag</a>。他让模板引擎得知这个模板是“扩展自其他模板”。当模板系统处理这一模板的时候，就会首先定位父模板。Extends标记应该是子模板的第一个标记。</p>
<p>另外因为子模板中没有定义footer block，所以此处会继续使用父模板的内容。</p>
<p>也可以用<a href="http://twig.sensiolabs.org/doc/functions/parent.html" target="_blank" rel="external">Parent函数</a>来渲染父模板Block的内容。这一调用会返回父模板中的Block结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% block sidebar %&#125;</span><br><span class="line">  &lt;h3&gt;Table Of Contents&lt;/h3&gt;</span><br><span class="line">  ...</span><br><span class="line">  &#123;&#123; <span class="keyword">parent</span>() &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em><a href="http://twig.sensiolabs.org/doc/tags/extends.html" target="_blank" rel="external">extend文档</a>中介绍了更深入的特性，例如Block嵌套、作用域、动态继承以及条件继承等。</em></p>
<h3 id="HTML转义">HTML转义</h3><p>从模板中生成HTML的时候，存在一种风险：一个变量可能包含了HTML代码，会影响到最终的HTML。有两种方式来解决这个问题：人工转义每一个变量，或者缺省情况下自动转义所有变量。Twig对两种方式都支持，缺省开启第二种。</p>
<p><em>自动转义只有在escaper扩展激活的情况下才生效。</em></p>
<ul>
<li><h4 id="人工转义">人工转义</h4></li>
</ul>
<p>如果启用了人工转义，那么对需要进行处理的变量进行转义就成了开发者的责任。那么什么需要被转义呢？答案是所有不信任的变量。人工转义的方法是把变量传送给<a href="http://twig.sensiolabs.org/doc/filters/escape.html" target="_blank" rel="external">escape filter</a>或者e filter进行处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; user.username|e &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><h4 id="自动转义">自动转义</h4></li>
</ul>
<p>不管是否启用了自动转义，都可以利用<a href="http://twig.sensiolabs.org/doc/tags/autoescape.html" target="_blank" rel="external">autoescape</a>标记来标记模板中的一段内容。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% autoescape %&#125;</span><br><span class="line">  Everything will be automatically escaped in this block (using the HTML strategy)</span><br><span class="line">&#123;% endautoescape %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>缺省情况下，自动转义使用html策略。如果输出内容属于其他上下文，则需要显式的指定其他的转义策略：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% autoescape <span class="string">'js'</span> %&#125;</span><br><span class="line">这个区块中的所有字符都会被自动转义(采用JS策略)</span><br><span class="line">&#123;% endautoescape %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>转义</p>
</blockquote>

让Twig能够忽略一部分本应当做是block或者变量来处理的东西，是个常见甚至必要的需求。例如想要以原始形态输出{{这样被语法占用的关键字，而不想被当做变量的开始，就可以使用一个小技巧。
{% endraw %}
<p>最简单的方式就是使用一个变量表达式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">'&#123;&#123;'</span> &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="宏">宏</h3><p>在版本1.12中出现：支持缺省参数值。</p>
<p>宏和和其他语言中的函数类似。它可以复用经常使用的HTML片段。</p>
<p>使用<a href="http://twig.sensiolabs.org/doc/tags/macro.html" target="_blank" rel="external">macro标记</a>可以定义宏。下面是forms.html中的一个小例子：利用宏渲染一个form元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% macro input(name, value, type, size) %&#125;</span><br><span class="line">  &lt;input type=<span class="string">"&#123;&#123; type|default('text') &#125;&#125;"</span> name=<span class="string">"&#123;&#123; name &#125;&#125;"</span> value=<span class="string">"&#123;&#123; value|e &#125;&#125;"</span> size=<span class="string">"&#123;&#123; size|default(20) &#125;&#125;"</span> /&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>可以在任何模板中定义宏，然后使用<a href="http://twig.sensiolabs.org/doc/tags/import.html" target="_blank" rel="external">import标记</a>进行导入即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% import <span class="string">"forms.html"</span> <span class="keyword">as</span> forms %&#125;</span><br><span class="line">&lt;p&gt;&#123;&#123; forms.input(<span class="string">'username'</span>) &#125;&#125;&lt;/p&gt;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>在从其他模板中进行引入的时候，还可以利用From标记为其赋予别名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% from <span class="string">'forms.html'</span> import input <span class="keyword">as</span> input_field %&#125;</span><br><span class="line">&lt;dl&gt;</span><br><span class="line">  &lt;dt&gt;Username&lt;/dt&gt;</span><br><span class="line">  &lt;dd&gt;&#123;&#123; input_field(<span class="string">'username'</span>) &#125;&#125;&lt;/dd&gt;</span><br><span class="line">  &lt;dt&gt;Password&lt;/dt&gt;</span><br><span class="line">  &lt;dd&gt;&#123;&#123; input_field(<span class="string">'password'</span>, <span class="string">''</span>, <span class="string">'password'</span>) &#125;&#125;&lt;/dd&gt;</span><br><span class="line">&lt;/dl&gt;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>还可以在为宏指定缺省参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% macro input(name, value = <span class="string">""</span>, type = <span class="string">"text"</span>, size = <span class="number">20</span>) %&#125;</span><br><span class="line">  &lt;input type=<span class="string">"&#123;&#123; type &#125;&#125;"</span> name=<span class="string">"&#123;&#123; name &#125;&#125;"</span> value=<span class="string">"&#123;&#123; value|e &#125;&#125;"</span> size=<span class="string">"&#123;&#123; size &#125;&#125;"</span> /&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="表达式">表达式</h3><p>Twig允许使用表达式，工作方式类似普通的PHP，即使你对PHP没那么熟悉，也可以轻松面对。</p>
<blockquote>
<p>运算符优先级按递增顺序排列如下：<br>b-and, b-xor, b-or, or, and, ==, !=, &lt;, &gt;, &gt;=, &lt;=, in, matches, starts with, ends with, .., +, -, ~, <em>, /, //, %, is, *</em>, |, [], and</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set greeting = <span class="string">'Hello '</span> %&#125;</span><br><span class="line">&#123;% set name = <span class="string">'Fabien'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; greeting ~ name|lower &#125;&#125;   &#123;<span class="comment"># Hello fabien #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># use parenthesis to change precedence #&#125;</span></span><br><span class="line">&#123;&#123; (greeting ~ name)|lower &#125;&#125; &#123;<span class="comment"># hello fabien #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h4 id="常量">常量</h4><p>在1.5中新增：支持以名称和表达式作为哈希键</p>
<p>表达式的最简单形式就是常量了。他是PHP类型的一种实现，包含字符串、数字以及数组。以下是一些例子</p>
<ul>
<li>“Hello world”：单引号或双引号之间的内容是字符串。可以在任何需要字符串的情况下使用（例如作为函数或者Filter的参数，或者在extend以及include过程中使用）。</li>
<li>42 / 42.23：整数和浮点数。有小数点的是浮点数；否则就是整数。</li>
<li>[“foo”, “bar”]：数组由方括号包含的一组逗号分隔的表达式组成。</li>
<li>{“foo”: “bar”}：同数组类似，不过是以花括号进行包装。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;<span class="comment"># keys as string #&#125;</span></span><br><span class="line">&#123; <span class="string">'foo'</span>: <span class="string">'foo'</span>, <span class="string">'bar'</span>: <span class="string">'bar'</span> &#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># keys as names (equivalent to the previous hash) -- as of Twig 1.5 #&#125;</span></span><br><span class="line">&#123; foo: <span class="string">'foo'</span>, bar: <span class="string">'bar'</span> &#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># keys as integer #&#125;</span></span><br><span class="line">&#123; <span class="number">2</span>: <span class="string">'foo'</span>, <span class="number">4</span>: <span class="string">'bar'</span> &#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># keys as expressions (the expression must be enclosed into parentheses) -- as of Twig 1.5 #&#125;</span></span><br><span class="line">&#123; (<span class="number">1</span> + <span class="number">1</span>): <span class="string">'foo'</span>, (a ~ <span class="string">'b'</span>): <span class="string">'bar'</span> &#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>true / false：布尔值，你懂的</li>
<li>null：表明无特定值。当访问一个不存在的变量时，就会返回null，none是null的别名。</li>
</ul>
<p>数组和哈希可以嵌套：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set foo = [<span class="number">1</span>, &#123;<span class="string">"foo"</span>: <span class="string">"bar"</span>&#125;] %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em>字符串使用单双引号对性能没什么影响，但是只有双引号才支持字符串差值。</em></p>
<h4 id="算数运算符">算数运算符</h4><p>Twig可以进行运算。这个功能很少用得到，不过为了完整起见，还是提供了这个功能。目前支持下列操作符：</p>
{% raw %}

- +：加法
- -：减法
- /：除法
- %：求余。{{ 11 % 7 }} 等于 4.
- //：整除，返回两个数相除得到的结果的整数部分。{{ 20 // 7 }}等于2
- *： 相乘，{{2 * 2}} 返回 4。
- **：乘方，{{ 2 3}}`等于8。


<h4 id="逻辑运算符">逻辑运算符</h4><p>可以用下面的操作符连接多个表达式：</p>
<ul>
<li>and：与运算</li>
<li>or：或运算</li>
<li>not：非运算</li>
<li>(expr)：为表达式分组</li>
</ul>
<p><em>Twig还支持位操作：（b-and, b-xor 以及 b-or）。</em></p>
<h4 id="比较运算符">比较运算符</h4><p>Twig支持的比较运算符：==、!=、&lt;、&gt;、&gt;=、&lt;=，还可以对字符串使用starts with或者end with：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> <span class="string">'Fabien'</span> starts with <span class="string">'F'</span> %&#125;</span><br><span class="line">&#123;% <span class="keyword">endif</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">if</span> <span class="string">'Fabien'</span> ends with <span class="string">'n'</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em>对于复杂的字符串比较，matches操作符提供了正则表达式的匹配能力：</em></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> phone matches <span class="string">'/^[\\d\\.]+$/'</span> %&#125;</span><br><span class="line">&#123;% <span class="keyword">endif</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h4 id="包含操作符">包含操作符</h4><p>操作符in提供了包含测试功能。</p>
<p>如果右侧操作数包含左侧的操作数，则返回true：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;<span class="comment"># returns true #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="number">1</span> in [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="string">'cd'</span> in <span class="string">'abcde'</span> &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>还可以反着用（not in）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> <span class="number">1</span> not in [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] %&#125;</span><br><span class="line">&#123;<span class="comment"># 等价于 #&#125;</span></span><br><span class="line">&#123;% <span class="keyword">if</span> not (<span class="number">1</span> in [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试操作符">测试操作符</h4><p>is操作符用于测试。可以用于测试一个变量和表达式，右侧的操作数就是测试的名字：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;<span class="comment"># 检测变量是不是奇数 #&#125;</span></span><br><span class="line">&#123;&#123; name is odd &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>测试也可以接受参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> post.status is constant(<span class="string">'Post::PUBLISHED'</span>) %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用is not来进行否定测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> post.status is not constant(<span class="string">'Post::PUBLISHED'</span>) %&#125;</span><br><span class="line">&#123;<span class="comment"># 等价于 #&#125;</span></span><br><span class="line">&#123;% <span class="keyword">if</span> not (post.status is constant(<span class="string">'Post::PUBLISHED'</span>)) %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>可以去<a href="http://twig.sensiolabs.org/doc/tests/index.html" target="_blank" rel="external">test</a>页面来了解一下内置的测试。</p>
<h4 id="其他操作符">其他操作符</h4><p>1.12.0中加入了扩展的三元操作符。</p>
<ul>
<li>|：管道符号，应用一个filter</li>
<li>..：以左右两个操作数为基础生成一个序列</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="number">1.</span>.<span class="number">5</span> &#125;&#125;</span><br><span class="line">&#123;<span class="comment"># 等价于 #&#125;</span></span><br><span class="line">&#123;&#123; range(<span class="number">1</span>, <span class="number">5</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>

- ~：把所有操作数转换为字符串并连接起来。{{ "Hello " ~ name ~ "!" }}会返回(假设name是'John')Hello John!。
- .,[]：获取对象的属性
- ?:：三元操作符


<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; foo ? <span class="string">'yes'</span> : <span class="string">'no'</span> &#125;&#125;</span><br><span class="line">&#123;<span class="comment"># 在Twig 1.12.0中 #&#125;</span></span><br><span class="line">&#123;&#123; foo ?: <span class="string">'no'</span> &#125;&#125; 等同于 &#123;&#123; foo ? foo : <span class="string">'no'</span> &#125;&#125;</span><br><span class="line">&#123;&#123; foo ? <span class="string">'yes'</span> &#125;&#125; 等同于 &#123;&#123; foo ? <span class="string">'yes'</span> : <span class="string">''</span> &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h4 id="字符串插值">字符串插值</h4><p>字符串差值(#{表达式})允许在双引号内的字符串中插入任何有效的表达式。表达式的结果会出现在最终的字符串中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">"foo #&#123;bar&#125; baz"</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">"foo #&#123;1 + 2&#125; baz"</span> &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="空白控制">空白控制</h3><p>twig1.1新增tag级别的空白控制</p>
<p>跟PHP类似，模板标记后面的第一个空行会被自动删除。模板引擎目前已经不再自动清理空白，所有空白（空格、制表符、换行符等）都会原样输出。</p>
<p>使用<code>spaceless</code>标记可以移出html标记之间的空白：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% spaceless %&#125;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;strong&gt;foo bar&lt;/strong&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endspaceless %&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># output will be &lt;div&gt;&lt;strong&gt;foo bar&lt;/strong&gt;&lt;/div&gt; #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>在spaceless标记之外，还可以在每个标记的级别控制空白。在标记上使用空白控制修饰符，可以清除前导或跟随的空白：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set value = <span class="string">'no spaces'</span> %&#125;</span><br><span class="line">&#123;<span class="comment">#- 取出首位空白 -#&#125;</span></span><br><span class="line">&#123;%- <span class="keyword">if</span> <span class="keyword">true</span> -%&#125;</span><br><span class="line">    &#123;&#123;- value -&#125;&#125;</span><br><span class="line">&#123;%- <span class="keyword">endif</span> -%&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># 输出 'no spaces' #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子演示了缺省的空白控制修饰符，以及如何移除标记周围的空白。还可以只清除Tag一边的空白：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set value = <span class="string">'no spaces'</span> %&#125;</span><br><span class="line">&lt;li&gt;</span><br><span class="line">  &#123;&#123;- value &#125;&#125;</span><br><span class="line">&lt;/li&gt;</span><br><span class="line">&#123;<span class="comment"># 输出 '&lt;li&gt;no spaces&lt;/li&gt;' #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="扩展">扩展</h3><ul>
<li><p>Twig的扩展很方便。</p>
</li>
<li><p>如果你要查找新的标记、filter或者函数，可以浏览官方的<a href="http://github.com/twigphp/Twig-extensions" target="_blank" rel="external">扩展仓库</a>。</p>
</li>
<li><p>如果想要创建自己的扩展，请阅读创建<a href="https://drupal.fleeto.us/translation/extending-twig" target="_blank" rel="external">扩展章节</a>。</p>
</li>
</ul>
<h2 id="三、开发者的Twig">三、开发者的Twig</h2><p>本章讲述的是Twig的API，而不是Twig的模板语言。这些内容会对为应用实现模板接口的工作很有帮助，对模板的制作工作就没什么意义了。</p>
<h3 id="基础">基础</h3><p>Twig的中心对象为<strong>environment</strong>（是Twig_Environment类的实例）。这个类的实例用于存储配置和扩展，并用来从文件系统或者其他位置载入模板。</p>
<p>绝大多数应用需要在应用初始化的时候，创建一个Twig_Environment对象，然后用它来加载模板。在有些案例中，会有多个环境同时并存，用来处理不同的配置。</p>
<p>下面举个简单例子，配置Twig来为应用载入模板：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">'/path/to/lib/Twig/Autoloader.php'</span>;</span><br><span class="line">Twig_Autoloader::register();</span><br><span class="line"></span><br><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Filesystem(<span class="string">'/path/to/templates'</span>);</span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>, <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'cache'</span> =&gt; <span class="string">'/path/to/compilation_cache'</span>,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>上面的代码会创建一个缺省设置的环境，然后加载器会去/path/to/templates/目录查找模板。有不同的加载器可以使用，你可以实现自己的加载器用来从数据库或者其他资源中获取模板。</p>
<p><em>注意，environment的第二个参数是一个数组选项。cache选项声明了一个目录，用于存储Twig编译的模版，以减少解析的开销。这种缓存跟你希望在处理模板过程中加入的缓存是不一样的，所以如果需要自行缓存，请使用其他的PHP缓存库。</em></p>
<p>要从环境中调用模版，只需要调用<code>loadTemplate</code>函数，函数会返回一个<code>Twig_Template</code>实例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$template</span> = <span class="variable">$twig</span>-&gt;loadTemplate(<span class="string">'index.html'</span>);</span><br></pre></td></tr></table></figure>
<p>要渲染带有变量的模版，调用<code>render</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="variable">$template</span>-&gt;render(<span class="keyword">array</span>(<span class="string">'the'</span> =&gt; <span class="string">'variables'</span>, <span class="string">'go'</span> =&gt; <span class="string">'here'</span>));</span><br></pre></td></tr></table></figure>
<p><em><code>display()</code>方法是用于直接输出模版的快捷方法。</em></p>
<p>你还可以一气呵成加载和渲染模版：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="variable">$twig</span>-&gt;render(<span class="string">'index.html'</span>, <span class="keyword">array</span>(<span class="string">'the'</span> =&gt; <span class="string">'variables'</span>, <span class="string">'go'</span> =&gt; <span class="string">'here'</span>));</span><br></pre></td></tr></table></figure>
<h3 id="环境选项">环境选项</h3><p>当创建一个新的Twig_Environment实例时，可以创建一个选项数组，作为构造函数的第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>, <span class="keyword">array</span>(<span class="string">'debug'</span> =&gt; <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure>
<p>可用的环境选项：</p>
<ul>
<li>debug：布尔值，设置为true的时候，生成的模版会带有一个<code>__toString()</code>方法，这个方法可以用来显示生成的Node（默认值false）</li>
<li>charset：模版的字符集，默认是utf-8</li>
<li>base_template_class：生成模版时使用的基本模版类，默认Twig_Template</li>
<li>cache：用于存储缓存的绝对路径名，或者false用于禁用缓存（默认是false）</li>
<li>auto_reload：布尔值，当用Twig开发时，源代码有修改时就重新编译对于开发者来说是非常必要的。如果不提供一个auto_reload选项，他会从debug选项中取值。</li>
<li>strict_variables：布尔值，如果设置为false，Twig会忽略无效的变量（无效指的是不存在的变量或者属性/方法），并将其替换为null。如果这个选项设置为true，那么遇到这种情况的时候，Twig会抛出异常。默认值是false</li>
<li>autoescape：字符串或者布尔值，如果设置为true，HTML的自动转义会默认对所有的模版起效，默认值是true。在Twig 1.8中，可以设置转义策略（html或者js，要关闭可以设置为false）。在Twig 1.9中的转义策略，可以设置为css，url，html_attr，甚至还可以设置为PHP回调函数，该函数需要接受一个模板文件名为参数，且必须返回要使用的转义策略，回调命名应该避免同内置的转义策略冲突。</li>
<li>optimizations：整型值，一个标记，用于决定采用哪种优化方式（默认是-1，激活所有的优化方式；设置0的话将会禁用）</li>
</ul>
<h3 id="加载器">加载器</h3><p>加载器负责从文件系统等资源中加载模版</p>
<h4 id="编译缓存">编译缓存</h4><p>所有的模版加载器都会在文件系统中缓存编译的模版，已被将来调用。由于模版只编译一次，所以大大地提升了Twig的速度，如果你还使用了PHP加速器，例如APC，性能的提升将会更加的明显。参考上文提到的<code>Twig_Environment</code>中的<code>cache</code>以及<code>auto_reload</code>选项能够获得更多信息。</p>
<h4 id="内置加载器">内置加载器</h4><p>这里有一个Twig提供的内置加载列表：</p>
<ul>
<li><p>Twig_Loader_Filesystem</p>
<p>1.10新增prependPath()以及命名空间支持</p>
</li>
<li><p>Twig_Loader_Filesystem</p>
<p>从文件系统中加载模版。这个加载器可以在文件系统的目录中找到模版，也是推荐使用的加载器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Filesystem(<span class="variable">$templateDir</span>);</span><br></pre></td></tr></table></figure>
<p>它还可以从目录数组中查找模版：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Filesystem(<span class="keyword">array</span>(<span class="variable">$templateDir1</span>, <span class="variable">$templateDir2</span>));</span><br></pre></td></tr></table></figure>
<p>在这种配置下，Twig会首先在$templateDir1目录下查找模版，如果没有找到，再继续从templateDir2目录下查找。</p>
<p>你可以通过<code>addPath()</code>和<code>prependPath()</code>方法添加或者追加路径</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span>-&gt;addPath(<span class="variable">$templateDir3</span>);</span><br><span class="line"><span class="variable">$loader</span>-&gt;prependPath(<span class="variable">$templateDir4</span>);</span><br></pre></td></tr></table></figure>
<p>filesystem加载器还支持命名空间模版。这一特性将允许用户把模版放在不同的带有命名空间的目录下。</p>
<p>当使用<code>setPaths()</code>、<code>addPath()</code>以及<code>prependPath()</code>方法时，把命名空间作为第二个参数进行传递（如果没有传递，缺省命名空间为”main”）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$loader</span>-&gt;addPath(<span class="variable">$templateDir</span>, <span class="string">'admin'</span>);</span><br></pre></td></tr></table></figure>
<p>命名空间模版可以通过类似于<code>@namespace_name/template_path</code>的注解形式来访问。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span>-&gt;render(<span class="string">'@admin/index.html'</span>, <span class="keyword">array</span>());</span><br></pre></td></tr></table></figure>
</li>
<li><p>Twig_Loader_Array</p>
<p>Twig_Loader_Array从PHP数组中加载模版</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Array(<span class="keyword">array</span>(</span><br><span class="line"><span class="string">'index.html'</span> =&gt; <span class="string">'Hello &#123;&#123; name &#125;&#125;!'</span>,));</span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$twig</span>-&gt;render(<span class="string">'index.html'</span>, <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="string">'Fabien'</span>));</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>这个加载器对于单元测试非常有用。这个加载器适合于那些需要把所有的模版都存在在一个单独php文件的小型项目中。</p>
</li>
<li><p>Twig_Loader_Chain</p>
<p>Twig_Loader_Chain委托其它加载器加在模版</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line"><span class="variable">$loader1</span> = <span class="keyword">new</span> Twig_Loader_Array(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'base.html'</span> =&gt; <span class="string">'&#123;% block content %&#125;&#123;% endblock %&#125;'</span>,</span><br><span class="line">));</span><br><span class="line"><span class="variable">$loader2</span> = <span class="keyword">new</span> Twig_Loader_Array(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'index.html'</span> =&gt; <span class="string">'&#123;% extends "base.html" %&#125;&#123;% block content %&#125;Hello &#123;&#123; name &#125;&#125;&#123;% endblock %&#125;'</span>,</span><br><span class="line">    <span class="string">'base.html'</span>  =&gt; <span class="string">'Will never be loaded'</span>,</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="variable">$loader</span> = <span class="keyword">new</span> Twig_Loader_Chain(<span class="keyword">array</span>(<span class="variable">$loader1</span>, <span class="variable">$loader2</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>当搜索模版的时候，Twig会依次尝试每一个加载器，一旦找到匹配模版，立即返回。当渲染上述例子中的index.html模版时，Twig会在$loader2中加载它，但是对于base.html模版，Twig会从$loader1中加载。</p>
<p>Twig_Loader_Chain接受任何实现了Twig_LoaderInterface接口的加载器</p>
<p><em>你还可以通过addLoader()方法添加加载器</em></p>
</li>
</ul>
<h4 id="创建自己的加载器">创建自己的加载器</h4><p>实现了Twig_LoaderInterface接口的加载器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Twig_LoaderInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Gets the source code of a template, given its name.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @param</span>  string $name string The name of the template to load</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> string The template source code</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getSource</span><span class="params">(<span class="variable">$name</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Gets the cache key to use for the cache for a given template name.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @param</span>  string $name string The name of the template to load</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> string The cache key</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span><span class="params">(<span class="variable">$name</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns true if the template is still fresh.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @param</span> string    $name The template name</span><br><span class="line">   *<span class="phpdoc"> @param</span> timestamp $time The last modification time of the cached template</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isFresh</span><span class="params">(<span class="variable">$name</span>, <span class="variable">$time</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果当前的缓存模版还是最新的，isFresh()方法必须返回true，否则应该返回最后一次的修改时间，或者直接false</p>
<p><em>Twig 1.11.0，还可以实现Twig_ExistsLoaderInterface接口，让加载器在同链式加载器协同工作时稍快一些。</em></p>
<h3 id="使用扩展">使用扩展</h3><p>Twig扩展是打包起来的一些新功能。使用扩展很简单，调用addExtension()方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="keyword">new</span> Twig_Extension_Sandbox());</span><br></pre></td></tr></table></figure>
<p>Twig自带了以下扩展：</p>
<ul>
<li><p>Twig_Extension_Core：定义了Twig的所有核心特性</p>
</li>
<li><p>Twig_Extension_Escaper：添加自动输出转义，以及代码库可能需要的转义或者反转义</p>
</li>
<li><p>Twig_Extension_Sandbox：为Twig环境添加一个默认的沙盒模式，使不信任的可以安全的运行</p>
</li>
<li><p>Twig_Extension_Profiler：启用内置的Twig profiler</p>
</li>
<li><p>Twig_Extension_Optimizer：编译前优化节点树</p>
</li>
</ul>
<p>核心、转义、以及优化扩展不需要添加到Twig环境中，他们默认就是启用的</p>
<h3 id="内置扩展">内置扩展</h3><p>这块儿将会描述内置扩展带来的新特性</p>
<h4 id="核心扩展">核心扩展</h4><p>core扩展定义了Twig的所有核心特性：</p>
<ul>
<li><p><a href="http://twig.sensiolabs.org/doc/tags/index.html" target="_blank" rel="external">Tags</a></p>
</li>
<li><p><a href="http://twig.sensiolabs.org/doc/filters/index.html" target="_blank" rel="external">Filters</a></p>
</li>
<li><p><a href="http://twig.sensiolabs.org/doc/functions/index.html" target="_blank" rel="external">Functions</a></p>
</li>
<li><p><a href="http://twig.sensiolabs.org/doc/tests/index.html" target="_blank" rel="external">Tests</a></p>
</li>
</ul>
<h4 id="转义扩展">转义扩展</h4><p>escaper扩展为Twig带来了自动输出转义，它定义了autoescape标记，raw filter。</p>
<p>自行创建escaper扩展时，你可以打开或者关闭全局的转义策略：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$escaper</span> = <span class="keyword">new</span> Twig_Extension_Escaper(<span class="string">'html'</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="variable">$escaper</span>);</span><br></pre></td></tr></table></figure>
<p>如果设置成html，模版中所有的变量都会转义，除了那些raw filter输出的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; article.to_html|raw &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>通过使用autoescape标记，你可以改变转移模式（参考<a href="http://twig.sensiolabs.org/doc/tags/autoescape.html" target="_blank" rel="external">autoescape文档</a>）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% autoescape <span class="string">'html'</span> %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">var</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">var</span>|raw &#125;&#125;      &#123;<span class="comment"># var 不会被转义 #&#125;</span></span><br><span class="line">&#123;&#123; <span class="keyword">var</span>|escape &#125;&#125;   &#123;<span class="comment"># var 不会被再次转义 #&#125;</span></span><br><span class="line">&#123;% endautoescape %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p><em>autoescape标记对包含进来的模版无效</em></p>
<p>转义规则是这样实现的：</p>
<ul>
<li>模板中的常量（整数、布尔、数组…）会直接当做变量或filter的参数，不会被自动转义：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">"Twig&lt;br /&gt;"</span> &#125;&#125; &#123;<span class="comment"># won't be escaped #&#125;</span></span><br><span class="line">&#123;% set text = <span class="string">"Twig&lt;br /&gt;"</span> %&#125;</span><br><span class="line">&#123;&#123; text &#125;&#125; &#123;<span class="comment"># will be escaped #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于一个结果是常量的表达式，或者一个标记为安全的变量也不会自动转义：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; foo ? <span class="string">"Twig&lt;br /&gt;"</span> : <span class="string">"&lt;br /&gt;Twig"</span> &#125;&#125; &#123;<span class="comment"># won't be escaped #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;% set text = <span class="string">"Twig&lt;br /&gt;"</span> %&#125;</span><br><span class="line">&#123;&#123; foo ? text : <span class="string">"&lt;br /&gt;Twig"</span> &#125;&#125; &#123;<span class="comment"># will be escaped #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;% set text = <span class="string">"Twig&lt;br /&gt;"</span> %&#125;</span><br><span class="line">&#123;&#123; foo ? text|raw : <span class="string">"&lt;br /&gt;Twig"</span> &#125;&#125; &#123;<span class="comment"># won't be escaped #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;% set text = <span class="string">"Twig&lt;br /&gt;"</span> %&#125;</span><br><span class="line">&#123;&#123; foo ? text|escape : <span class="string">"&lt;br /&gt;Twig"</span> &#125;&#125; &#123;<span class="comment"># the result of the expression won't be escaped #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>转义发生在打印之前，filter之后：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">var</span>|upper &#125;&#125; &#123;<span class="comment"># 等价于 &#123;&#123; var|upper|escape &#125;&#125; #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>raw filter应该在filter链的最后使用：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="keyword">var</span>|raw|upper &#125;&#125; &#123;<span class="comment"># 会转义 #&#125;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="keyword">var</span>|upper|raw &#125;&#125; &#123;<span class="comment"># 不转义 #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果最后一个filter在当前上下文中（例如html或者js）被标记为安全，escape和escape(‘html’)被HTML标记为安全，escape(‘js’)被JavaScript标记为安全，raw对所有内容都被标记为安全。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% autoescape <span class="string">'js'</span> %&#125;</span><br><span class="line">  &#123;&#123; <span class="keyword">var</span>|escape(<span class="string">'html'</span>) &#125;&#125; &#123;<span class="comment"># will be escaped for HTML and JavaScript #&#125;</span></span><br><span class="line">  &#123;&#123; <span class="keyword">var</span> &#125;&#125; &#123;<span class="comment"># will be escaped for JavaScript #&#125;</span></span><br><span class="line">  &#123;&#123; <span class="keyword">var</span>|escape(<span class="string">'js'</span>) &#125;&#125; &#123;<span class="comment"># won't be double-escaped #&#125;</span></span><br><span class="line">&#123;% endautoescape %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>

*注意自动转义是是在表达式运行之后发生，因此有局限性的。例如当进行连续操作时，{{ foo|raw ~ bar }}因为转义是最后发生的，因此无法给出期待的结果（这里的raw filter没有任何效果）。*

<h4 id="沙盒扩展">沙盒扩展</h4><p>沙箱扩展用于运行不受信任的代码,会限制访问不安全的属性和方法。沙箱安全性由一个策略实例来管理。缺省情况下，Twig会带有一个策略类：Twig_Sandbox_SecurityPolicy。这个类允许把某些标记、Filter、属性以及方法放入白名单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tags</span> = <span class="keyword">array</span>(<span class="string">'if'</span>);</span><br><span class="line"><span class="variable">$filters</span> = <span class="keyword">array</span>(<span class="string">'upper'</span>);</span><br><span class="line"><span class="variable">$methods</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'Article'</span> =&gt; <span class="keyword">array</span>(<span class="string">'getTitle'</span>, <span class="string">'getBody'</span>),</span><br><span class="line">);</span><br><span class="line"><span class="variable">$properties</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'Article'</span> =&gt; <span class="keyword">array</span>(<span class="string">'title'</span>, <span class="string">'body'</span>),</span><br><span class="line">);</span><br><span class="line"><span class="variable">$functions</span> = <span class="keyword">array</span>(<span class="string">'range'</span>);</span><br><span class="line"><span class="variable">$policy</span> = <span class="keyword">new</span> Twig_Sandbox_SecurityPolicy(<span class="variable">$tags</span>, <span class="variable">$filters</span>, <span class="variable">$methods</span>, <span class="variable">$properties</span>, <span class="variable">$functions</span>);</span><br></pre></td></tr></table></figure>
<p>在上面的例子中，安全策略只允许使用if标签和upper过滤器。另外，模版只能调用<code>Article</code>对象的<code>getTitle()</code>方法和<code>getBody()</code>方法，只能访问<code>title</code>和<code>body</code>这俩个公共属性。其它的都被禁止访问，如果尝试访问，则会抛出一个<code>Twig_Sandbox_SecurityError</code>异常。</p>
<p>策略对象是沙盒构造器的第一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sandbox</span> = <span class="keyword">new</span> Twig_Extension_Sandbox(<span class="variable">$policy</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="variable">$sandbox</span>);</span><br></pre></td></tr></table></figure>
<p>默认情况下，沙盒模式处于禁用状态。当包含的模版中含有不可信的代码时，使用<code>sandbox</code>标签激活沙盒模式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% sandbox %&#125;</span><br><span class="line">  &#123;% <span class="keyword">include</span> <span class="string">'user.html'</span> %&#125;</span><br><span class="line">&#123;% endsandbox %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>你可以通过将扩展构造器的第二个参数传值true来对所有的模版启用沙盒模式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sandbox</span> = <span class="keyword">new</span> Twig_Extension_Sandbox(<span class="variable">$policy</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h4 id="简介扩展">简介扩展</h4><p>Twig1.18新增简介扩展</p>
<p>profiler扩展为Twig模版开启一个profiler，它应该只在开发机器上使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$profile</span> = <span class="keyword">new</span> Twig_Profiler_Profile();</span><br><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="keyword">new</span> Twig_Extension_Profiler(<span class="variable">$profile</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$dumper</span> = <span class="keyword">new</span> Twig_Profiler_Dumper_Text();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dumper</span>-&gt;dump(<span class="variable">$profile</span>);</span><br></pre></td></tr></table></figure>
<p>一个profile包含了模版，块以及宏扩展的耗时和内存消耗信息。</p>
<p>你还可以以<a href="https://blackfire.io/" target="_blank" rel="external">blackfire.io</a>兼容格式dump这些数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$dumper</span> = <span class="keyword">new</span> Twig_Profiler_Dumper_Blackfire();</span><br><span class="line">file_put_contents(<span class="string">'/path/to/profile.prof'</span>, <span class="variable">$dumper</span>-&gt;dump(<span class="variable">$profile</span>));</span><br></pre></td></tr></table></figure>
<p>上传并显示它(先创建个<a href="https://blackfire.io/signup" target="_blank" rel="external">免费帐号</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blackfire --slot=<span class="number">7</span> upload /path/to/profile.prof</span><br></pre></td></tr></table></figure>
<h4 id="优化扩展">优化扩展</h4><p>optimizer扩展会在编译模板之前对节点树进行优化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="keyword">new</span> Twig_Extension_Optimizer());</span><br></pre></td></tr></table></figure>
<p>默认情况下，所有的优化都是启用的。你也可以在构造器中传递您需要激活的扩展。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$optimizer</span> = <span class="keyword">new</span> Twig_Extension_Optimizer(Twig_NodeVisitor_Optimizer::OPTIMIZE_FOR);</span><br><span class="line"></span><br><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="variable">$optimizer</span>);</span><br></pre></td></tr></table></figure>
<p>Twig支持下列优化：</p>
<ul>
<li>Twig_NodeVisitor_Optimizer：OPTIMIZE_ALL  默认值，启用所有优化</li>
<li>Twig_NodeVisitor_Optimizer：OPTIMIZE_NONE  禁用所有的优化，这回减少编译时间，但是会增加执行时间和内存消耗。</li>
<li>Twig_NodeVisitor_Optimizer::OPTIMIZE_FOR  尽可能减少loop变量的创建，以提高for标记的效率。</li>
<li>Twig_NodeVisitor_Optimizer::OPTIMIZE_RAW_FILTER  尽可能移出raw filter</li>
<li>Twig_NodeVisitor_Optimizer::OPTIMIZE_VAR_ACCESS  尽可能的简化编译模版中变量的创建和访问</li>
</ul>
<h3 id="异常">异常</h3><p>Twig能抛出的异常：</p>
<ul>
<li>Twig_Error：所有异常</li>
<li>Twig_Error_Syntax：语法错误</li>
<li>Twig_Error_Runtime：运行时错误（当前实例中不包含某个filter）</li>
<li>Twig_Error_Loader：模板载入时的异常</li>
<li>Twig_Sandbox_SecurityError: 沙盒模式下出现了不允许使用的标记，filter或者调用了不允许调用的方法抛出的异常</li>
</ul>
<h2 id="扩展Twig">扩展Twig</h2><p><em>本章描述了如何对Twig 1.12进行扩展。如果你在使用一个旧版本，请移步到<a href="http://twig.sensiolabs.org/doc/advanced_legacy.html" target="_blank" rel="external">过往文档</a>继续阅读。</em></p>
<p>有多重扩展Twig的方法，可以加入额外的标记、Filter、Test、操作符、全局变量以及函数，甚至还能利用Node visitors对解析器本身进行扩展。</p>
<p><em>本文的第一章节会介绍如何简单地扩展Twig。如果你想要在不同项目中进行复用，或者共享给他人使用，你应该按照接下来章节描述的那样创建一个扩展。</em></p>
<p>在开始之前，你必须理解不同扩展点的区别及其应用场景。</p>
<p>首先，你需要记住的是，Twig有两个主要的语法结构：</p>

- {{}}：用来输出一个表达式的结果
- {%%}：用来执行语句

<p>要理解为什么Twig提供这么多扩展点，先让我们看一下如何实现一个<code>Lorem ipsum</code>生成器。</p>
<p>你可以使用一个名为<code>lipsum</code>的标记：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% lipsum <span class="number">40</span> %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>这样的确可以起到效果，但是，使用<code>lipsum</code>标记的确不是一个好主意，因为：</p>
<ul>
<li>lipsum不是一个语言结构</li>
<li>这个标记输出了东西</li>
<li>这个标记不够灵活，不能在表达式中复用</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">'some text'</span> ~ &#123;% lipsum <span class="number">40</span> %&#125; ~ <span class="string">'some more text'</span> &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>事实上，你很少会使用标记；不过这也是个好消息——Tag的扩展是Twig扩展方式中最复杂的一种。</p>
<p>接下来，我们来试试filter的方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="number">40</span>|lipsum &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>再一次，它达到了效果，但是却看上去很古怪。filter用来把输入转换成输出，但是这里我们输入了的值是用于指示生成单词的数量——也就是说，40是一个参数，但不是我们转换的目标。</p>
<p>接下来，我们使用<code>lipsum</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; lipsum(<span class="number">40</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们也成功了。对于这个例子来说，这个扩展点的选择是合适的。现在可以在任何接受表达式的地方使用它了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">'some text'</span> ~ lipsum(<span class="number">40</span>) ~ <span class="string">'some more text'</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;% set lipsum = lipsum(<span class="number">40</span>) %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>最后，还可以使用带有方法的全局对象来生成这些文字：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; text.lipsum(<span class="number">40</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="全局变量-1">全局变量</h3><p>全局变量和其它的模版变量类似，只不过全局变量在所有的模版和宏定义中都有效：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addGlobal(<span class="string">'text'</span>, <span class="keyword">new</span> Text());</span><br></pre></td></tr></table></figure>
<p>接下来你就可以在任何地方使用<code>text</code>变量了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; text.lipsum(<span class="number">40</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Filters-1">Filters</h3><p>创建一个filter就是简单的给一个PHP回调一个名字：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匿名函数</span></span><br><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_rot13(<span class="variable">$string</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者一个简单的php函数</span></span><br><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="string">'str_rot13'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者一个类的方法</span></span><br><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="keyword">array</span>(<span class="string">'SomeClass'</span>, <span class="string">'rot13Filter'</span>));</span><br></pre></td></tr></table></figure>
<p>传递给<code>Twig_SimpleFilter</code>构造器的第一个参数是将要在模版中使用的filter的名字，第二个参数是关于这个参数的php回调函数。</p>
<p>接下来，将filter加入到你的Twig环境中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addFilter(<span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure>
<p>然后就可以在模版中使用了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">'Twig'</span>|rot13 &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="comment"># 输出： Gjvt #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>当Twig调用的时候，会把管道符左边的值作为第一个参数，并把括号中的Filter参数作为附加参数传递给回调。</p>
<p>例如，下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;&#123; <span class="string">'TWIG'</span>|lower &#125;&#125;</span><br><span class="line">&#123;&#123; now|date(<span class="string">'d/m/Y'</span>) &#125;&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>会被编译成下面这个样子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span> <span class="keyword">echo</span> strtolower(<span class="string">'TWIG'</span>) <span class="preprocessor">?&gt;</span></span><br><span class="line"><span class="preprocessor">&lt;?php</span> <span class="keyword">echo</span> twig_date_format_filter(<span class="variable">$now</span>, <span class="string">'d/m/Y'</span>) <span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>Twig_SimpleFilter</code>类将选项数组作为它的最后一个参数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="string">'str_rot13'</span>, <span class="variable">$options</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Filter环境感知">Filter环境感知</h4><p>如果要在filter中访问当前的environment实例，需要在option中设置needs_environment为true；这样Twig就会把当前环境作为第一个参数传给filter：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Twig_Environment <span class="variable">$env</span>, <span class="variable">$string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前实例的字符集</span></span><br><span class="line">    <span class="variable">$charset</span> = <span class="variable">$env</span>-&gt;getCharset();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str_rot13(<span class="variable">$string</span>);</span><br><span class="line">&#125;, <span class="keyword">array</span>(<span class="string">'needs_environment'</span> =&gt; <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure>
<h4 id="Filter上下文感知">Filter上下文感知</h4><p>在Twig中访问上下文，则需要在option中设置needs_context为true，Twig就会吧当前上下文作为第一个参数（如果还设置了needs_environment为true，那么就会是第二个参数）进行传递：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$context</span>, <span class="variable">$string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="keyword">array</span>(<span class="string">'needs_context'</span> =&gt; <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Twig_Environment <span class="variable">$env</span>, <span class="variable">$context</span>, <span class="variable">$string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="keyword">array</span>(<span class="string">'needs_context'</span> =&gt; <span class="keyword">true</span>, <span class="string">'needs_environment'</span> =&gt; <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure>
<h4 id="自动转义-1">自动转义</h4><p>如果启用了自动转义，filter的输出会在打印之前被转义。如果你的filter就是作为一个转义器（或者显式的输出HTML以及JavaScript代码），那么就需要输出原文。这种情况下，可以使用is_safe选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'nl2br'</span>, <span class="string">'nl2br'</span>, <span class="keyword">array</span>(<span class="string">'is_safe'</span> =&gt; <span class="keyword">array</span>(<span class="string">'html'</span>)));</span><br></pre></td></tr></table></figure>
<h4 id="参数可变的Filters">参数可变的Filters</h4><p>Twig1.19中新增可变参数filters</p>
<p>当需要一个filter接收的参数个数可变时，设置<code>is_variadic</code>选项为true；Twig会把余下的参数作为一个数组传递给filter的最后一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'thumbnail'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$file</span>, array <span class="variable">$options</span> = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;, <span class="keyword">array</span>(<span class="string">'is_variadic'</span> =&gt; <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure>
<h4 id="动态Filters">动态Filters</h4><p>名字中带有特殊字符”*“的filter就是一个动态filter：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'*_path'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$name</span>, <span class="variable">$arguments</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面定义的动态filter将会匹配下述列表：</p>
<ul>
<li>product_path</li>
<li>category_path</li>
</ul>
<p>动态Filter能够定义一个或者多个通配符部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filter</span> = <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'*_path_*'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$name</span>, <span class="variable">$suffix</span>, <span class="variable">$arguments</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个Filter能够接受所有的动态值，并摆放在（环境和上下文之后）其他参数之前。例如，对’foo’|a_path_b()的调用，会传递这些参数：(‘a’, ‘b’, ‘foo’)。</p>
<h3 id="函数-1">函数</h3><p>函数的定义类似于filter，但是你需要创建一个<code>Twig_SimpleFunction</code>的实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$function</span> = <span class="keyword">new</span> Twig_SimpleFunction(<span class="string">'function_name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addFunction(<span class="variable">$function</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Tests">Tests</h3><p>Tests的定义和filter和函数的定义方法相同，你只需要创建一个<code>Twig_SimpleTest</code>实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Twig_SimpleTest(<span class="string">'test_name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addTest(<span class="variable">$test</span>);</span><br></pre></td></tr></table></figure>
<p>Tests允许创建自定义的带有逻辑处理的应用来处理布尔值的条件判断。举个简单的例子，创建一个Twig test来检测对象是否是‘red’：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Twig_SimpleTest(<span class="string">'red'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(<span class="variable">$value</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$value</span>-&gt;color) &amp;&amp; <span class="variable">$value</span>-&gt;color == <span class="string">'red'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$value</span>-&gt;paint) &amp;&amp; <span class="variable">$value</span>-&gt;paint == <span class="string">'red'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addTest(<span class="variable">$test</span>);</span><br></pre></td></tr></table></figure>
<p>Test函数只返回true/false。</p>
<p>当创建Test的时候，可以使用node_class选项来提供自定义的测试编制。如果你的test可以编译成PHP原语，这个办法就很有用了，这个办法在很多Twig的内置Test中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Twig_SimpleTest(</span><br><span class="line">    <span class="string">'odd'</span>,</span><br><span class="line">    <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'node_class'</span> =&gt; <span class="string">'Twig_Node_Expression_Test_Odd'</span>));</span><br><span class="line"><span class="variable">$twig</span>-&gt;addTest(<span class="variable">$test</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Twig_Node_Expression_Test_Odd</span> <span class="keyword">extends</span> <span class="title">Twig_Node_Expression_Test</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">(Twig_Compiler <span class="variable">$compiler</span>)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$compiler</span></span><br><span class="line">      -&gt;raw(<span class="string">'('</span>)</span><br><span class="line">      -&gt;subcompile(<span class="variable">$this</span>-&gt;getNode(<span class="string">'node'</span>))</span><br><span class="line">      -&gt;raw(<span class="string">' % 2 == 1'</span>)</span><br><span class="line">      -&gt;raw(<span class="string">')'</span>)</span><br><span class="line">    ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Tags">Tags</h3><p>Twig最令人激动的特性就是可以定义新的语言结构。这也是你需要理解的关于Twig最复杂的关于如何工作的特性。</p>
<p>让我们创建一个简单的set标记，这个标记用来在模板中定义一个简单变量，这个标记的用法如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">&#123;% set name = <span class="string">"value"</span> %&#125;</span><br><span class="line">&#123;&#123; name &#125;&#125;</span><br><span class="line">&#123;<span class="comment"># 输出 value #&#125;</span></span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>三个步骤即可定义一个新的标记：</p>
<ul>
<li>定义一个Token解析器（用来解析模板代码）</li>
<li>定义一个节点类(用于把解析的结果转换成PHP)</li>
<li>注册这个标记</li>
</ul>
<h4 id="注册一个新的标记">注册一个新的标记</h4><p>简单的调用<code>Twig_Environment</code>实例的<code>addTokenParser</code>方法即可添加一个标记：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addTokenParser(<span class="keyword">new</span> Project_Set_TokenParser());</span><br></pre></td></tr></table></figure>
<h4 id="定义一个token解析器">定义一个token解析器</h4><p>来看下代码实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Set_TokenParser</span> <span class="keyword">extends</span> <span class="title">Twig_TokenParser</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span><span class="params">(Twig_Token <span class="variable">$token</span>)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$parser</span> = <span class="variable">$this</span>-&gt;parser;</span><br><span class="line">    <span class="variable">$stream</span> = <span class="variable">$parser</span>-&gt;getStream();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$stream</span>-&gt;expect(Twig_Token::NAME_TYPE)-&gt;getValue();</span><br><span class="line">    <span class="variable">$stream</span>-&gt;expect(Twig_Token::OPERATOR_TYPE, <span class="string">'='</span>);</span><br><span class="line">    <span class="variable">$value</span> = <span class="variable">$parser</span>-&gt;getExpressionParser()-&gt;parseExpression();</span><br><span class="line">    <span class="variable">$stream</span>-&gt;expect(Twig_Token::BLOCK_END_TYPE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Project_Set_Node(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$token</span>-&gt;getLine(), <span class="variable">$this</span>-&gt;getTag());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTag</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'set'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getTag()</code>方法必须返回我们要解析的标记，这里返回的就是<code>set</code>.</p>
<p><code>parse()</code>方法在解析器遇到<code>set</code>标记的时候就会被调用。这个方法应该返回一个<code>Twig_Node</code>实例用于显示这个结点。</p>
<p>Token流（$this-&gt;parser-&gt;getStream()）提供了一系列方法，简化了解析过程：</p>
<ul>
<li>getCurrent()：从流中获取当前的token</li>
<li>next()：移动到流中的下一个Token，并返回之前的一个</li>
<li>test($type), test($value）或者test($type, $value)：判断当前token是不是某种类型或值（或同时满足）。值可以是一个包含很多值的数组。</li>
<li>expect($type[, $value[, $message]])：如果当前token不是指定的类型或值，就给出一个语法错误。否则，如果值和类型都正确，则返回当前token，并移动到下一个Token。</li>
<li>look()：查看但不使用下一个token</li>
</ul>
<p>像set标记这样，通过调用<code>parseExpression()</code>完成对表达式的解析。</p>
<h4 id="定义一个节点">定义一个节点</h4><p>Project_Set_Node类很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Set_Node</span> <span class="keyword">extends</span> <span class="title">Twig_Node</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(<span class="variable">$name</span>, Twig_Node_Expression <span class="variable">$value</span>, <span class="variable">$line</span>, <span class="variable">$tag</span> = null)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">parent</span>::__construct(<span class="keyword">array</span>(<span class="string">'value'</span> =&gt; <span class="variable">$value</span>), <span class="keyword">array</span>(<span class="string">'name'</span> =&gt; <span class="variable">$name</span>), <span class="variable">$line</span>, <span class="variable">$tag</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span><span class="params">(Twig_Compiler <span class="variable">$compiler</span>)</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="variable">$compiler</span></span><br><span class="line">        -&gt;addDebugInfo(<span class="variable">$this</span>)</span><br><span class="line">        -&gt;write(<span class="string">'$context[\''</span>.<span class="variable">$this</span>-&gt;getAttribute(<span class="string">'name'</span>).<span class="string">'\'] = '</span>)</span><br><span class="line">        -&gt;subcompile(<span class="variable">$this</span>-&gt;getNode(<span class="string">'value'</span>))</span><br><span class="line">        -&gt;raw(<span class="string">";\n"</span>)</span><br><span class="line">    ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译器实现了一套接口和方法用于帮助开发者生成美观易读的PHP代码：</p>
<ul>
<li>subcompile()：编译一个结点</li>
<li>raw()：原文输出字符串</li>
<li>write()：输出首行缩进的字符串</li>
<li>string()：输出引用字符</li>
<li>repr()：输出php结果值</li>
<li>addDebugInfo()：把与当前节点相关的原始模板文件当作注释添加进来</li>
<li>indent()：缩进生成的代码</li>
<li>outdent()：伸出生成的代码</li>
</ul>
<h3 id="创建一个扩展">创建一个扩展</h3><p>开发扩展的一个主要目的可能就是为了将经常使用的功能规范称一个可复用的类，比如说，国际化支持。一个扩展可以指定标记、Filter、Test、运算符、全局变量、函数以及Node visitors。</p>
<p>扩展还可以分离编译时和运行时的代码，加快代码的运行速度。</p>
<p>大多数时候，创建一个单独的包含所有标记和filters的扩展将对你的项目很有用。</p>
<p>一个扩展就是一个实现了下面这个接口的类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Twig_ExtensionInterface</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Initializes the runtime environment.</span><br><span class="line">   *</span><br><span class="line">   * This is where you can load some file that contains filter functions for instance.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @param</span> Twig_Environment $environment The current Twig_Environment instance</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @deprecated</span> since 1.23 (to be removed in 2.0), implement Twig_Extension_InitRuntimeInterace instead</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">initRuntime</span><span class="params">(Twig_Environment <span class="variable">$environment</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns the token parser instances to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of Twig_TokenParserInterface or Twig_TokenParserBrokerInterface instances</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getTokenParsers</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns the node visitor instances to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of Twig_NodeVisitorInterface instances</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getNodeVisitors</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns a list of filters to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of filters</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getFilters</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns a list of tests to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of tests</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getTests</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns a list of functions to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of functions</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getFunctions</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns a list of operators to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of operators</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getOperators</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns a list of global variables to add to the existing list.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> array An array of global variables</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @deprecated</span> since 1.23 (to be removed in 2.0), implement Twig_Extension_GlobalsInterface instead</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getGlobals</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Returns the name of the extension.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @return</span> string The extension name</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了保持扩展类的整洁与稳定，还可以只继承内置的<code>Twig_Extension</code>类而不需要实现所有的接口。采用这种该方式的话，你只需要实现<code>getName()</code>方法。</p>
<p><code>getName()</code>方法必须返回这个扩展的唯一标识符</p>
<p>现在我们来是一个最简单的扩展：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'project'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">Twig不关心你的扩展存在何处，因为所有的扩展都需要显示的注册。通过调用`Environment`对象的`addExtension()`方法即可注册一个扩展。</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line"><span class="variable">$twig</span> = <span class="keyword">new</span> Twig_Environment(<span class="variable">$loader</span>);</span><br><span class="line"><span class="variable">$twig</span>-&gt;addExtension(<span class="keyword">new</span> Project_Twig_Extension());</span><br></pre></td></tr></table></figure>
<h4 id="全局变量-2">全局变量</h4><p>通过调用<code>getGlobals()</code>方法即可以在扩展中注册全局变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getGlobals</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'text'</span> =&gt; <span class="keyword">new</span> Text(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数-2">函数</h4><p>通过调用<code>getFunctions()</code>方法即可以在扩展中注册函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFunctions</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">new</span> Twig_SimpleFunction(<span class="string">'lipsum'</span>, <span class="string">'generate_lipsum'</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Filters-2">Filters</h4><p>为了将filter添加到一个扩展中，你需要覆写<code>getFilters()</code>方法。这个方法必须返回一个添加到Twig环境的filters数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilters</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">new</span> Twig_SimpleFilter(<span class="string">'rot13'</span>, <span class="string">'str_rot13'</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="标记">标记</h4><p>通过覆写<code>getTokenParsers()</code>方法就可以将一个标记添加到一个扩展中。这个方法必须返回一个天极到Twig环境的tags数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenParsers</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="keyword">new</span> Project_Set_TokenParser());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="操作符">操作符</h4><p><code>getOperators()</code>方法用来新增新的操作符。下面的例子是如何添加!，||以及&amp;&amp;操作符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getOperators</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">      <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'!'</span> =&gt; <span class="keyword">array</span>(<span class="string">'precedence'</span> =&gt; <span class="number">50</span>, <span class="string">'class'</span> =&gt; <span class="string">'Twig_Node_Expression_Unary_Not'</span>),</span><br><span class="line">      ),</span><br><span class="line">      <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="keyword">array</span>(<span class="string">'precedence'</span> =&gt; <span class="number">10</span>, <span class="string">'class'</span> =&gt; <span class="string">'Twig_Node_Expression_Binary_Or'</span>, <span class="string">'associativity'</span> =&gt; Twig_ExpressionParser::OPERATOR_LEFT),</span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="keyword">array</span>(<span class="string">'precedence'</span> =&gt; <span class="number">15</span>, <span class="string">'class'</span> =&gt; <span class="string">'Twig_Node_Expression_Binary_And'</span>, <span class="string">'associativity'</span> =&gt; Twig_ExpressionParser::OPERATOR_LEFT),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Tests-1">Tests</h4><p>getTests()方法用来添加新的Test函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Project_Twig_Extension</span> <span class="keyword">extends</span> <span class="title">Twig_Extension</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTests</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">new</span> Twig_SimpleTest(<span class="string">'even'</span>, <span class="string">'twig_test_even'</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://static.verycloud.cn/sites/default/files/pic/image/20150607/2015060790205_41484.jpeg" alt="RamboLau" itemprop="image"/>
          <p class="site-author-name" itemprop="name">RamboLau</p>
        </div>
        <p class="site-description motion-element" itemprop="description">记录生活，分享知识，传播乐趣</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives/">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories/">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags/">
              <span class="site-state-item-count">52</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/RamboLau" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RamboLau</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"176code"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
