<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.useso.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Drupal linux unix vim" />





  <link rel="alternate" href="/atom.xml" title="Rambo's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="记录生活，分享知识，传播乐趣">
<meta property="og:type" content="website">
<meta property="og:title" content="Rambo's Blog">
<meta property="og:url" content="http://verynull.com/page/4/index.html">
<meta property="og:site_name" content="Rambo's Blog">
<meta property="og:description" content="记录生活，分享知识，传播乐趣">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rambo's Blog">
<meta name="twitter:description" content="记录生活，分享知识，传播乐趣">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Rambo's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Rambo's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">记录生活，分享知识，传播乐趣</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    
      
      

      
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/14/Drupal8-Javascript/" itemprop="url">
                  drupal8 javascript
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-14T22:00:02+08:00" content="2015-12-14">
              2015-12-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/14/Drupal8-Javascript/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/14/Drupal8-Javascript/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="JavaScript_编码规范建议">JavaScript 编码规范建议</h2><p>本文就 JavaScript 编码过程中涉及的排版、命名、声明、作用域、及一些特殊符号的使用等方面，根据个人在学习工作中的总结，给出自己的一些建议，并分析其中缘由，以供参考。</p>
<h3 id="JavaScript_文件引用">JavaScript 文件引用</h3><p>JavaScript 程序应该尽量放在 .js 的文件中，需要调用的时候在 HTML 中以<code>&lt;script src=&quot;filename.js&quot;&gt;</code>的形式包含进来。JavaScript 代码若不是该 HTML 文件所专用的，则应尽量避免在 HTML 文件中直接编写 JavaScript 代码。因为这样会大大增加 HTML 文件的大小，无益于代码的压缩和缓存的使用。<br>另外，<code>&lt;script src=&quot;filename.js&quot;&gt;</code>标签应尽量放在文件的后面。这样会降低因加载 JavaScript 代码而影响页面中其它组件的加载时间。</p>
<h3 id="代码排版">代码排版</h3><h4 id="行长度">行长度</h4><p><strong>每行代码应小于 80 个字符</strong>。如果代码较长，应尽量选择换行，下一行代码应缩进8 个空格。这样可以使代码排版整齐，减轻阅读代码的疲劳感。</p>
<h4 id="行结束">行结束</h4><p><strong>JavaScript 语句应该以分号结束</strong>。但大多数浏览器允许不写分号，只要在本应是分号的地方有一个换行符就行。但是如果代码行较长需要换行的时候，有哪些注意事项呢？换行应选择在操作符和标点符号之后，最好是在逗号’,’之后，而不要在变量名、字符串、数字、或’)’ ‘]’ ‘++’ ‘—‘等符号之后换行。<br>这样可以有效的防止拷贝、粘贴而引起的错误，并可有效地增强代码的可阅读性。</p>
<h4 id="缩进">缩进</h4><p>本文提倡用 <strong>2个空格</strong> 来进行缩进，并在同一产品中采用同一种缩进标准。不支持用TAB键进行缩进，这是因为直到现在还没有统一的标准来定义 TAB 键所代替的空白大小，有些编辑器解析为 4 个空格大小，有些则解析为 8 个。</p>
<h4 id="注释">注释</h4><p>单行注释规范：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init variable count.</span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以”//“开头，然后有一个空格，第一个单词的首字母需要大写，<br>当然要是中文的话就无所谓了，最后要以英文句号“.”结尾</p>
</blockquote>
<p>还有一种块级注释<code>/*....*/</code>用作对整个代码段的注销，或较正式的声明中，如函数参数、功能、文件功能等的描述中。</p>
<h4 id="标识符命名">标识符命名</h4><p>JavaScript 中的标识符的命名规则：</p>
<ul>
<li>以字母、下划线<code>_</code>或美元符号<code>$</code>开头</li>
<li>允许名称中包含字母，数字，下划线<code>_</code>和美元符号<code>$</code></li>
<li>区分大小写</li>
</ul>
<p>变量、参数、成员变量、函数等名称均以小写字母开头，构造器的名称以大写字母开头。下划线<code>_</code>开头的变量一般习惯于标识私有 / 局部成员。而美元符号<code>$</code>开头的变量习惯于标识系统相关，比如系统进程等。应避免用下划线<code>_</code>或美元符号<code>$</code>来命名标识符。尽可能地降低代码的阅读负担。</p>
<h4 id="声明">声明</h4><h5 id="变量的声明">变量的声明</h5><p>尽管 JavaScript 语言并不要求在变量使用前先对变量进行声明。但我们还是应该养成这个好习惯。这样可以比较容易的检测出那些未经声明的变量，避免其变为隐藏的全局变量，造成隐患。</p>
<p>在函数的开始应先用 var 关键字声明函数中要使用的局部变量，注释变量的功能及代表的含义，且应以字母顺序排序。每个变量单独占一行，以便添加注释。这是因为 JavaScript 中只有函数的 {} 表明作用域，用 var 关键字声明的局部变量只在函数内有效，而未经 var 声明的变量则被视为全局变量。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> valueA  = <span class="string">'a'</span>;</span><br><span class="line">  <span class="keyword">var</span> valueB  = <span class="string">'b'</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> valueA = <span class="string">'c'</span>;</span><br><span class="line">    <span class="comment">// Output: valueA=c.</span></span><br><span class="line">    alert(<span class="string">'valueA='</span> + valueA);</span><br><span class="line">    valueB = <span class="string">'d'</span>;</span><br><span class="line">    <span class="comment">// Output: valueB=d.</span></span><br><span class="line">    alert(<span class="string">'valueB='</span> + valueB);</span><br><span class="line">  &#125;</span><br><span class="line">  f1();</span><br><span class="line">  <span class="comment">// Output: valueA=a.</span></span><br><span class="line">  alert(<span class="string">'valueA='</span> + valueA);</span><br><span class="line">  <span class="comment">// Output: valueB=d.</span></span><br><span class="line">  alert(<span class="string">'valueB='</span> + valueB);</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>从上例的输出惊奇地发现，用 var 声明过的变量 valueA 和没有声明的变量 valueB 是有区别的。特别需要注意的是，在函数内部用 var 声明的变量为局部变量，这样可以有效地避免因局部变量和全局变量同名而产生的错误。</p>
<h5 id="函数的声明">函数的声明</h5><p>函数也应在调用前进行声明，内部函数应在 var 声明内部变量的语句之后声明，可以清晰地表明内部变量和内部函数的作用域。</p>
<p>此外，函数名紧接左括号’(‘之间，而右括号’)’和后面的’{‘之间要有个空格，以清楚地显示函数名以其参数部分，和函数体的开始。若函数为匿名 / 无名函数，则 function 关键字和左括号’(‘之间要留空格，否则可能误认为该函数的函数名为 function。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> innerA = <span class="number">1</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">outF</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> innerA = <span class="number">2</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_inF</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      alert(<span class="string">'valueA='</span> + innerA);</span><br><span class="line">    &#125;</span><br><span class="line">    _inF();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Output: valueA=2.</span></span><br><span class="line">  outF();</span><br><span class="line">  <span class="comment">// Error: innerF is not defined.</span></span><br><span class="line">  _inF();</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>从上面例子的输出可以看出，inF() 函数仅在 outF() 函数的内部生效，局部变量 innerA 对内部函数的作用域生效。这样的编码方式使得变量和函数的作用域变得清晰。</p>
<h4 id="语句">语句</h4><p>对于简单语句而言，需要提及的仍然是分号必要性，同时，一行最多有一个语句。如果一个赋值语句是用函数和对象来赋值，可能需要跨多行，一定切记要在赋值语句末加上分号。<br>这是因为 JavaScript 中，所有表达式都可以当语句，遇换行符时会解析为表达式的结束，此时不规范的换行和分号的丢失，可能引入新的错误。<br>对于复合语句，if, for, while, do, switch, try … catch 等代码体，函数定义的函数体，对象的定义等都需要放在花括号’{}’里面。</p>
<ul>
<li>‘{‘ 应在行末，标志代码块的开始。</li>
<li>‘}’ 应在一行开头，标志代码块的结束，同时需要和’{‘所在行的开始对齐，以表明一个完整的复合语句段。这样可以极大地提高代码的可阅读性，控制逻辑能清晰地表现出来。</li>
<li>被包含的代码段应该再缩进 2 个空格。</li>
<li>即使被包含的代码段只有一句，也应该用花括号’{}’包含。尽管不用花括号代码也不会错，但如若需要增加语句的话，则较容易因花括号遗漏而引起的编译错误或逻辑错误。</li>
</ul>
<p><strong>return</strong> 语句在使用时也需慎重，如果用表达式的执行作为返回值，请把表达式和<code>return</code> 放在同一行中，以免换行符被误解析为语句的结束而引起返回错误。return 关键字后若没有返回表达式，则返回 undefined。构造器的默认返回值为 this。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">F1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> valueA  = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> valueB  = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> valueA + valueB;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">F2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> valueA  = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> valueB  = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">      valueA + valueB;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Outut: 3.</span></span><br><span class="line">  alert( F1() );</span><br><span class="line">  <span class="comment">// Output: undefined.</span></span><br><span class="line">  alert( F2() );</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>上例中，因返回表达式没有和 return 关键字放在同一行而引起的返回错误，需重视。</p>
<h4 id="特殊符号">特殊符号</h4><h5 id="空白符">空白符</h5><p>适当的空白行可以大大提高代码的可阅读性，可以使代码逻辑更清晰易懂。同时，在表达式中适当的留空白，也会给代码的阅读带来方便。</p>
<p>关键字的后面如有括号，则最好在关键字和左括号’(‘之间留空白，如 for, if, while 等。而函数名和括号之间则不宜留空白，但若是匿名函数，则必须在 function 和左括号’(‘之间留空白，否则，编辑器会误认为函数名为 function。</p>
<p>在表达式中，二元运算符 ( 除左括号’(‘，左方括号’[‘，作用域点’.’) 和两个操作数之间最好留空白。一元运算符（若不是词 typeof 等）和其操作数之间不宜留空白。</p>
<p>逗号’,’的后面需要留空白，以显示明确的参数间隔，变量间隔等。</p>
<p>分号’;’之后通常表明表达语句的结束，而应空行。在 for 的条件语句中，分号之后则应该留空白。</p>
<h5 id="{_}_和_[_]">{ } 和 [ ]</h5><p>在 JavaScript 中，如需定义空对象和空数组，通常很自然地想到用 new Object() 和 new Array() 的方法。其实花括号’{}’和方括号’[]’可以直接用来定义一个空对象和一个空数组。这种书写方法可以使代码看起来简单易懂。</p>
<h4 id="==_和_===">== 和 ===</h4><p>判断”逻辑等”在代码里太平常的不过事情了，但 JavaScript 与其他熟知的编程语言不同的是，除了可以使用两个等号’==’来作判断以为，还可以使用三个等号’===’来进行逻辑等判断。两者的不同是’==’作逻辑等判断时，会先进行类型转换后再进行比较。’===’则不会。因而，’==’进行的判断结果可能产生偏差。’!=’与’!==’的区别亦是如此。本文提倡尽量使用’===’来进行逻辑等的判断，用’!==’进行逻辑不等的判断。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> valueA = <span class="string">"1"</span>;</span><br><span class="line">  <span class="keyword">var</span> valueB = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( valueA == valueB) &#123;</span><br><span class="line">    alert(<span class="string">"Equal"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    alert(<span class="string">"Not equal"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Output: "Equal".</span></span><br><span class="line">  <span class="keyword">if</span> ( valueA === valueB) &#123;</span><br><span class="line">    alert(<span class="string">"Equal"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    alert(<span class="string">"Not equal"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Output: "Not equal".</span></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>上例中，valueA 和 valueB 两个变量的值显然是不相等的，起码 valueA 是个字符串，而 valueB 是一个数字。但用’==’进行判断是，程序却输出相等的字样。这是因为编译器对两个变量进行比较时，因为他们的类型不同，而自动地将 valueB 转换成字符串，而后再和 valueA 进行比较的。用’===’得到的判断结果正和预期的结果相符。</p>
<h5 id="+">+</h5><p>加号’+’也同样是程序员所熟知的操作符之一。JavaScript 和其他编程语言不同的是，在 JavaScript 中，’+’除了表示数字值相加，字符串相连接以外，还可以作一元运算符用，把字符串转换为数字。因而如果使用不当，则可能与自增符’++’混淆而引起计算错误。这一点，在清单 7 中可以清楚地看出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> valueA = <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">var</span> valueB = <span class="string">"10"</span>;</span><br><span class="line">  <span class="comment">// Ouput: 2010.</span></span><br><span class="line">  alert( valueA + valueB);</span><br><span class="line">  <span class="comment">// Ouput: 30.</span></span><br><span class="line">  alert( valueA + (+valueB));</span><br><span class="line">  <span class="comment">// Ouput: 30.</span></span><br><span class="line">  alert( valueA + +valueB);</span><br><span class="line">  <span class="comment">// Compile error.</span></span><br><span class="line">  alert( valueA ++valueB);</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/12/Drupal8注解-Annotations-语法/" itemprop="url">
                  Drupal8注解(Annotations)语法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-12T10:35:46+08:00" content="2015-12-12">
              2015-12-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/12/Drupal8注解-Annotations-语法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/12/Drupal8注解-Annotations-语法/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>写过java代码的同学，相信大家对注解都不陌生。有些PHP框架也是支持注解的，如Symfony2使用注解定义路由规则，Doctrine使用注解来添加ORM元数据。PHP注解RFC见<a href="https://wiki.php.net/rfc/annotations" title="rfc" target="_blank" rel="external">rfc-annotations</a>。</p>
<p>Drupal8的注解依照<a href="http://docs.doctrine-project.org/projects/doctrine-common/en/latest/reference/annotations.html" target="_blank" rel="external">Doctrine</a>的规范。</p>
<p>本文主要对Drupal8中所用到的注解做分析，欢迎拍砖交流！</p>
<h3 id="一、注解的争议">一、注解的争议</h3><p>目前对注解的争议主要有这么几点。</p>
<h4 id="1、如何区分注解和注释？">1、如何区分注解和注释？</h4><h4 id="2、为什么要把业务逻辑放在注释中？难道他们不是一个核心语言语义的一部分？">2、为什么要把业务逻辑放在注释中？难道他们不是一个核心语言语义的一部分？</h4><h4 id="3、注解和注释代码容易混淆，如果开发人员忘记定义了注解，程序并不会报错，但是可能不会像预期的工作。">3、注解和注释代码容易混淆，如果开发人员忘记定义了注解，程序并不会报错，但是可能不会像预期的工作。</h4><h4 id="4、注解不好测试、调试。">4、注解不好测试、调试。</h4><h3 id="二、注解的优势">二、注解的优势</h3><h4 id="1、不用写很多代码就可以实现注入。如：">1、不用写很多代码就可以实现注入。如：</h4><p>我们要把weapon对象注入到soldier实例中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weapon</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"... shooting ..."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Soldier</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$weapon</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setWeapon</span><span class="params">(<span class="variable">$weapon</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;weapon = <span class="variable">$weapon</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;weapon-&gt;shoot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要实现这个功能，要这样写代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$weapon</span> = <span class="keyword">new</span> Weapon();</span><br><span class="line"></span><br><span class="line"><span class="variable">$soldier</span> = <span class="keyword">new</span> Soldier();</span><br><span class="line"><span class="variable">$soldier</span>-&gt;setWeapon(<span class="variable">$weapon</span>); </span><br><span class="line"><span class="variable">$soldier</span>-&gt;fight();</span><br></pre></td></tr></table></figure>
<p>如果我们用注解，就变得简单多了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Soldier</span> </span>&#123;  </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *<span class="phpdoc"> @inject</span> $weapon Weapon</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setWeapon</span><span class="params">(<span class="variable">$weapon</span>)</span> </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;weapon = <span class="variable">$weapon</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只需要2行代码就可以了</span></span><br><span class="line"><span class="variable">$soldier</span> = <span class="keyword">new</span> Soldier();</span><br><span class="line"><span class="variable">$soldier</span>-&gt;fight();</span><br></pre></td></tr></table></figure>
<h4 id="2、Drupal8执行时，内存使用大大减少。在Drupal7中，通过hook定义元数据，这样就导致每个请求都需要把所有的模块加载到内存中，而Drupal8仅解析注解，并加载进内存，这样就可以占用很小的内存。">2、Drupal8执行时，内存使用大大减少。在Drupal7中，通过hook定义元数据，这样就导致每个请求都需要把所有的模块加载到内存中，而Drupal8仅解析注解，并加载进内存，这样就可以占用很小的内存。</h4><h3 id="三、语法">三、语法</h3><p>注解的数据结构是类似json key-value。<br>让我们来看text模块的TextDefaultFormatter.php文件中的定义。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Plugin implementation of the 'text_default' formatter.</span><br><span class="line"> *</span><br><span class="line"> *<span class="phpdoc"> @FieldFormatter</span>(</span><br><span class="line"> *   id = "text_default",</span><br><span class="line"> *   label =<span class="phpdoc"> @Translation</span>("Default"),</span><br><span class="line"> *   field_types = &#123;</span><br><span class="line"> *     "text",</span><br><span class="line"> *     "text_long",</span><br><span class="line"> *     "text_with_summary"</span><br><span class="line"> *   &#125;,</span><br><span class="line"> *   quickedit = &#123;</span><br><span class="line"> *     "editor" = "plain_text"</span><br><span class="line"> *   &#125;</span><br><span class="line"> * )</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextDefaultFormatter</span> <span class="keyword">extends</span> <span class="title">FormatterBase</span> </span>&#123;  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>以下是一些规范：</p>
<h4 id="1、必须以一个唯一的id开始，类似Drupal7的machine_name">1、必须以一个唯一的id开始，类似Drupal7的machine name</h4><h4 id="2、顶级的Keys可以使用双引号">2、顶级的Keys可以使用双引号</h4><h4 id="3、下级的Keys必须使用双引号">3、下级的Keys必须使用双引号</h4><h4 id="4、必须使用双引号，单引号会造成语法错误">4、必须使用双引号，单引号会造成语法错误</h4><h4 id="5、value允许的数据类型">5、value允许的数据类型</h4><pre><code>&gt; 字符串(<span class="type">string</span>)：必须使用双引号,如<span class="string">"foo"</span>，使用一对双引号包含双引号字符，如<span class="string">"The "</span><span class="string">"On"</span><span class="string">" value "</span>
&gt; 数字(<span class="type">number</span>)：不能使用引号，如果使用引号，会被解析成字符串
&gt; 布尔型(bool)：不能使用引号，如果使用引号，会被解析成字符串
&gt; <span class="type">list</span>：必须使用花括号，末尾不能使用逗号。如
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">field_types = &#123;</span><br><span class="line">	<span class="string">"text"</span>,</span><br><span class="line">	<span class="string">"text_long"</span>,</span><br><span class="line">	<span class="string">"text_with_summary"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>&gt; <span class="built_in">map</span>: 必须使用花括号，<span class="variable">key</span>-value用＝号分割，默认不能使用逗号。如：    
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">quickedit = &#123;</span><br><span class="line">	<span class="string">"editor"</span> = <span class="string">"plain_text"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code><span class="blockquote">&gt; 允许定义常量</span>
</code></pre><h3 id="四、自定义注解类">四、自定义注解类</h3><p>Drupal8中的一些基础plugin如entity,views等会被自动加载。当然，你可以在自定义的类中给plugin提供文档和参数。</p>
<p>我们还是以text模块举例说明，在text/src/Plugin/field/formatter/TextPlainFormatter.php中定义了plaintext，并且自定义了一个叫FieldFormatter的注解类。</p>
<p>注意：所有的注解类都是继承自 \Drupal\Component\Annotation\Plugin。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Plugin implementation of the 'text_plain' formatter.</span><br><span class="line"> *</span><br><span class="line"> *<span class="phpdoc"> @FieldFormatter</span>(</span><br><span class="line"> *   id = "text_plain",</span><br><span class="line"> *   label =<span class="phpdoc"> @Translation</span>("Plain text"),</span><br><span class="line"> *   field_types = &#123;</span><br><span class="line"> *     "text",</span><br><span class="line"> *     "text_long",</span><br><span class="line"> *     "text_with_summary"</span><br><span class="line"> *   &#125;,</span><br><span class="line"> *   edit = &#123;</span><br><span class="line"> *     "editor" = "direct"</span><br><span class="line"> *   &#125;</span><br><span class="line"> * )</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextPlainFormatter</span> </span>&#123;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="五、自定义插件类型中使用注解">五、自定义插件类型中使用注解</h3><p>如果你想在自定义plugin类型中使用注解，可以用AnnotatedClassDiscovery类。</p>
<p>AnnotatedClassDiscovery构造函数的第一个参数是这个plugin类型所存放的目录结构。</p>
<p>如下面的代码，plugin在目录$module/src/Plugin/field/formatter中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Plugin</span>\<span class="title">Discovery</span>\<span class="title">AnnotatedClassDiscovery</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormatterPluginManager</span> <span class="keyword">extends</span> <span class="title">PluginManagerBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Constructs a FormatterPluginManager object.</span><br><span class="line">   *</span><br><span class="line">   *<span class="phpdoc"> @param</span> array $namespaces</span><br><span class="line">   *   An array of paths keyed by their corresponding namespaces.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array <span class="variable">$namespaces</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This is the essential line you have to use in your manager.</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;discovery = <span class="keyword">new</span> AnnotatedClassDiscovery(<span class="string">'Plugin/field/formatter'</span>, <span class="variable">$namespaces</span>);</span><br><span class="line">    <span class="comment">// Every other line is a good practice.</span></span><br><span class="line">    <span class="variable">$this</span>-&gt;discovery = <span class="keyword">new</span> ProcessDecorator(<span class="variable">$this</span>-&gt;discovery, [<span class="variable">$this</span>, <span class="string">'processDefinition'</span>]);</span><br><span class="line">    <span class="variable">$this</span>-&gt;discovery = <span class="keyword">new</span> AlterDecorator(<span class="variable">$this</span>-&gt;discovery, <span class="string">'field_formatter_info'</span>);</span><br><span class="line">    <span class="variable">$this</span>-&gt;discovery = <span class="keyword">new</span> CacheDecorator(<span class="variable">$this</span>-&gt;discovery, <span class="string">'field_formatter_types'</span>, <span class="string">'field'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>注入的命名空间来自于依赖注入容器，如FieldBundle：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *<span class="phpdoc"> @file</span></span><br><span class="line"> * Contains Drupal\field\FieldBundle.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">field</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerBuilder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Bundle</span>\<span class="title">Bundle</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Field dependency injection container.</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FieldBundle</span> <span class="keyword">extends</span> <span class="title">Bundle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Overrides Symfony\Component\HttpKernel\Bundle\Bundle::build().</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">(ContainerBuilder <span class="variable">$container</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Register the plugin managers for our plugin types with the dependency injection container.</span></span><br><span class="line">    <span class="variable">$container</span>-&gt;register(<span class="string">'plugin.manager.field.widget'</span>, <span class="string">'Drupal\field\Plugin\Type\Widget\WidgetPluginManager'</span>)</span><br><span class="line">      -&gt;addArgument(<span class="string">'%container.namespaces%'</span>);</span><br><span class="line">    <span class="variable">$container</span>-&gt;register(<span class="string">'plugin.manager.field.formatter'</span>, <span class="string">'Drupal\field\Plugin\Type\Formatter\FormatterPluginManager'</span>)</span><br><span class="line">      -&gt;addArgument(<span class="string">'%container.namespaces%'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要调用自定义的plugin管理器，需要在构造函数调用的时候注入命名空间。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"> <span class="variable">$type</span> = <span class="keyword">new</span> CustomPluginManager(\Drupal::getContainer()-&gt;getParameter(<span class="string">'container.namespaces'</span>)); </span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="六、Entity注解">六、Entity注解</h3><p>Entity类型不管是配置还是内容实体都必须用注解定义。</p>
<p>如：core/modules/user/src/Entity/User.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Defines the user entity class.</span><br><span class="line"> *</span><br><span class="line"> * The base table name here is plural, despite Drupal table naming standards,</span><br><span class="line"> * because "user" is a reserved word in many databases.</span><br><span class="line"> *</span><br><span class="line"> *<span class="phpdoc"> @ContentEntityType</span>(</span><br><span class="line"> *   id = "user",</span><br><span class="line"> *   label =<span class="phpdoc"> @Translation</span>("User"),</span><br><span class="line"> *   handlers = &#123;</span><br><span class="line"> *     "storage" = "Drupal\user\UserStorage",</span><br><span class="line"> *     "storage_schema" = "Drupal\user\UserStorageSchema",</span><br><span class="line"> *     "access" = "Drupal\user\UserAccessControlHandler",</span><br><span class="line"> *     "list_builder" = "Drupal\user\UserListBuilder",</span><br><span class="line"> *     "view_builder" = "Drupal\Core\Entity\EntityViewBuilder",</span><br><span class="line"> *     "views_data" = "Drupal\user\UserViewsData",</span><br><span class="line"> *     "route_provider" = &#123;</span><br><span class="line"> *       "html" = "Drupal\user\Entity\UserRouteProvider",</span><br><span class="line"> *     &#125;,</span><br><span class="line"> *     "form" = &#123;</span><br><span class="line"> *       "default" = "Drupal\user\ProfileForm",</span><br><span class="line"> *       "cancel" = "Drupal\user\Form\UserCancelForm",</span><br><span class="line"> *       "register" = "Drupal\user\RegisterForm"</span><br><span class="line"> *     &#125;,</span><br><span class="line"> *     "translation" = "Drupal\user\ProfileTranslationHandler"</span><br><span class="line"> *   &#125;,</span><br><span class="line"> *   admin_permission = "administer user",</span><br><span class="line"> *   base_table = "users",</span><br><span class="line"> *   data_table = "users_field_data",</span><br><span class="line"> *   label_callback = "user_format_name",</span><br><span class="line"> *   translatable = TRUE,</span><br><span class="line"> *   entity_keys = &#123;</span><br><span class="line"> *     "id" = "uid",</span><br><span class="line"> *     "langcode" = "langcode",</span><br><span class="line"> *     "uuid" = "uuid"</span><br><span class="line"> *   &#125;,</span><br><span class="line"> *   links = &#123;</span><br><span class="line"> *     "canonical" = "/user/&#123;user&#125;",</span><br><span class="line"> *     "edit-form" = "/user/&#123;user&#125;/edit",</span><br><span class="line"> *     "cancel-form" = "/user/&#123;user&#125;/cancel",</span><br><span class="line"> *     "collection" = "/admin/people",</span><br><span class="line"> *   &#125;,</span><br><span class="line"> *   field_ui_base_route = "entity.user.admin_form",</span><br><span class="line"> * )</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">ContentEntityBase</span> <span class="keyword">implements</span> <span class="title">UserInterface</span> </span>&#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>@ConfigEntityType继承自Drupal\Core\Config\Entity\ConfigEntityBase类。</p>
<p>参考文章：<br>1、<a href="https://www.drupal.org/node/1882526" target="_blank" rel="external">https://www.drupal.org/node/1882526</a><br>2、<a href="https://www.drupal.org/node/2207559" target="_blank" rel="external">https://www.drupal.org/node/2207559</a><br>3、<a href="https://www.drupal.org/node/1638040" target="_blank" rel="external">https://www.drupal.org/node/1638040</a><br>4、<a href="http://lakshminp-lakshminp.rhcloud.com/annotations-in-drupal-8/" target="_blank" rel="external">http://lakshminp-lakshminp.rhcloud.com/annotations-in-drupal-8/</a><br>5、<a href="https://docs.phalconphp.com/zh/latest/reference/annotations.html" target="_blank" rel="external">https://docs.phalconphp.com/zh/latest/reference/annotations.html</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/11/Drupal8命名空间-Namespace/" itemprop="url">
                  Drupal8命名空间(Namespace)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-11T16:05:20+08:00" content="2015-12-11">
              2015-12-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Drupal8/" itemprop="url" rel="index">
                    <span itemprop="name">Drupal8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/11/Drupal8命名空间-Namespace/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/11/Drupal8命名空间-Namespace/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>命名空间是php5.3引进的概念，这边文章主要介绍在Drupal中如何使用命名空间，如果你对命名空间还不熟悉，请移步到<a href="http://php.net/manual/zh/language.namespaces.php" title="PHP:命名空间" target="_blank" rel="external">这里</a>学习，这篇文章<a href="http://www.sitepoint.com/php-53-namespaces-basics/" title="php53:namespace" target="_blank" rel="external">article introducing namespaces</a>也讲的不错。</p>
<p>在Drupal中，并不是每一个文件都需要指定命名空间。Drupal8之前为了跟php5.2保持兼容，从未用过命名空间。Drupal8限定了php版本必须是5.5以上，So，让我们尽情的享受OOP的乐趣吧！</p>
<h3 id="用”use”导入类">用”use”导入类</h3><blockquote>
<p>在访问系统内部或包含在命名空间中的类名称时，可以不使用完全限定名称。命名空间和use关键字的声明必须放在文件的开头，并且以反斜杠\做为分隔符。如</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">mymodule</span>\<span class="title">Tests</span>\<span class="title">Foo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">simpletest</span>\<span class="title">WebTestBase</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Tests that the foo bars.</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BarTest</span> <span class="keyword">extends</span> <span class="title">WebTestBase</span> </span>&#123;</span><br><span class="line">	<span class="comment">// WebTestBase前不需要加\</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在访问系统内部或不包含在命名空间中的类名称时，必须使用完全限定名称。如</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> \<span class="keyword">Exception</span>();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在一个没有声明命名空间的文件里，就算它是全局命名空间，如果要使用其他非全局命名空间的类，必须使用”use”关键字，并且需要声明在文件的开头哦！</p>
<p>当用”use”导入类时，不要在开头加\。大PHP官方也是这么推荐的，见<a href="http://www.php.net/manual/en/language.namespaces.importing.php" target="_blank" rel="external">PHP documentation</a></p>
<p>当在字符串中指定类名时，必须使用带命名空间的全类名，并且不能以\开头。</p>
</blockquote>
<pre><code>如果要在双引号中使用命名空间，必须转义，如：
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Drupal\\Content\\ContentInterface"</span></span><br></pre></td></tr></table></figure>
<pre><code>在单引号中就不需要转义了，如：
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'Drupal\Context\ContextInterface'</span></span><br></pre></td></tr></table></figure>
<pre><code>通常情况下，推荐使用单引号的写法！
</code></pre><blockquote>
<p>一个”use”只能声明一个类，不建议使用”use”导入多个类.如这种写法就是不推荐的</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span>, <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</span><br></pre></td></tr></table></figure>
<pre><code>而这种写法是推荐的
</code></pre><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在.api.php这种API文件中必须使用类的全名，这样别人要想hook你的类，他们就可以”use”导入了。如</p>
</blockquote>
<p>定义Drupal\Subsystem\Foo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *<span class="phpdoc"> @file</span></span><br><span class="line"> * Contains \Drupal\Subsystem\Foo.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">Subsystem</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This imports just the Cat class from the Drupal\Othersystem namespace.</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Othersystem</span>\<span class="title">Cat</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bar is a class in the Drupal\Subsystem namespace in another file.</span></span><br><span class="line"><span class="comment">// It is already available without any importing.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Defines a Foo.</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Constructs a new Foo object.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bar <span class="variable">$b</span>, Cat <span class="variable">$c</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Global classes must be prefixed with a \ character.</span></span><br><span class="line">    <span class="variable">$d</span> = <span class="keyword">new</span> \DateTime();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>hook Drupal\Subsystem\Foo</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *<span class="phpdoc"> @file</span></span><br><span class="line"> * The Example module.</span><br><span class="line"> *</span><br><span class="line"> * This file is not part of any namespace, so all global namespaced classes</span><br><span class="line"> *  are automatically available.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Subsystem</span>\<span class="title">Foo</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Does stuff with Foo stuff.</span><br><span class="line"> *</span><br><span class="line"> *<span class="phpdoc"> @param</span> \Drupal\Subsystem\Foo $f</span><br><span class="line"> *   A Foo object used to bar the baz.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_stuff</span><span class="params">(Foo <span class="variable">$f</span>)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The DateTime class does not need to be imported as it is already global</span></span><br><span class="line">  <span class="variable">$d</span> = <span class="keyword">new</span> DateTime();</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="类的别名">类的别名</h3><p>php允许导入类的时候使用别名，这样可以避免可恶的重名！一旦两个类重名了，可以将各自命名空间里的上一级的名字拿出来作为相应的前缀。</p>
<p>如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Foo</span>\<span class="title">Bar</span>\<span class="title">Baz</span> <span class="title">as</span> <span class="title">BarBaz</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Stuff</span>\<span class="title">Thing</span>\<span class="title">Baz</span> <span class="title">as</span> <span class="title">ThingBaz</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Tests stuff for the whichever.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="variable">$a</span> = <span class="keyword">new</span> BarBaz(); <span class="comment">// This will be Foo\Bar\Baz</span></span><br><span class="line">  <span class="variable">$b</span> = <span class="keyword">new</span> ThingBaz(); <span class="comment">// This will be Stuff\Thing\Baz</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="导入的顺序">导入的顺序</h3><p>如果要导入多个类，Drupal8并没有限制导入的顺序。如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">block</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityForm</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Entity</span>\<span class="title">EntityManagerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormState</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Drupal</span>\<span class="title">Core</span>\<span class="title">Form</span>\<span class="title">FormStateInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">DependencyInjection</span>\<span class="title">ContainerInterface</span>;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="模块">模块</h3><p>模块中的类必须申明为特定的命名空间，如模块名为example_module。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span></span><br></pre></td></tr></table></figure>
<p>要在Drupal8中自动加载(autoload)，还要这些类归置到指定的文件夹下，一般约定在</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modules/example_module/src</span><br></pre></td></tr></table></figure>
<p>举个简单的例子，如：</p>
<blockquote>
<p>NO.1</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明命名空间</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span></span><br><span class="line"></span><br><span class="line">// 创建类</span><br><span class="line"><span class="title">class</span> <span class="title">Foo</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这个对应的文件就是example_module/src/Foo.php。</p>
<blockquote>
<p>NO.2<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明命名空间</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Drupal</span>\<span class="title">example_module</span>\<span class="title">Foo</span></span><br><span class="line"></span><br><span class="line">// 创建类</span><br><span class="line"><span class="title">class</span> <span class="title">Bar</span> &#123;&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>这个对应的文件就是example_module/src/Foo/Bar.php。</p>
<p>以上，就是对Drupal8的命名空间做简单的梳理和介绍。欢迎拍砖交流！</p>
<p>参考文章：<br>1、<a href="https://www.drupal.org/node/1353118" target="_blank" rel="external">https://www.drupal.org/node/1353118</a><br>2、<a href="https://www.drupal.org/node/2156625" target="_blank" rel="external">https://www.drupal.org/node/2156625</a></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="url">
                  高性能mysql主从架构及MHA高可用负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-28T14:35:42+08:00" content="2015-11-28">
              2015-11-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/28/高性能mysql主从架构及MHA高可用负载均衡/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>实验系统：CentOS 6.7_x86_64（4.2.3）</p>
<p>实验前提：防火墙和selinux都关闭</p>
<p>实验说明：本实验共有3台主机，拓扑图如下所示</p>
<p><img src="http://images.cnitblog.com/i/609710/201404/192216579327066.png" alt="拓扑图"></p>
<p>主机说明：<br>manager: 172.16.2.99<br>master: 172.16.115.101<br>备用master: 172.16.115.102<br>也可以加别的slave。</p>
<p>实验软件：</p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>mysql(mysql-5.5.46-1.el6.remi.x86_64)</p>
<h3 id="1、安装软件">1、安装软件</h3><p>三台机器都需要安装mha4mysql-node, master和slave还需要安装mysql, manager可以不装mysql. 当然manager也可以用slave机器来做。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql mysql-server epel-release -y</span><br><span class="line"></span><br><span class="line">rpm -Uvh mha4mysql-node-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>manager还需要安装mha4mysql-manager.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mha4mysql-manager-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm -y</span><br></pre></td></tr></table></figure>
<p>用localinstall会自动安装依赖。</p>
<h3 id="2、mysql主从配置">2、mysql主从配置</h3><h4 id="master上编辑/etc/my-cnf，添加配置">master上编辑/etc/my.cnf，添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master config</span></span><br><span class="line">server-id = <span class="number">1</span></span><br><span class="line"><span class="built_in">log</span>_bin = mysql-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates</span><br><span class="line">binlog_<span class="keyword">do</span>_db = drupal</span><br></pre></td></tr></table></figure>
<h4 id="slave上编辑/etc/my-cnf,添加配置">slave上编辑/etc/my.cnf,添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave config</span></span><br><span class="line">server-id = <span class="number">2</span></span><br><span class="line"><span class="built_in">log</span>_bin = mysql-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates</span><br><span class="line">binlog_<span class="keyword">do</span>_db = drupal</span><br></pre></td></tr></table></figure>
<h4 id="创建具有复制权限的用户">创建具有复制权限的用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">'replicate'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h4 id="设置slave">设置slave</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=<span class="number">3306</span>,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_<span class="built_in">log</span>_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>
<h4 id="查看master/slave配置">查看master/slave配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.<span class="number">000001</span> |      <span class="number">867</span> | drupal       |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"></span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: <span class="number">172.16</span>.<span class="number">115.101</span></span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">867</span></span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.<span class="number">000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">1013</span></span><br><span class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: drupal</span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">867</span></span><br><span class="line">              Relay_Log_Space: <span class="number">1170</span></span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: <span class="number">1</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>如果Slave_IO_Running和Slave_SQL_Running都是YES，说明slave服务器配置OK。</p>
<h3 id="3、MHA作用">3、MHA作用</h3><p>1）从宕机崩溃的master保存二进制日志事件（binlog events）;</p>
<p>2）识别含有最新更新的slave；</p>
<p>3）应用差异的中继日志（relay log）到其他的slave；</p>
<p>4）应用从master保存的二进制日志事件（binlog events）；</p>
<p>5）提升一个slave为新的master；</p>
<p>6）使其他的slave连接新的master进行复制；</p>
<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh              检查MHA的SSH配置状况</span><br><span class="line">masterha_check_repl             检查MySQL复制状况</span><br><span class="line">masterha_manger                 启动MHA</span><br><span class="line">masterha_check_status           检测当前MHA运行状态</span><br><span class="line">masterha_master_monitor         检测master是否宕机</span><br><span class="line">masterha_master_switch          控制故障转移（自动或者手动）</span><br><span class="line">masterha_conf_host              添加或删除配置的server信息</span><br></pre></td></tr></table></figure>
<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs                保存和复制master的二进制日志</span><br><span class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span><br><span class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure>
<h3 id="4、配置MHA">4、配置MHA</h3><h4 id="创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）">创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># vim /etc/masterha/app1.cnf </span></span><br><span class="line"></span><br><span class="line">[server default]</span><br><span class="line">manager_<span class="built_in">log</span>=/var/<span class="built_in">log</span>/mha/app1/manager.log //设置manager的日志</span><br><span class="line">manager_workdir=/var/<span class="built_in">log</span>/mha/app1.log //设置manager的工作目录</span><br><span class="line">master_binlog_dir=/var/lib/mysql //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span><br><span class="line"></span><br><span class="line">user=repl  //设置监控用户root</span><br><span class="line">password=<span class="number">123456</span> //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</span><br><span class="line">ssh_user=root //设置ssh的登录用户名</span><br><span class="line">repl_user=repl //设置复制环境中的复制用户名</span><br><span class="line">repl_password=<span class="number">123456</span> //设置复制用户的密码</span><br><span class="line">ping_interval=<span class="number">10</span> //设置监控主库，发送ping包的时间间隔，默认是<span class="number">3</span>秒，尝试三次没有回应的时候自动进行railover</span><br><span class="line"></span><br><span class="line">shutdown_script=<span class="string">""</span> //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span><br><span class="line">master_ip_online_change_script=<span class="string">""</span> //设置手动切换时候的切换脚本</span><br><span class="line">report_script=<span class="string">"/usr/bin/masterha_report_script"</span> //设置发生切换后发送的报警的脚本</span><br><span class="line">master_ip_failover_script=<span class="string">"/usr/bin/masterha_ip_failover"</span> //设置自动failover时候的切换脚本</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=<span class="number">172.16</span>.<span class="number">115.101</span></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=<span class="number">172.16</span>.<span class="number">115.102</span></span><br><span class="line">candidate_master=<span class="number">1</span> //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中时间最新的slave</span><br><span class="line">check_repl_delay=<span class="number">0</span>   //默认情况下如果一个slave落后master <span class="number">100</span>M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=<span class="number">0</span>,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=<span class="number">1</span>的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span><br></pre></td></tr></table></figure>
<h4 id="设置relay_log的清除方式（在每个slave节点上）：">设置relay log的清除方式（在每个slave节点上）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># mysql -e 'set global relay_log_purge=0'</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</p>
<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--user mysql                      用户名</span><br><span class="line">--password mysql                  密码</span><br><span class="line">--port                            端口号</span><br><span class="line">--workdir                         指定创建relay <span class="built_in">log</span>的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</span><br><span class="line">--disable_relay_<span class="built_in">log</span>_purge         默认情况下，如果relay_<span class="built_in">log</span>_purge=<span class="number">1</span>，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_<span class="built_in">log</span>_purge=<span class="number">1</span>的情况下会将relay_<span class="built_in">log</span>_purge设置为<span class="number">0</span>。清理relay <span class="built_in">log</span>之后，最后将参数设置为OFF。</span><br></pre></td></tr></table></figure>
<h4 id="设置定期清理relay脚本（两台slave服务器）">设置定期清理relay脚本（两台slave服务器）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># cat purge_relay_log.sh </span></span><br><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">user=root</span><br><span class="line">passwd=<span class="number">123456</span></span><br><span class="line">port=<span class="number">3306</span></span><br><span class="line"><span class="built_in">log</span>_dir=<span class="string">'/var/log/masterha'</span></span><br><span class="line">work_dir=<span class="string">'/var/lib/mysql'</span></span><br><span class="line">purge=<span class="string">'/usr/local/bin/purge_relay_logs'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="operator">-d</span> <span class="variable">$log_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir <span class="variable">$log_dir</span> -p</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$purge</span> --user=<span class="variable">$user</span> --password=<span class="variable">$passwd</span> --disable_relay_<span class="built_in">log</span>_purge --port=<span class="variable">$port</span> --workdir=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>添加到crontab定期执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># crontab -l</span></span><br><span class="line"><span class="number">0</span> <span class="number">4</span> * * * /bin/bash /root/purge_relay_log.sh</span><br></pre></td></tr></table></figure></p>
<h4 id="purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。">purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">115.102</span> ~]<span class="comment"># purge_relay_logs --user=root --password=123456 --port=3306 -disable_relay_log_purge --workdir=/data/</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">04</span>-<span class="number">20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">24</span>: purge_relay_logs script started.</span><br><span class="line"> Found relay_log.info: /data/mysql/relay-log.info</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</span><br><span class="line"> Current relay <span class="built_in">log</span> file: /data/mysql/server03-relay-bin.<span class="number">000002</span></span><br><span class="line"> Archiving unused relay <span class="built_in">log</span> files (up to /data/mysql/server03-relay-bin.<span class="number">000001</span>) ...</span><br><span class="line"> Creating hard link <span class="keyword">for</span> /data/mysql/server03-relay-bin.<span class="number">000001</span> under /data//server03-relay-bin.<span class="number">000001</span> .. ok.</span><br><span class="line"> Creating hard links <span class="keyword">for</span> unused relay <span class="built_in">log</span> files completed.</span><br><span class="line"> Executing SET GLOBAL relay_<span class="built_in">log</span>_purge=<span class="number">1</span>; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay <span class="built_in">log</span> files (<span class="keyword">if</span> it keeps up); SET GLOBAL relay_<span class="built_in">log</span>_purge=<span class="number">0</span>; .. ok.</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. done.</span><br><span class="line"><span class="number">2014</span>-<span class="number">04</span>-<span class="number">20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">27</span>: All relay <span class="built_in">log</span> purging operations succeeded.</span><br></pre></td></tr></table></figure>
<h3 id="5、SSH配置">5、SSH配置</h3><p>要想MHA顺利执行各项任务，还得打通每台机器的SSH。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># ssh-keygen -t rsa</span></span><br><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># ssh-copy-id -i .ssh/id_rsa.pub root@172.16.115.101</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>记住，每台机器都要跟别的机器打通SSH。</p>
<p>检查MHA Manger到所有MHA Node的SSH连接状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>
<p>可以看见各个节点ssh验证都是ok的。</p>
<h3 id="6、检查整个复制环境状况">6、检查整个复制环境状况</h3><p>通过masterha_check_repl脚本查看整个集群的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [debug] </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]  Connecting via SSH from root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>) to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">39</span> <span class="number">2015</span> - [debug]   ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">40</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@utn-cz-<span class="number">1</span>-<span class="number">1</span><span class="operator">-s</span>16h2 app1.log]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Dead Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Alive Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Alive Slaves:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)  Version=<span class="number">5.5</span>.<span class="number">46</span>-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]     Replicating from <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Current Alive Master: <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  <span class="built_in">read</span>_only=<span class="number">1</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [warning]  relay_<span class="built_in">log</span>_purge=<span class="number">0</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  binlog_<span class="keyword">do</span>_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]  Version check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] HealthCheck: SSH to <span class="number">172.16</span>.<span class="number">115.101</span> is reachable.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Master MHA Node version is <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info] Checking recovery script configurations on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=<span class="number">4</span> --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_<span class="built_in">test</span> --manager_version=<span class="number">0.56</span> --start_file=mysql-bin.<span class="number">000021</span> </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.<span class="number">000021</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Binlog setting check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_ip=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.5</span>.<span class="number">46</span>-log --manager_version=<span class="number">0.56</span> --relay_<span class="built_in">log</span>_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Testing mysql connection and privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Slaves settings check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] </span><br><span class="line"><span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking replication health on <span class="number">172.16</span>.<span class="number">115.102</span>..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]  ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_ip=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:<span class="number">0</span> down==/sbin/ifconfig eth0:<span class="number">0</span> <span class="number">172.16</span>.<span class="number">115.200</span>/<span class="number">24</span>===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info]  OK.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">43</span>:<span class="number">52</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">0</span> (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>
<h3 id="7、检查MHA_Manager的状态">7、检查MHA Manager的状态</h3><p>通过master_check_status脚本查看Manager的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 is stopped(<span class="number">2</span>:NOT_RUNNING).</span><br></pre></td></tr></table></figure>
<p>注意：如果正常，会显示”PING_OK”，否则会显示”NOT_RUNNING”，这代表MHA监控没有开启。</p>
<h3 id="8、开启MHA_Manager监控">8、开启MHA Manager监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failover &gt; /var/log/mha/app1/manager.log &lt; /dev/null 2&gt;&amp;1 &amp;</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">7303</span></span><br></pre></td></tr></table></figure>
<p>启动参数介绍：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--remove_dead_master_conf      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span><br><span class="line">--manger_<span class="built_in">log</span>                            日志存放位置</span><br><span class="line">--ignore_last_failover                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足<span class="number">8</span>小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</span><br></pre></td></tr></table></figure>
<p>查看MHA Manager监控是否正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">20386</span>) is running(<span class="number">0</span>:PING_OK), master:<span class="number">172.16</span>.<span class="number">115.101</span></span><br></pre></td></tr></table></figure>
<p>可以看见已经在监控了，而且master的主机为172.16.115.101</p>
<h3 id="9、查看启动日志">9、查看启动日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment">#  cat /var/log/mha/app1/manager.log</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">37</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Dead Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Alive Servers:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Alive Slaves:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]   <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)  Version=<span class="number">5.5</span>.<span class="number">46</span>-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]     Replicating from <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Current Alive Master: <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  <span class="built_in">read</span>_only=<span class="number">1</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [warning]  relay_<span class="built_in">log</span>_purge=<span class="number">0</span> is not <span class="built_in">set</span> on slave <span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>).</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  binlog_<span class="keyword">do</span>_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">38</span> <span class="number">2015</span> - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]  Version check ok.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] HealthCheck: SSH to <span class="number">172.16</span>.<span class="number">115.101</span> is reachable.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Master MHA Node version is <span class="number">0.56</span>.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking recovery script configurations on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span>: save_binary_logs --command=<span class="built_in">test</span> --start_pos=<span class="number">4</span> --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_<span class="built_in">test</span> --manager_version=<span class="number">0.56</span> --start_file=mysql-bin.<span class="number">000021</span> </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.<span class="number">000021</span></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Binlog setting check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span> --slave_user=<span class="string">'repl'</span> --slave_host=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_ip=<span class="number">172.16</span>.<span class="number">115.102</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.5</span>.<span class="number">46</span>-log --manager_version=<span class="number">0.56</span> --relay_<span class="built_in">log</span>_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">39</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.<span class="number">000022</span></span><br><span class="line">    Testing mysql connection and privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Slaves settings check done.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] </span><br><span class="line"><span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">172.16</span>.<span class="number">115.102</span>(<span class="number">172.16</span>.<span class="number">115.102</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info]   /usr/bin/masterha_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_ip=<span class="number">172.16</span>.<span class="number">115.101</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:<span class="number">0</span> down==/sbin/ifconfig eth0:<span class="number">0</span> <span class="number">172.16</span>.<span class="number">115.200</span>/<span class="number">24</span>===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info]  OK.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Set master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Starting ping health check on <span class="number">172.16</span>.<span class="number">115.101</span>(<span class="number">172.16</span>.<span class="number">115.101</span>:<span class="number">3306</span>)..</span><br><span class="line">Wed Dec  <span class="number">2</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">40</span> <span class="number">2015</span> - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br></pre></td></tr></table></figure>
<h3 id="10、配置VIP">10、配置VIP</h3><p>我们采用脚本的方式去配置vip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> ~]<span class="comment">#  vim /usr/bin/masterha_ip_failover</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    <span class="variable">$command</span>,          <span class="variable">$ssh_user</span>,        <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">'172.16.115.200/24'</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">'0'</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> <span class="variable">$vip</span>"</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">"/sbin/ifconfig eth0:<span class="variable">$key</span> down"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \<span class="variable">$command</span>,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">"\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="variable">$@</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="built_in">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="built_in">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \<span class="string">" <span class="variable">$ssh_start_vip</span> \"`;</span><br><span class="line">&#125;</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     return 0  unless  (<span class="variable">$ssh_user</span>);</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \" <span class="variable">$ssh_stop_vip</span> \"`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    "</span>Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip </span><br><span class="line">            --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n<span class="string">";</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="11、邮件发送脚本send_report">11、邮件发送脚本send_report</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( <span class="variable">$dead_master_host</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_slave_hosts</span>, <span class="variable">$subject</span>, <span class="variable">$body</span> );</span><br><span class="line">my <span class="variable">$smtp</span>=<span class="string">'smtp.163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_from</span>=<span class="string">'services@163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_user</span>=<span class="string">'services@163.com'</span>;</span><br><span class="line">my <span class="variable">$mail_pass</span>=<span class="string">'123456'</span>;</span><br><span class="line">my <span class="variable">$mail_to</span>=[<span class="string">'xxx@xxx.cn'</span>];</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$dead_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \<span class="variable">$new_slave_hosts</span>,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \<span class="variable">$subject</span>,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \<span class="variable">$body</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mailToContacts(<span class="variable">$smtp</span>,<span class="variable">$mail_from</span>,<span class="variable">$mail_user</span>,<span class="variable">$mail_pass</span>,<span class="variable">$mail_to</span>,<span class="variable">$subject</span>,<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( <span class="variable">$smtp</span>, <span class="variable">$mail_from</span>, <span class="variable">$user</span>, <span class="variable">$passwd</span>, <span class="variable">$mail_to</span>, <span class="variable">$subject</span>, <span class="variable">$msg</span> ) = @_;</span><br><span class="line">    open my <span class="variable">$DEBUG</span>, <span class="string">"&gt; /tmp/monitormail.log"</span></span><br><span class="line">        or die <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my <span class="variable">$sender</span> = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; <span class="variable">$smtp</span>,</span><br><span class="line">        from        =&gt; <span class="variable">$mail_from</span>,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; <span class="variable">$user</span>,</span><br><span class="line">        authpwd     =&gt; <span class="variable">$passwd</span>,</span><br><span class="line">        to          =&gt; <span class="variable">$mail_to</span>,</span><br><span class="line">        subject     =&gt; <span class="variable">$subject</span>,</span><br><span class="line">        debug       =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sender</span>-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; <span class="variable">$msg</span>,</span><br><span class="line">            debug =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">        &#125;</span><br><span class="line">    ) or <span class="built_in">print</span> <span class="variable">$Mail</span>::Sender::Error;</span><br><span class="line">    <span class="built_in">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h3 id="12、测试">12、测试</h3><p>1.主库断电<br>2.主库断网<br>3.主库重启<br>4.主库关机<br>以上情况都测试过都能自动切换~<br>请看日志分析切换过程  </p>
<h3 id="13、主库模拟故障后的恢复">13、主库模拟故障后的恢复</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">172.16</span>.<span class="number">2.99</span> app1]<span class="comment"># grep -i "All other slaves should start" manager.log </span></span><br><span class="line">Mon Apr <span class="number">21</span> <span class="number">22</span>:<span class="number">28</span>:<span class="number">33</span> <span class="number">2014</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'172.16.115.102'</span>, MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000022'</span>, MASTER_LOG_POS=<span class="number">506716</span>, MASTER_USER=<span class="string">'repl'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</span><br><span class="line">[root@<span class="number">192.168</span>.<span class="number">0.20</span> app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>然后再就得主库里执行下,再start slave ,然后就得主库就变为了新的主库的从库了。<br>记得看下show slave status\G;  </p>
<h3 id="14、报错记录总结">14、报错记录总结</h3><p>摘抄自google.</p>
<h4 id="报错记录1：">报错记录1：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 ~]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">06</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln303]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on192.<span class="number">168.52</span>.<span class="number">130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)!</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pmline <span class="number">315</span></span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Tue Apr <span class="number">7</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">07</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：在192.168.52.130上面，vim /etc/my.cnf，在里面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relay-log=/home/data/mysql/binlog/mysql-relay-bin</span><br></pre></td></tr></table></figure>
<p>然后重启mysql，再去重新设置slave连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;</span><br><span class="line">RESET SLAVE;</span><br><span class="line">CHANGE MASTER TOMASTER_HOST=<span class="string">'192.168.52.129'</span>,MASTER_USER=<span class="string">'repl'</span>,MASTER_PASSWORD=<span class="string">'repl_1234'</span>,MASTER_LOG_FILE=<span class="string">'mysql-bin.000178'</span>,MASTER_LOG_POS=<span class="number">459</span>;</span><br><span class="line">START SLAVE;</span><br></pre></td></tr></table></figure>
<p>Ok，搞定了。</p>
<h4 id="报错记录2：">报错记录2：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 perl]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln306]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)!</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm line <span class="number">315</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 perl]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决方法：<br>/etc/masterha/app1.cnf文件里面的参数配置，user和repl_user都是mysql账号，需要创建好，这里是只创建了repl_user而没有创建好user账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user=manager</span><br><span class="line">password=manager_1234</span><br><span class="line">repl_user=repl</span><br><span class="line">repl_password=repl_1234</span><br></pre></td></tr></table></figure>
<p>在mysql节点上，建立允许manager 访问数据库的“ manager manager ”账户，主要用于SHOW SLAVESTATUS,RESET SLAVE; 所以需要执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT SUPER,RELOAD,REPLICATIONCLIENT,SELECT ON *.* TO manager@<span class="string">'192.168.52.%'</span> IDENTIFIED BY <span class="string">'manager_1234'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="错误记录3：">错误记录3：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@oraclem1 ~]<span class="comment">#  masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm,ln781] Multi-master configuration is detected, but two or more masters areeither writable (<span class="built_in">read</span>-only is not <span class="built_in">set</span>) or dead! Check configurations fordetails. Master configurations are as below:</span><br><span class="line">Master <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>),replicating from <span class="number">192.168</span>.<span class="number">52.129</span>(<span class="number">192.168</span>.<span class="number">52.129</span>:<span class="number">3306</span>)</span><br><span class="line">Master <span class="number">192.168</span>.<span class="number">52.129</span>(<span class="number">192.168</span>.<span class="number">52.129</span>:<span class="number">3306</span>),replicating from <span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">3306</span>)</span><br><span class="line"> </span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm line <span class="number">326</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">05</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@oraclem1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global <span class="built_in">read</span>_only=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h4 id="报错记录4：">报错记录4：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info] Checking SSH publickey authentication andchecking recovery script configurations on all alive slave servers..</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info]  Executing <span class="built_in">command</span> : apply_diff_relay_logs --command=<span class="built_in">test</span>--slave_user=<span class="string">'manager'</span> --slave_host=<span class="number">192.168</span>.<span class="number">52.130</span> --slave_ip=<span class="number">192.168</span>.<span class="number">52.130</span>--slave_port=<span class="number">3306</span> --workdir=/var/tmp --target_version=<span class="number">5.6</span>.<span class="number">12</span>-log--manager_version=<span class="number">0.56</span> --relay_dir=/home/data/mysql/data--current_relay_<span class="built_in">log</span>=mysqld-relay-bin.<span class="number">000011</span> --slave_pass=xxx</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">32</span> <span class="number">2015</span> - [info]  Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line">Can<span class="string">'t exec "mysqlbinlog": No suchfile or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 106.</span><br><span class="line">mysqlbinlog version command failed with rc1:0, please verify PATH, LD_LIBRARY_PATH, and client options</span><br><span class="line"> at/usr/local/bin/apply_diff_relay_logs line 493</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line 48</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [info] Got exit code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@oraclem1 ~]#</span></span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@data02 ~]<span class="comment"># type mysqlbinlog</span></span><br><span class="line">mysqlbinlog is/usr/<span class="built_in">local</span>/mysql/bin/mysqlbinlog</span><br><span class="line">[root@data02 ~]<span class="comment">#</span></span><br><span class="line">[root@data02 ~]<span class="comment"># ln -s/usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span></span><br></pre></td></tr></table></figure>
<h4 id="报错记录5：">报错记录5：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [info]  Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is /home/data/mysql/data/mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Testing mysql connection and privileges..sh: mysql: <span class="built_in">command</span> not found</span><br><span class="line">mysql <span class="built_in">command</span> failed with rc <span class="number">127</span>:<span class="number">0</span>!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">375</span></span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">497</span></span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">475</span></span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">120</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/bin/masterha_check_repl line <span class="number">48</span></span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">24</span> <span class="number">2015</span> - [info] Got <span class="built_in">exit</span> code <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln <span class="operator">-s</span> /usr/<span class="built_in">local</span>/mysql/bin/mysql/usr/bin/mysql</span><br></pre></td></tr></table></figure>
<h4 id="报错记录6：">报错记录6：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">36</span> <span class="number">2015</span> - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs--command=<span class="built_in">test</span> --slave_user=<span class="string">'manager'</span> --slave_host=<span class="number">192.168</span>.<span class="number">52.130</span>--slave_ip=<span class="number">192.168</span>.<span class="number">52.130</span> --slave_port=<span class="number">3306</span> --workdir=/var/tmp--target_version=<span class="number">5.6</span>.<span class="number">12</span>-log --manager_version=<span class="number">0.56</span>--relay_dir=/home/data/mysql/data--current_relay_<span class="built_in">log</span>=mysqld-relay-bin.<span class="number">000011</span> --slave_pass=xxx</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">36</span> <span class="number">2015</span> - [info]   Connecting to root@<span class="number">192.168</span>.<span class="number">52.130</span>(<span class="number">192.168</span>.<span class="number">52.130</span>:<span class="number">22</span>)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is/home/data/mysql/data/mysqld-relay-bin.<span class="number">000013</span></span><br><span class="line">   Testing mysql connection and privileges..Warning: Using a password onthe <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1142</span> (<span class="number">42000</span>) at line <span class="number">1</span>: CREATE<span class="built_in">command</span> denied to user <span class="string">'manager'</span>@<span class="string">'192.168.52.130'</span> <span class="keyword">for</span> table<span class="string">'apply_diff_relay_logs_test'</span></span><br><span class="line">mysql <span class="built_in">command</span> failed with rc <span class="number">1</span>:<span class="number">0</span>!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">375</span></span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">497</span></span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">475</span></span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line <span class="number">120</span></span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln205] Slaves settingscheck failed!</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln413] Slave configurationfailed.</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln424] Error happened onchecking configurations.  at/usr/<span class="built_in">local</span>/bin/masterha_check_repl line <span class="number">48</span></span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln523] Error happened onmonitoring servers.</span><br><span class="line">Fri Apr <span class="number">10</span> <span class="number">00</span>:<span class="number">58</span>:<span class="number">37</span> <span class="number">2015</span> - [info] Got exitcode <span class="number">1</span> (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>
<p>解决办法：<br>执行如下授权语句sql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT CREATE,INSERT,UPDATE,DELETE,DROP ON*.* TO manager@<span class="string">'192.168.52.%'</span>;</span><br></pre></td></tr></table></figure>
<h4 id="其他">其他</h4><p>另外，如果nohup masterha_manager执行不了，请检查master和slave是否配置正确。可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=<span class="string">'172.16.115.101'</span>,master_port=<span class="number">3306</span>,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'123456'</span>,master_<span class="built_in">log</span>_file=<span class="string">'mysql-bin.000001'</span>,MASTER_LOG_POS=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>重新设置slave。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/27/使用gdb调试php-fpm/" itemprop="url">
                  使用gdb调试php-fpm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-27T16:17:10+08:00" content="2015-11-27">
              2015-11-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/27/使用gdb调试php-fpm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/27/使用gdb调试php-fpm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>有很多php开发人员经常问我，如果执行php代码的时候出现严重错误的时候，如何快速定位问题。我一般推荐他们用gdb去调试。</p>
<p>下面用php-fpm的一个段错误来举例说明，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: [pool www] child <span class="number">15109</span> exited on signal <span class="number">11</span> (SIGSEGV) after <span class="number">654.485221</span> seconds from start</span><br></pre></td></tr></table></figure>
<h3 id="1、安装gdb">1、安装gdb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gdb php-dbg</span><br></pre></td></tr></table></figure>
<p>有的时候可能需要安装debuginfo相关的库，如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debuginfo-install php-fpm</span><br></pre></td></tr></table></figure>
<h3 id="2、设置coredump">2、设置coredump</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/tmp/core-%e.%p'</span> &gt; /proc/sys/kernel/core_pattern</span><br><span class="line"><span class="built_in">echo</span> <span class="number">0</span> &gt; /proc/sys/kernel/core_uses_pid</span><br><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br></pre></td></tr></table></figure>
<p>当然,coredump的文件格式可以设置为其他的，这里是详细的设置项说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">%%  a single % character</span><br><span class="line">%c  core file size soft resource <span class="built_in">limit</span> of crashing process (since</span><br><span class="line">    Linux <span class="number">2.6</span>.<span class="number">24</span>)</span><br><span class="line">%d  dump mode—same as value returned by prctl(<span class="number">2</span>) PR_GET_DUMPABLE</span><br><span class="line">    (since Linux <span class="number">3.7</span>)</span><br><span class="line">%e  executable filename (without path prefix)</span><br><span class="line">%E  pathname of executable, with slashes (<span class="string">'/'</span>) replaced by</span><br><span class="line">    exclamation marks (<span class="string">'!'</span>) (since Linux <span class="number">3.0</span>).</span><br><span class="line">%g  (numeric) real GID of dumped process</span><br><span class="line">%h  hostname (same as nodename returned by uname(<span class="number">2</span>))</span><br><span class="line">%p  PID of dumped process, as seen <span class="keyword">in</span> the PID namespace <span class="keyword">in</span> <span class="built_in">which</span></span><br><span class="line">    the process resides</span><br><span class="line">%P  PID of dumped process, as seen <span class="keyword">in</span> the initial PID namespace</span><br><span class="line">    (since Linux <span class="number">3.12</span>)</span><br><span class="line">%s  number of signal causing dump</span><br><span class="line">%t  time of dump, expressed as seconds since the Epoch,</span><br><span class="line">    <span class="number">1970</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> +<span class="number">0000</span> (UTC)</span><br><span class="line">%u  (numeric) real UID of dumped process</span><br></pre></td></tr></table></figure>
<h3 id="3、设置php-fpm">3、设置php-fpm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>
<p>找到关键字 rlimit_core，并修改为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rlimit_core = unlimited</span><br></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/php-fpm --daemonize</span><br></pre></td></tr></table></figure>
<p>这时就会在/tmp下看到有coredump文件生成了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]<span class="comment"># ls</span></span><br><span class="line">core-php-fpm.<span class="number">7279</span></span><br></pre></td></tr></table></figure>
<h3 id="4、追踪">4、追踪</h3><p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb /usr/sbin/php-fpm /tmp/core-php-fpm.<span class="number">7279</span></span><br></pre></td></tr></table></figure>
<p>执行bt命令就可以查看详细的错误日志了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  _zend_hash_init (ht=0x2b4d1a4f8100, nSize=174762, pDestructor=0, persistent=1 '\001') at /usr/src/debug/php-7.0.0RC8/Zend/zend_hash.c:172</span></span><br><span class="line"><span class="comment">#1  0x00002b4d0d0e87ac in zend_accel_init_shm (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2387</span></span><br><span class="line"><span class="comment">#2  accel_startup (extension=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/ext/opcache/ZendAccelerator.c:2640</span></span><br><span class="line"><span class="comment">#3  0x00000000005e8d21 in zend_extension_startup (extension=0x168c810) at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:176</span></span><br><span class="line"><span class="comment">#4  0x00000000005d2293 in zend_llist_apply_with_del (l=0x9dd420, func=0x5e8d10 &lt;zend_extension_startup&gt;) at /usr/src/debug/php-7.0.0RC8/Zend/zend_llist.c:171</span></span><br><span class="line"><span class="comment">#5  0x00000000005e8d07 in zend_startup_extensions () at /usr/src/debug/php-7.0.0RC8/Zend/zend_extensions.c:197</span></span><br><span class="line"><span class="comment">#6  0x0000000000580985 in php_module_startup (sf=&lt;value optimized out&gt;, additional_modules=&lt;value optimized out&gt;, num_additional_modules=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/main/main.c:2197</span></span><br><span class="line"><span class="comment">#7  0x000000000067aec5 in php_cgi_startup (sapi_module=&lt;value optimized out&gt;) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:837</span></span><br><span class="line"><span class="comment">#8  0x000000000067bcfe in main (argc=2, argv=0x7fff1a037498) at /usr/src/debug/php-7.0.0RC8/sapi/fpm/fpm/fpm_main.c:1788</span></span><br></pre></td></tr></table></figure>
<p>至此，整个追踪过程结束。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="url">
                  centos6.6安装Percona Tokudb
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-21T20:17:57+08:00" content="2015-11-21">
              2015-11-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/11/21/centos6-6安装Percona-Tokudb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/21/centos6-6安装Percona-Tokudb/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>在percona官网<a href="https://www.percona.com/" target="_blank" rel="external">https://www.percona.com/</a><br>下载带有Tokudb的二进制包，也可以选择源码编译。tokudb有单独的包.<br>我这里下载的是最新的包，5.6.25-73<br>Percona-Server-5.6.25-rel73.1-Linux.x86_64.ssl101.tar.gz<br>Percona-Server-5.6.25-rel73.1-TokuDB.Linux.x86_64.ssl101.tar.gz</p>
<h3 id="前期账号创建">前期账号创建</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; groupadd mysql</span><br><span class="line">shell&gt; useradd -g mysql mysql</span><br></pre></td></tr></table></figure>
<h3 id="解压软件包">解压软件包</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; cd /usr/local</span><br><span class="line">shell&gt; tar -zxvf Percona-Server-<span class="number">5.6</span>.25-rel73.1-Linux.x86_64.ssl101.tar.gz</span><br><span class="line">shell&gt; tar -zxvf Percona-Server-<span class="number">5.6</span>.25-rel73.1-TokuDB.Linux.x86_64.ssl101.tar.gz</span><br><span class="line">shell&gt; ln -s Percona-Server-<span class="number">5.6</span>.25-rel73.1-Linux.x86_64.ssl101 mysql</span><br></pre></td></tr></table></figure>
<h3 id="设置权限">设置权限</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; cd mysql</span><br><span class="line">shell&gt; chown -R mysql .</span><br><span class="line">shell&gt; chgrp -R mysql .</span><br></pre></td></tr></table></figure>
<h3 id="创建配置文件/etc/my-cnf">创建配置文件/etc/my.cnf</h3><p>创建存放数据源的目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; mkdir -p /<span class="keyword">var</span>/lib/mysql</span><br><span class="line">Shell&gt; mkdir -p /data/mysqldata /data/mysqllog</span><br><span class="line">Shell&gt; chown -R mysql:mysql /<span class="keyword">var</span>/lib/mysql /data/mysqldata /data/mysqllog</span><br></pre></td></tr></table></figure>
<p>在附件中给出，请参考附配置文件内容</p>
<h3 id="初始化DB">初始化DB</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Shell&gt; scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf</span><br><span class="line">shell&gt; chown -R root .</span><br></pre></td></tr></table></figure>
<h3 id="修改系统参数">修改系统参数</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/defrag</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/redhat_transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="keyword">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>
<p>建议写到 /etc/rc.local 中，重启后也可生效</p>
<h3 id="启动数据库">启动数据库</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; bin/mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure>
<h3 id="把启动文件放去自启动中">把启动文件放去自启动中</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chkconfig --add mysqld</span><br><span class="line">service mysqld start</span><br><span class="line">service mysqld stop</span><br></pre></td></tr></table></figure>
<p>然后启动。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| InnoDB             | <span class="keyword">DEFAULT</span> | Percona-XtraDB, Supports transactions, row-level locking, <span class="keyword">and</span> foreign keys | YES          | YES  | YES        |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/<span class="keyword">null</span> storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</span><br><span class="line">| MEMORY             | YES     | Hash based, stored in memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</span><br><span class="line">| TokuDB             | YES     | Tokutek TokuDB Storage Engine with Fractal Tree(tm) Technology             | YES          | YES  | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | NO      | Federated MySQL storage engine                                             | <span class="keyword">NULL</span>         | <span class="keyword">NULL</span> | <span class="keyword">NULL</span>       |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line"><span class="number">10</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>看到上面一行红字就代表数据库支持TokuDB的存储引擎了。</p>
<p>tokudb安装顺利完成，后附配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=<span class="number">0</span></span><br><span class="line"><span class="comment">#public</span></span><br><span class="line">max_connections=<span class="number">3000</span></span><br><span class="line">max_connect_errors=<span class="number">6000</span></span><br><span class="line">key_buffer_size = <span class="number">384</span>M</span><br><span class="line">low_priority_updates = <span class="number">1</span></span><br><span class="line">back_<span class="built_in">log</span> = <span class="number">1500</span></span><br><span class="line">query_cache_<span class="built_in">type</span> = <span class="number">1</span></span><br><span class="line">query_cache_size = <span class="number">64</span>M</span><br><span class="line">query_cache_<span class="built_in">limit</span> = <span class="number">4</span>M</span><br><span class="line">query_cache_min_res_unit = <span class="number">2</span>k</span><br><span class="line">tmp_table_size = <span class="number">256</span>M</span><br><span class="line"><span class="built_in">read</span>_buffer_size=<span class="number">1</span>M</span><br><span class="line"><span class="built_in">read</span>_rnd_buffer_size = <span class="number">16</span>M</span><br><span class="line">bulk_insert_buffer_size = <span class="number">64</span>M</span><br><span class="line">max_allowed_packet = <span class="number">64</span>M</span><br><span class="line">thread_cache_size = <span class="number">300</span></span><br><span class="line"><span class="comment">#file</span></span><br><span class="line">innodb_file_per_table</span><br><span class="line"><span class="comment">#buffer</span></span><br><span class="line">innodb_buffer_pool_size = <span class="number">2500</span>M</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size = <span class="number">64</span>M</span><br><span class="line">join_buffer_size = <span class="number">16</span>M</span><br><span class="line">sort_buffer_size = <span class="number">16</span>M</span><br><span class="line">innodb_max_dirty_pages_pct = <span class="number">90</span></span><br><span class="line">innodb_lock_<span class="built_in">wait</span>_timeout = <span class="number">120</span></span><br><span class="line">innodb_thread_concurrency = <span class="number">16</span></span><br><span class="line">innodb_flush_<span class="built_in">log</span>_at_trx_commit = <span class="number">2</span></span><br><span class="line">character_<span class="built_in">set</span>_server=utf8</span><br><span class="line">init_connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tokudb</span></span><br><span class="line">plugin_dir =  /usr/<span class="built_in">local</span>/mysql/lib/mysql/plugin/</span><br><span class="line">plugin_load=ha_tokudb.so</span><br><span class="line"><span class="comment">#把TokuDB datadir以及logdir和MySQL的datadir分开，美观点，也可以不分开，注释掉本行以及下面2行即可</span></span><br><span class="line">tokudb_data-dir = /data/mysqldata</span><br><span class="line">tokudb_<span class="built_in">log</span>-dir = /data/mysqllog</span><br><span class="line"><span class="comment">#TokuDB的行模式，建议用 FAST 就足够了，如果磁盘空间很紧张，建议用 SMALL</span></span><br><span class="line">tokudb_row_format = tokudb_small</span><br><span class="line">tokudb_row_format = tokudb_fast</span><br><span class="line">tokudb_cache_size = <span class="number">2</span>G</span><br><span class="line"><span class="comment">#其他大部分配置其实可以不用修改的，只需要几个关键配置即可</span></span><br><span class="line">tokudb_commit_sync = <span class="number">0</span></span><br><span class="line">tokudb_directio = <span class="number">1</span></span><br><span class="line">tokudb_<span class="built_in">read</span>_block_size = <span class="number">128</span>K</span><br><span class="line">tokudb_<span class="built_in">read</span>_buf_size = <span class="number">128</span>K</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">malloc_lib = /usr/<span class="built_in">local</span>/mysql/lib/mysql/libjemalloc.so <span class="comment">#只能放在mysqld_safe中，不得报错</span></span><br></pre></td></tr></table></figure></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://static.verycloud.cn/sites/default/files/pic/image/20150607/2015060790205_41484.jpeg" alt="RamboLau" itemprop="image"/>
          <p class="site-author-name" itemprop="name">RamboLau</p>
        </div>
        <p class="site-description motion-element" itemprop="description">记录生活，分享知识，传播乐趣</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives/">
              <span class="site-state-item-count">65</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories/">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags/">
              <span class="site-state-item-count">54</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/RamboLau" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">RamboLau</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"176code"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
